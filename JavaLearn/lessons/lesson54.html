<html><head><title>Lession 54  Stateful //</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px; white-space: pre-wrap; transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lession 54  Stateful //</h1><pre># Kh√°i ni·ªám 
	Trong Spring, Stateful li√™n quan ƒë·∫øn vi·ªác l∆∞u tr·ªØ tr·∫°ng th√°i gi·ªØa c√°c request ho·∫∑c gi·ªØa c√°c session c·ªßa ng∆∞·ªùi d√πng. ƒêi·ªÅu n√†y tr√°i ng∆∞·ª£c v·ªõi Stateless, n∆°i m·ªói request ƒë·ªôc l·∫≠p v√† kh√¥ng gi·ªØ tr·∫°ng th√°i.
	
# 	Khi n√†o Stateful quan tr·ªçng trong h·ªá th·ªëng? 

	‚úî ·ª®ng d·ª•ng c·∫ßn l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi d√πng (session, shopping cart, authentication, v.v.)
	‚úî C√°c h·ªá th·ªëng giao d·ªãch t√†i ch√≠nh c·∫ßn ƒë·∫£m b·∫£o d·ªØ li·ªáu kh√¥ng m·∫•t tr·∫°ng th√°i
	‚úî ·ª®ng d·ª•ng c·∫ßn gi·ªØ tr·∫°ng th√°i tr√™n nhi·ªÅu b∆∞·ªõc (multi-step forms, wizard, v.v.)
	‚úî Khi c·∫ßn qu·∫£n l√Ω phi√™n l√†m vi·ªác (WebSocket, chat application, game servers, v.v.)


# C√°ch tri·ªÉn khai Stateful trong Spring
	Spring h·ªó tr·ª£ nhi·ªÅu c√°ch ƒë·ªÉ l∆∞u tr·ªØ tr·∫°ng th√°i, t√πy v√†o y√™u c·∫ßu c·ªßa h·ªá th·ªëng:

	## üîπ a) L∆∞u tr·ªØ tr·∫°ng th√°i trong Session (@SessionAttributes, HttpSession) 
			C√°ch n√†y gi√∫p gi·ªØ tr·∫°ng th√°i trong session c·ªßa ng∆∞·ªùi d√πng.
			S·ª≠ d·ª•ng @SessionAttributes ƒë·ªÉ l∆∞u d·ªØ li·ªáu gi·ªØa c√°c request c·ªßa m·ªôt user.


		@Controller
		@SessionAttributes("cart")
		public class CartController {
		
			@ModelAttribute("cart")
			public List<String> createCart() {
				return new ArrayList<>();
			}
		
			@PostMapping("/add")
			public String addToCart(@ModelAttribute("cart") List<String> cart, 
									@RequestParam String item) {
				cart.add(item);
				return "cartView";
			}
		}


			üí° Gi·∫£i th√≠ch:
			
			@SessionAttributes("cart") l∆∞u tr·∫°ng th√°i c·ªßa cart trong session c·ªßa user.
			Khi user th√™m s·∫£n ph·∫©m, gi·ªè h√†ng s·∫Ω gi·ªØ nguy√™n tr·∫°ng th√°i cho ƒë·∫øn khi session b·ªã h·ªßy.
			‚û° Nh∆∞·ª£c ƒëi·ªÉm: Kh√¥ng ph√π h·ª£p v·ªõi h·ªá th·ªëng c√≥ nhi·ªÅu server (horizontal scaling) v√¨ session l∆∞u tr√™n t·ª´ng server ri√™ng l·∫ª.






	## üîπ b) L∆∞u tr·∫°ng th√°i v·ªõi HttpSession (Th·ªß c√¥ng h∆°n, nh∆∞ng linh ho·∫°t h∆°n)
			@Controller
			public class SessionController {
			
				@GetMapping("/setSession")
				public String setSession(HttpSession session) {
					session.setAttribute("username", "User123");
					return "sessionView";
				}
			
				@GetMapping("/getSession")
				@ResponseBody
				public String getSession(HttpSession session) {
					return "Hello, " + session.getAttribute("username");
				}
			}

			
					üí° Gi·∫£i th√≠ch:
					
					session.setAttribute("username", "User123") l∆∞u gi√° tr·ªã trong session.
					Khi g·ªçi /getSession, n√≥ l·∫•y l·∫°i gi√° tr·ªã username.
					Ph√π h·ª£p v·ªõi c√°c h·ªá th·ªëng c·∫ßn l∆∞u d·ªØ li·ªáu t·∫°m th·ªùi cho user ƒëƒÉng nh·∫≠p.




	## üîπ c) L∆∞u tr·∫°ng th√°i b·∫±ng Stateful Bean (@Scope("session") ho·∫∑c @Scope("prototype"))
	Spring h·ªó tr·ª£ Bean c√≥ tr·∫°ng th√°i th√¥ng qua scope:
	

		Scope						M√¥ t·∫£
		singleton				Ch·ªâ c√≥ m·ªôt instance duy nh·∫•t trong to√†n b·ªô ·ª©ng d·ª•ng (Stateless).
		prototype				M·ªói request t·∫°o m·ªôt instance m·ªõi (Stateful).
		session					M·ªôt instance duy tr√¨ trong su·ªët phi√™n l√†m vi·ªác c·ªßa user (Stateful).
		request					M·ªôt instance t·ªìn t·∫°i trong m·ªôt HTTP request (Stateless).



		### V√≠ d·ª•: L∆∞u tr·∫°ng th√°i trong session b·∫±ng @SessionScope 

		@Component
		@SessionScope
		public class UserSession {
			private String username;
		
			public String getUsername() {
				return username;
			}
		
			public void setUsername(String username) {
				this.username = username;
			}
		}
		

		### Controller s·ª≠ d·ª•ng Stateful Bean
		
		@Controller
		public class UserController {
		
			private final UserSession userSession;
		
			public UserController(UserSession userSession) {
				this.userSession = userSession;
			}
		
			@GetMapping("/setUser")
			public String setUser(@RequestParam String name) {
				userSession.setUsername(name);
				return "userView";
			}
		
			@GetMapping("/getUser")
			@ResponseBody
			public String getUser() {
				return "User: " + userSession.getUsername();
			}
		}
				

			@Controller
			public class UserController {
			
				private final UserSession userSession;
			
				public UserController(UserSession userSession) {
					this.userSession = userSession;
				}
			
				@GetMapping("/setUser")
				public String setUser(@RequestParam String name) {
					userSession.setUsername(name);
					return "userView";
				}
			
				@GetMapping("/getUser")
				@ResponseBody
				public String getUser() {
					return "User: " + userSession.getUsername();
				}
			}




	##  üîπ d) L∆∞u tr·∫°ng th√°i v·ªõi Redis (H·ªó tr·ª£ Scaling t·ªët h∆°n) 
		Khi ch·∫°y h·ªá th·ªëng tr√™n nhi·ªÅu server (distributed system), s·ª≠ d·ª•ng session s·∫Ω g√¢y l·ªói v√¨ m·ªói server c√≥ session ri√™ng. ƒê·ªÉ gi·∫£i quy·∫øt, ta d√πng Redis ƒë·ªÉ l∆∞u session.
		
			
	### C·∫•u h√¨nh Redis Session trong application.properties	
		spring.session.store-type=redis
		spring.redis.host=localhost
		spring.redis.port=6379


	### Controller s·ª≠ d·ª•ng Redis Session 
		@RestController
		@RequestMapping("/session")
		public class RedisSessionController {
		
			@GetMapping("/set")
			public String setSession(HttpSession session) {
				session.setAttribute("message", "Hello from Redis");
				return "Session set!";
			}
		
			@GetMapping("/get")
			public String getSession(HttpSession session) {
				return (String) session.getAttribute("message");
			}
		}
		üí° Gi·∫£i th√≠ch:
		D·ªØ li·ªáu session ƒë∆∞·ª£c l∆∞u v√†o Redis, gi√∫p c√≥ th·ªÉ scale ngang h·ªá th·ªëng m√† v·∫´n gi·ªØ session.



# 3. So s√°nh Stateful v√† Stateless trong Spring
	


Ti√™u ch√≠							Stateful														Stateless
L∆∞u tr·∫°ng th√°i			C√≥ gi·ªØ d·ªØ li·ªáu gi·ªØa c√°c request/session.						Kh√¥ng gi·ªØ tr·∫°ng th√°i gi·ªØa c√°c request.
Hi·ªáu su·∫•t				Ch·∫≠m h∆°n do ph·∫£i qu·∫£n l√Ω session/memory.						Nhanh h∆°n v√¨ kh√¥ng l∆∞u tr·∫°ng th√°i.
Kh·∫£ nƒÉng m·ªü r·ªông		H·∫°n ch·∫ø (c·∫ßn Redis, DB ƒë·ªÉ scale t·ªët).							D·ªÖ scale ngang (microservices).
·ª®ng d·ª•ng				Web app c√≥ ƒëƒÉng nh·∫≠p, gi·ªè h√†ng, multi-step forms.				REST API, Microservices, serverless.


# 4. Khi n√†o n√™n d√πng Stateful trong Spring?

		‚úî H·ªá th·ªëng Authentication (OAuth2, Session-based Auth)
		‚úî ·ª®ng d·ª•ng c√≥ gi·ªè h√†ng (Shopping Cart, Checkout Process)
		‚úî H·ªá th·ªëng chat real-time, WebSocket
		‚úî ·ª®ng d·ª•ng c·∫ßn l∆∞u th√¥ng tin t·∫°m th·ªùi cho t·ª´ng user (multi-step forms, wizards)
		‚úî H·ªá th·ªëng ng√¢n h√†ng, giao d·ªãch t√†i ch√≠nh (c·∫ßn gi·ªØ tr·∫°ng th√°i giao d·ªãch t·∫°m th·ªùi)
		
		üöÄ T√≥m l·∫°i:
		
		Stateful ph√π h·ª£p v·ªõi c√°c h·ªá th·ªëng c·∫ßn l∆∞u tr·ªØ d·ªØ li·ªáu c·ªßa ng∆∞·ªùi d√πng trong su·ªët phi√™n l√†m vi·ªác.
		Stateless ph√π h·ª£p v·ªõi microservices, REST API, gi√∫p h·ªá th·ªëng d·ªÖ m·ªü r·ªông h∆°n.
		Redis l√† m·ªôt gi·∫£i ph√°p t·ªët n·∫øu c·∫ßn Stateful nh∆∞ng v·∫´n mu·ªën h·ªá th·ªëng c√≥ th·ªÉ scale ngang.
		üí° L·ªùi khuy√™n: Khi thi·∫øt k·∫ø h·ªá th·ªëng, ∆∞u ti√™n Stateless, ch·ªâ d√πng Stateful khi th·ª±c s·ª± c·∫ßn thi·∫øt.
	
</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';document.body.className = mode; localStorage.setItem('theme', mode);syncTheme();}function applyTheme() {let savedTheme = localStorage.getItem('theme') || 'dark-mode';document.body.className = savedTheme;syncTheme();}function syncTheme() {let preElement = document.querySelector('pre');if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {let contentHeight = document.body.scrollHeight;let windowHeight = window.innerHeight;if (contentHeight > windowHeight * 1.2) {document.getElementById('backBottom').style.display = 'block';} else {document.getElementById('backBottom').style.display = 'none';}}</script></body></html>