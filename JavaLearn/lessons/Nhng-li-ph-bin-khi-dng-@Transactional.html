<html><head><title>Những lỗi phổ biến khi dùng @Transactional</title></head><body><h1>Những lỗi phổ biến khi dùng @Transactional</h1><pre>
	## ❌ 2.1. Gọi @Transactional từ chính class của nó 
		Spring dùng proxy để quản lý @Transactional. Nếu bạn gọi method từ cùng một class, transaction sẽ không hoạt động 
		
			### ⚠ Sai cách

				@Service
				public class UserService {
					@Transactional
					public void createUser(User user) {
						userRepository.save(user);
					}
				
					public void registerUser(User user) {
						createUser(user); // ❌ Gọi từ chính class -> Transaction không hoạt động!
					}
				}



			### ✅ Đúng cách
				- Gọi từ class khác hoặc dùng @Autowired chính class của nó 
				
						@Service
						public class UserService {
							@Autowired
							private UserService self; // Inject chính nó
						
							@Transactional
							public void createUser(User user) {
								userRepository.save(user);
							}
						
							public void registerUser(User user) {
								self.createUser(user); // ✅ Transaction hoạt động
							}
						}



			### 💡 Cách tốt hơn: Tách thành một service khác. 
			
			
						@Service
						public class UserTransactionService {
							@Transactional
							public void createUser(User user) {
								userRepository.save(user);
							}
						}
						
						
						
						@Service
						public class UserService {
							@Autowired
							private UserTransactionService userTransactionService;
						
							public void registerUser(User user) {
								userTransactionService.createUser(user); // ✅ Transaction hoạt động
							}
						}





	## ❌ 2.2. Không đặt @Transactional ở mức public 
		Spring chỉ áp dụng transactional trên các method public. Nếu dùng private hoặc protected, transaction không có hiệu lực 
			
			
			### ⚠ Sai cách 
			
			
					@Service
					public class UserService {
						@Transactional
						private void createUser(User user) { // ❌ Không hoạt động vì không phải public
							userRepository.save(user);
						}
					}

			### ✅ Cách đúng 
			
					@Service
					public class UserService {
						@Transactional
						public void createUser(User user) { // ✅ Bắt buộc phải là public
							userRepository.save(user);
						}
					}

				


	## ❌ 2.3. Chỉ RuntimeException mới kích hoạt rollback 
	
		Mặc định, @Transactional chỉ rollback khi gặp RuntimeException hoặc Error. Nếu method ném Checked Exception , nó sẽ không rollback 
		
		
			### ⚠ Sai cách
				

					@Service
					public class UserService {
						@Transactional
						public void createUser(User user) throws Exception { 
							userRepository.save(user);
							throw new Exception("Checked Exception xảy ra"); // ❌ Không rollback!
						}
					}

			### ✅ Cách đúng 
				Cấu hình @Transactional(rollbackFor = Exception.class):
				
					@Service
					public class UserService {
						@Transactional(rollbackFor = Exception.class)
						public void createUser(User user) throws Exception {
							userRepository.save(user);
							throw new Exception("Checked Exception xảy ra"); // ✅ Rollback hoạt động
						}
					}
					


	## ❌ 2.4. Không đặt @Transactional đúng chỗ
		
		### ⚠ Sai: Đặt trên Controller 
			
				@RestController
				@RequestMapping("/users")
				public class UserController {
					@Transactional // ❌ Sai! Không nên đặt ở Controller
					@PostMapping
					public void createUser(@RequestBody User user) {
						userService.createUser(user);
					}
				}

		
		### ✅ Đúng: Đặt trên Service
		
				@Service
				public class UserService {
					@Transactional // ✅ Đặt ở Service
					public void createUser(User user) {
						userRepository.save(user);
					}
				}



</pre></body></html>