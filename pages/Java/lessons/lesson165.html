<html><head><title>Lesson 165 == java.util.concurrent.lock ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 165 -- java.util.concurrent.lock -//</h1><pre>
# 1. V√¨ sao c·∫ßn Lock API khi ƒë√£ c√≥ synchronized?
	synchronized ƒë∆°n gi·∫£n, g·∫Øn ch·∫∑t v·ªõi JVM, release lock t·ª± ƒë·ªông.
	Nh∆∞ng n√≥ b·ªã gi·ªõi h·∫°n:

		- Kh√¥ng c√≥ tryLock() v·ªõi timeout (kh√¥ng th·ª≠ tr∆∞·ªõc ƒë∆∞·ª£c).
		- Kh√¥ng c√≥ fairness (c√¥ng b·∫±ng khi tranh ch·∫•p).
		- Kh√¥ng c√≥ nhi·ªÅu condition variable tr√™n c√πng m·ªôt lock (ch·ªâ c√≥ wait/notify to√†n c·ª•c).
		- Kh√¥ng th·ªÉ unlock t·ª´ thread kh√°c.
	Lock API (t·ª´ Java 5, package java.util.concurrent.locks) ‚Üí linh ho·∫°t h∆°n, cho ph√©p nhi·ªÅu pattern n√¢ng cao.
	
	
	
# 2. ReentrantLock	
	Gi·ªëng synchronized v·ªÅ c∆° b·∫£n: mutual exclusion + reentrancy.
	Nh∆∞ng c√≥ th√™m power:
	
		- tryLock() ‚Üí kh√¥ng block, tr·∫£ v·ªÅ ngay true/false.
		- tryLock(timeout, unit) ‚Üí th·ª≠ lock trong kho·∫£ng th·ªùi gian, tr√°nh deadlock.
		- lockInterruptibly() ‚Üí cho ph√©p thread b·ªã interrupt khi ƒëang ch·ªù.
		- Condition ‚Üí t·∫°o nhi·ªÅu ‚Äúh√†ng ch·ªù‚Äù ri√™ng bi·ªát thay v√¨ wait/notifyAll.


ReentrantLock lock = new ReentrantLock(true); // fairness = true
try {
    if (lock.tryLock(1, TimeUnit.SECONDS)) {
        // critical section
    } else {
        // timeout
    }
} finally {
    if (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}

	Fairness:
		- new ReentrantLock(true) ‚Üí thread n√†o ch·ªù l√¢u h∆°n ƒë∆∞·ª£c ∆∞u ti√™n (fair lock).
		- Default = unfair lock ‚Üí nhanh h∆°n, nh∆∞ng c√≥ th·ªÉ starve thread y·∫øu th·∫ø.


# 3. ReadWriteLock 
	√ù t∆∞·ªüng: ƒëa s·ªë ƒë·ªçc, √≠t ghi ‚Üí n·∫øu ch·ªâ lock to√†n b·ªô b·∫±ng mutex s·∫Ω ph√≠. 
	ReadWriteLock c√≥ 2 lo·∫°i lock: 
		- readLock ‚Üí nhi·ªÅu thread c√≥ th·ªÉ v√†o song song (n·∫øu kh√¥ng c√≥ writer).
		- writeLock ‚Üí ƒë·ªôc quy·ªÅn, ch·∫∑n c·∫£ reader.

	Tri·ªÉn khai ph·ªï bi·∫øn: ReentrantReadWriteLock.
	D√πng cho cache, c·∫•u tr√∫c d·ªØ li·ªáu nhi·ªÅu ƒë·ªçc √≠t ghi.

ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock();
Lock rLock = rwLock.readLock();
Lock wLock = rwLock.writeLock();

rLock.lock();
try {
    // nhi·ªÅu thread ƒë·ªçc song song
} finally {
    rLock.unlock();
}

wLock.lock();
try {
    // ch·ªâ m·ªôt thread ghi
} finally {
    wLock.unlock();
}




# 4. StampedLock (Java 8+)
	Ti·∫øn h√≥a c·ªßa ReadWriteLock, gi·∫£i quy·∫øt nh∆∞·ª£c ƒëi·ªÉm writer starvation.
	Kh√¥ng d√πng boolean lock/unlock ‚Üí d√πng stamp (long id) ƒë·ªÉ qu·∫£n l√Ω.
	H·ªó tr·ª£ 3 mode:
	
		- Write Lock: ƒë·ªôc quy·ªÅn nh∆∞ writeLock.
		- Read Lock: cho nhi·ªÅu thread ƒë·ªçc song song.
		- Optimistic Read: ƒë·ªçc m√† kh√¥ng th·ª±c s·ª± lock (lock-free read).
		- N·∫øu trong l√∫c ƒë·ªçc c√≥ writer chen v√†o ‚Üí validate th·∫•t b·∫°i ‚Üí fallback sang read lock.	
	
	∆Øu ƒëi·ªÉm: c·ª±c k·ª≥ nhanh cho workload read-heavy.
	Nh∆∞·ª£c ƒëi·ªÉm: API ph·ª©c t·∫°p, d·ªÖ code sai (nh·∫•t l√† qu√™n unlock b·∫±ng ƒë√∫ng stamp).	
	
StampedLock lock = new StampedLock();
long stamp = lock.tryOptimisticRead();
int value = data; 
if (!lock.validate(stamp)) { // check c√≥ writer chen v√†o ko
    stamp = lock.readLock();
    try {
        value = data;
    } finally {
        lock.unlockRead(stamp);
    }
}
	
	
	
# 5. Deadlock Prevention v·ªõi Lock API	
	V·ªõi synchronized ‚Üí kh√≥ tr√°nh deadlock n·∫øu lock nhi·ªÅu object.
	V·ªõi Lock:
		
		- D√πng tryLock() c√≥ timeout ‚Üí tr√°nh ch·ªù v√¥ h·∫°n.
		- C√≥ th·ªÉ implement deadlock avoidance b·∫±ng c√°ch lock theo th·ª© t·ª± c·ªë ƒë·ªãnh ho·∫∑c b·ªè qua n·∫øu kh√¥ng acquire ƒë∆∞·ª£c.	
	
	
	## V√≠ d·ª• pattern tr√°nh deadlock: 
		
if (lock1.tryLock()) {
    try {
        if (lock2.tryLock()) {
            try {
                // critical
            } finally {
                lock2.unlock();
            }
        }
    } finally {
        lock1.unlock();
    }
}
	
# 	6. So s√°nh t·ªïng qu√°t


| T√≠nh nƒÉng       | synchronized    | ReentrantLock      | ReadWriteLock                | StampedLock         |
| --------------- | --------------- | ------------------ | ---------------------------- | ------------------- |
| Reentrant       | ‚úî               | ‚úî                  | ‚úî (read/write ƒë·ªÅu reentrant) | ‚úñ (kh√¥ng reentrant) |
| Fairness        | ‚úñ               | ‚úî                  | ‚úî                            | ‚úñ                   |
| tryLock/timeout | ‚úñ               | ‚úî                  | ‚úî                            | ‚úî                   |
| Condition       | 1 (wait/notify) | Nhi·ªÅu Condition    | Nhi·ªÅu Condition              | ‚úñ                   |
| Optimistic Read | ‚úñ               | ‚úñ                  | ‚úñ                            | ‚úî                   |
| T·ª± ƒë·ªông release | ‚úî               | ‚úñ                  | ‚úñ                            | ‚úñ                   |
| Deadlock tr√°nh  | Kh√≥             | D·ªÖ h∆°n (`tryLock`) | D·ªÖ h∆°n                       | D·ªÖ h∆°n              |


# 7. T∆∞ duy Senior

	- ReentrantLock ‚Üí d√πng khi c·∫ßn nhi·ªÅu condition variable, timeout, interruptible lock.
	- ReadWriteLock ‚Üí d√πng cho cache/data structure nhi·ªÅu ƒë·ªçc √≠t ghi.
	- StampedLock ‚Üí t·ªëi ∆∞u c·ª±c m·∫°nh cho read-mostly, nh∆∞ng code ph·ª©c t·∫°p v√† d·ªÖ bug.
	- N·∫øu logic ƒë∆°n gi·∫£n ‚Üí c·ª© d√πng synchronized, JVM t·ªëi ∆∞u r·ªìi.
	- Lu√¥n nh·ªõ: Lock m·∫°nh h∆°n nh∆∞ng d·ªÖ code sai (qu√™n unlock, unlock nh·∫ßm thread, v.v.).



</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>