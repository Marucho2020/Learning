<html><head><title>Lesson 123 == VarHandle ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 123 -- VarHandle -//</h1><pre># Kh√°i ni·ªám 
	VarHandle l√† API ƒë∆∞·ª£c gi·ªõi thi·ªáu trong Java 9 (JEP 193) ƒë·ªÉ thay th·∫ø cho sun.misc.Unsafe.
	VarHandle ‚Äì m·ªôt trong nh·ªØng API th·∫•p c·∫•p, m·∫°nh m·∫Ω, v√† hi·ªán ƒë·∫°i nh·∫•t trong Java ƒë·ªÉ thao t√°c v·ªõi memory, t∆∞∆°ng t·ª± Unsafe, nh∆∞ng an to√†n h∆°n, ƒë∆∞·ª£c chu·∫©n h√≥a h∆°n, v√† d√πng trong c√°c h·ªá th·ªëng y√™u c·∫ßu hi·ªáu nƒÉng v√† ki·ªÉm so√°t memory c·ª±c cao (concurrent structure, lock-free algorithm, JVM-level tuning).
	T∆∞ t∆∞·ªüng: gi·ªëng nh∆∞ MethodHandle d√†nh cho method, th√¨ VarHandle l√† cho field/array/memory variable.


	N√≥ cho ph√©p:

		- Truy c·∫≠p field, array, ho·∫∑c ByteBuffer ki·ªÉu low-level
		- Thao t√°c atomic (CAS, getAndSet, etc)
		- ƒêi·ªÅu khi·ªÉn memory visibility (acquire, release, opaque, volatile..
		

# üß† 2. V√¨ sao c·∫ßn VarHandle? 

	Tr∆∞·ªõc Java 9:
	Mu·ªën l√†m lock-free algorithm, b·∫°n ph·∫£i d√πng Unsafe
		‚Üí Kh√¥ng chu·∫©n, d·ªÖ g√¢y crash JVM
	
	T·ª´ Java 9: 
		VarHandle ƒë∆∞·ª£c chu·∫©n h√≥a ƒë·ªÉ thay th·∫ø:
			- Atomic operations (getAndSet, compareAndSet)
			- Visibility control (volatile/acquire/release/opaque)
			- Array/memory address access

		‚û° D√πng trong c·∫•u tr√∫c nh∆∞ ConcurrentHashMap, Atomic*, ForkJoinPool,...

# üß™ 3. V√≠ d·ª• ƒë∆°n gi·∫£n

class Counter {
    volatile int value = 0;
}

VarHandle handle = MethodHandles
    .lookup()
    .in(Counter.class)
    .findVarHandle(Counter.class, "value", int.class);

Counter c = new Counter();

// Ghi atomically
handle.setVolatile(c, 10);

// ƒê·ªçc atomically
int current = (int) handle.getVolatile(c);

// CAS
boolean success = handle.compareAndSet(c, 10, 20);

// getAndAdd
int prev = (int) handle.getAndAdd(c, 5);


	‚û° Kh√¥ng c·∫ßn AtomicInteger n·ªØa ‚Äì b·∫°n ki·ªÉm so√°t tr·ª±c ti·∫øp field ƒë√≥ nh∆∞ m·ªôt atomic handle.

# üì¶ 4. C√≥ th·ªÉ d√πng VarHandle v·ªõi?

| Lo·∫°i bi·∫øn       | H·ªó tr·ª£? | Ghi ch√∫                                       |
| --------------- | ------- | --------------------------------------------- |
| Field static    | ‚úÖ       | Ph·∫£i l·∫•y qua `staticFieldVarHandle()`         |
| Field instance  | ‚úÖ       | D√πng `findVarHandle()`                        |
| Array           | ‚úÖ       | D√πng `arrayElementVarHandle()`                |
| ByteBuffer      | ‚úÖ       | D√πng `memorySegmentViewHandle()` trong Panama |
| Off-heap memory | ‚úÖ       | N·∫øu d√πng `Foreign Memory Access API`          |


# ‚öôÔ∏è 5. C√°c mode truy c·∫≠p (memory semantics)

| Method                            | Semantics            | Gi·ªëng g√¨?                         |
| --------------------------------- | -------------------- | --------------------------------- |
| `get()` / `set()`                 | Plain (no guarantee) | kh√¥ng volatile                    |
| `getOpaque()` / `setOpaque()`     | Weak order           | `lazySet()`                       |
| `getAcquire()` / `setRelease()`   | Half fence           | Java memory model acquire/release |
| `getVolatile()` / `setVolatile()` | Full fence           | volatile field                    |
| `compareAndSet()`                 | Atomic CAS           | gi·ªëng AtomicInteger               |
| `getAndAdd()` / `getAndSet()`     | Atomic + update      | gi·ªëng `Atomic*`                   |



# üîß 7. T·∫°o VarHandle c·ª• th·ªÉ 
	
	## a. Cho instance field 
		VarHandle vh = MethodHandles
		.lookup()
		.findVarHandle(MyClass.class, "myField", int.class);

	## b. Cho static field

		VarHandle vh = MethodHandles
			.lookup()
			.findStaticVarHandle(MyClass.class, "staticField", long.class);


	## c. Cho ph·∫ßn t·ª≠ m·∫£ng
		VarHandle arrayHandle = MethodHandles
			.arrayElementVarHandle(int[].class);
		
		int[] arr = new int[10];
		arrayHandle.set(arr, 2, 99);
		

# üß† 8. Use-case th·ª±c chi·∫øn 


	1. C·∫•u tr√∫c d·ªØ li·ªáu lock-free
		Stack, Queue, RingBuffer
		CAS, setOpaque ‚Üí h·∫°n ch·∫ø contention
	
	2. Off-heap memory management
		K·∫øt h·ª£p v·ªõi Panama (MemorySegment)
		Truy c·∫≠p memory nh∆∞ C/C++
	
	3. High-performance logging/metrics
		Avoid AtomicLong object allocation ‚Üí d√πng VarHandle v√†o primitive field

# üß® 9. C·∫°m b·∫´y nguy hi·ªÉm


	- Kh√¥ng ki·ªÉm so√°t memory order ‚Üí race condition (n·∫øu d√πng get() thay v√¨ getVolatile())
	- Sai type ‚Üí ClassCastException
	- D√πng sai handle tr√™n object sai class ‚Üí ClassCastException
	- Kh√¥ng reentrant (n√≥ kh√¥ng ‚Äúbi·∫øt‚Äù b·∫°n ƒëang trong critical section)

‚úÖ T·ªïng k·∫øt

| ƒê·∫∑c ƒëi·ªÉm                                            | Gi√° tr·ªã |
| --------------------------------------------------- | ------- |
| Truy c·∫≠p th·∫•p c·∫•p an to√†n                           | ‚úÖ       |
| Thay th·∫ø `Unsafe` cho field/memory                  | ‚úÖ       |
| T√πy ch·ªçn memory order gi·ªëng C++11                   | ‚úÖ       |
| D√πng cho concurrent structure hi·ªáu nƒÉng cao         | ‚úÖ       |
| API kh√≥ d√πng, d·ªÖ sai n·∫øu kh√¥ng hi·ªÉu r√µ memory model | ‚ö†Ô∏è       |
| Kh√¥ng ph√π h·ª£p cho beginner                          | ‚ùå       |


# üîö B·∫°n n√™n d√πng VarHandle khi: 

	- Vi·∫øt lock-free concurrent structure
	- Tr√°nh d√πng Atomic* class do overhead
	- L√†m vi·ªác v·ªõi off-heap / native memory
	- T·ªëi ∆∞u h√≥a h·ªá th·ªëng realtime/high-concurrency
</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>