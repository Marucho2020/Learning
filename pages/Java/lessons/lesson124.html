<html><head><title>Lesson 124 == Persitent Segment Tree ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 124 -- Persitent Segment Tree -//</h1><pre># KhÃ¡i niá»‡m 
	Persistence trong cáº¥u trÃºc dá»¯ liá»‡u lÃ  kháº£ nÄƒng giá»¯ láº¡i lá»‹ch sá»­ cÃ¡c phiÃªn báº£n trÆ°á»›c cá»§a cáº¥u trÃºc sau má»—i thay Ä‘á»•i (update), mÃ  khÃ´ng thay Ä‘á»•i phiÃªn báº£n cÅ©.
		- Full persistence: truy cáº­p & cáº­p nháº­t báº¥t ká»³ phiÃªn báº£n nÃ o.
		- Partial persistence: chá»‰ truy cáº­p phiÃªn báº£n cÅ©, cáº­p nháº­t chá»‰ phiÃªn báº£n hiá»‡n táº¡i.
		- Functional persistence: khÃ´ng cÃ³ tráº¡ng thÃ¡i thay Ä‘á»•i â€” má»—i thao tÃ¡c tráº£ vá» má»™t phiÃªn báº£n má»›i (giá»‘ng láº­p trÃ¬nh hÃ m).

	â†’ Persistent Segment Tree = giá»¯ láº¡i nhiá»u phiÃªn báº£n cá»§a segment tree, sau má»—i láº§n update mÃ  khÃ´ng phÃ¡ vá»¡ phiÃªn báº£n cÅ©.
	
	
# 	2. ğŸ”§ So sÃ¡nh Segment Tree thÆ°á»ng vs Persistent Segment Tree 
	| Äáº·c Ä‘iá»ƒm          | Segment Tree thÆ°á»ng      | Persistent Segment Tree              |
| ----------------- | ------------------------ | ------------------------------------ |
| Cáº­p nháº­t (update) | Thay Ä‘á»•i trá»±c tiáº¿p       | Táº¡o phiÃªn báº£n má»›i (dÃ¹ng láº¡i pháº§n cÅ©) |
| Truy váº¥n (query)  | Chá»‰ 1 phiÃªn báº£n hiá»‡n táº¡i | Truy váº¥n báº¥t ká»³ phiÃªn báº£n nÃ o        |
| Lá»‹ch sá»­           | KhÃ´ng giá»¯                | Giá»¯ tá»«ng phiÃªn báº£n rÃµ rÃ ng           |
| Tá»‘n bá»™ nhá»›        | O(n)                     | O(n log n) (chia sáº» nÃºt cÅ©)          |

	
	
# 	3. âš™ï¸ á»¨ng dá»¥ng thá»±c táº¿ (cáº§n biáº¿t khi thiáº¿t káº¿ há»‡ thá»‘ng)
	
| TrÆ°á»ng há»£p á»©ng dá»¥ng                                  | Giáº£i thÃ­ch                                                                                                |
| ---------------------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| ğŸ•“ Time-travel query                                 | Cáº§n biáº¿t tráº¡ng thÃ¡i dá»¯ liá»‡u á»Ÿ 1 thá»i Ä‘iá»ƒm trong quÃ¡ khá»© (log, lá»‹ch sá»­ giao dá»‹ch, dá»¯ liá»‡u thá»i gian thá»±c). |
| â± Versioned configuration / snapshot                 | Má»—i láº§n update cáº¥u hÃ¬nh/dá»¯ liá»‡u â†’ táº¡o version má»›i â†’ rollback dá»… dÃ ng.                                     |
| ğŸ•¹ Undo/Redo trong há»‡ thá»‘ng phá»©c táº¡p                 | LÆ°u lá»‹ch sá»­ thay Ä‘á»•i dáº¡ng cÃ¢y â†’ dá»… undo tá»«ng bÆ°á»›c.                                                        |
| ğŸ§® Dá»¯ liá»‡u khÃ´ng á»•n Ä‘á»‹nh (time-varying)              | NhÆ° stock price, lÆ°á»£ng truy cáº­p server, lÆ°á»£t view theo giá»...                                             |
| ğŸ” Immutable data handling (Blockchain, DSL engines) | KhÃ´ng Ä‘Æ°á»£c thay Ä‘á»•i dá»¯ liá»‡u cÅ© â†’ dÃ¹ng persistence.                                                        |
	
	
	
# 	4. ğŸ§  Cá»‘t lÃµi ká»¹ thuáº­t
	
	## â— Ã tÆ°á»Ÿng chÃ­nh: 
		- Má»—i khi update, chá»‰ táº¡o láº¡i cÃ¡c nÃºt trÃªn Ä‘Æ°á»ng Ä‘i tá»« root Ä‘áº¿n leaf bá»‹ áº£nh hÆ°á»Ÿng.
		- CÃ¡c pháº§n khÃ¡c cá»§a cÃ¢y váº«n dÃ¹ng láº¡i Ä‘Æ°á»£c.
		- NhÆ° váº­y: O(log n) bá»™ nhá»›/phiÃªn báº£n â†’ ráº¥t hiá»‡u quáº£.



	## ğŸ“Œ Code nguyÃªn lÃ½:
class Node {
    int val;
    Node left, right;

    Node(int val, Node l, Node r) {
        this.val = val;
        this.left = l;
        this.right = r;
    }
}

Node update(Node node, int l, int r, int idx, int value) {
    if (l == r) {
        return new Node(value, null, null); // táº¡o nÃºt má»›i
    }
    int mid = (l + r) / 2;
    if (idx <= mid) {
        return new Node(0,
            update(node.left, l, mid, idx, value),
            node.right
        );
    } else {
        return new Node(0,
            node.left,
            update(node.right, mid + 1, r, idx, value)
        );
    }
}
	
	
		- node lÃ  root cá»§a version hiá»‡n táº¡i.
		- Má»—i láº§n update tráº£ vá» root má»›i cá»§a version má»›i.
		- CÃ³ thá»ƒ lÆ°u danh sÃ¡ch List<Node> versions Ä‘á»ƒ giá»¯ tá»«ng root.
	
	
	
	
	## â± Truy váº¥n trÃªn version: 
int query(Node node, int l, int r, int ql, int qr) {
    if (ql > r || qr < l) return 0;
    if (ql <= l && r <= qr) return node.val;
    int mid = (l + r) / 2;
    return query(node.left, l, mid, ql, qr)
         + query(node.right, mid+1, r, ql, qr);
}
	
	
	
	
# 5. ğŸ“¦ Bá»™ nhá»› & Ä‘á»™ phá»©c táº¡p 
	
	
	- Táº¡o version má»›i: O(log n)
	- Truy váº¥n version báº¥t ká»³: O(log n)
	- Tá»•ng sá»‘ node sau k láº§n update: O(k log n)
	- Tá»‘i Æ°u hÆ¡n ArrayList snapshot hoáº·c clone object!
	
	
# 	6. ğŸ“š Kiáº¿n thá»©c cáº§n náº¯m Ä‘á»ƒ hiá»ƒu sÃ¢u Persistent Segment Tree:

| Chá»§ Ä‘á»                                     | VÃ¬ sao cáº§n há»c?                              |
| ------------------------------------------ | -------------------------------------------- |
| Tree data structure                        | Hiá»ƒu cÃ¡ch phÃ¢n chia vÃ  tá»• chá»©c dá»¯ liá»‡u       |
| Immutable data / Functional DS             | Hiá»ƒu cÃ¡ch giá»¯ dá»¯ liá»‡u khÃ´ng thay Ä‘á»•i         |
| Memory sharing / Copy-on-write             | Tá»‘i Æ°u hiá»‡u suáº¥t & khÃ´ng táº¡o báº£n sao toÃ n bá»™ |
| Dynamic Programming on trees               | Káº¿t há»£p logic xá»­ lÃ½ phÃ¢n Ä‘oáº¡n phá»©c táº¡p       |
| Advanced Java (immutability, memory model) | Äá»ƒ code Persistent DS Ä‘Ãºng cÃ¡ch              |
	
	
	
# 	7. ğŸ§ª á»¨ng dá»¥ng demo báº¡n cÃ³ thá»ƒ triá»ƒn khai:
	
		- LÆ°u lá»‹ch sá»­ giao dá»‹ch tÃ i khoáº£n theo tá»«ng phiÃªn báº£n cáº­p nháº­t.
		- Thá»‘ng kÃª tá»•ng view cá»§a cÃ¡c bÃ i viáº¿t táº¡i cÃ¡c má»‘c thá»i gian khÃ¡c nhau.
		- XÃ¢y dá»±ng há»‡ thá»‘ng undo/redo cho há»‡ thá»‘ng váº½ Ä‘á»“ há»a (má»—i láº§n thay Ä‘á»•i lÃ  1 version).
		- LÆ°u cáº¥u hÃ¬nh há»‡ thá»‘ng, cÃ³ thá»ƒ rollback láº¡i báº¥t ká»³ lÃºc nÃ o.	
	



# 8. ğŸ§± So sÃ¡nh vá»›i nhá»¯ng giáº£i phÃ¡p khÃ¡c 

| Giáº£i phÃ¡p                 | CÃ³ persistence? | CÃ³ há»— trá»£ query? | Hiá»‡u suáº¥t      |
| ------------------------- | --------------- | ---------------- | -------------- |
| Array snapshot            | CÃ³ (deep copy)  | CÃ³               | Ráº¥t cháº­m       |
| Immutable Map/List (Java) | CÃ³              | CÃ³               | TÃ¹y cáº¥u trÃºc   |
| Persistent Segment Tree   | CÃ³ (ráº¥t tá»‘t)    | CÃ³ (O(log n))    | Tá»‘i Æ°u         |
| Redis + versioned key     | CÃ³              | TÃ¹y              | Tá»‘n tÃ i nguyÃªn |



</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>