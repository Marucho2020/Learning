<html><head><title>Lesson 177 == AbstractQueuedSynchronizer (AQS). ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 177 -- AbstractQueuedSynchronizer (AQS). -//</h1><pre>
# 1. AQS l√† g√¨?


	AbstractQueuedSynchronizer (AQS) l√† m·ªôt framework c∆° s·ªü ƒë·ªÉ x√¢y d·ª±ng c√°c c√¥ng c·ª• ƒë·ªìng b·ªô h√≥a t√πy ch·ªânh (synchronizers).
	
	C√°c l·ªõp nh∆∞ ReentrantLock, Semaphore, CountDownLatch, CyclicBarrier, Phaser ƒë·ªÅu ƒë∆∞·ª£c x√¢y d·ª±ng tr√™n AQS.
	
	√ù t∆∞·ªüng c·ªët l√µi: qu·∫£n l√Ω tr·∫°ng th√°i ƒë·ªìng b·ªô (synchronization state) th√¥ng qua m·ªôt bi·∫øn nguy√™n t·ª≠ (volatile int state), v√† duy tr√¨ h√†ng ƒë·ª£i ch·ªù ƒë·ª£i (wait queue) cho c√°c thread ch∆∞a c√≥ ƒë∆∞·ª£c quy·ªÅn truy c·∫≠p.

	üëâ V√¨ v·∫≠y AQS kh√¥ng ph·∫£i l√† "c√°i lock tr·ª±c ti·∫øp", m√† l√† m·ªôt b·ªô khung ƒë·ªÉ ta x√¢y c√°c lo·∫°i lock v√† synchronizer kh√°c nhau.



# 2. C·∫•u tr√∫c b√™n trong AQS

	## state (volatile int):
		Bi·ªÉu di·ªÖn tr·∫°ng th√°i c·ªßa lock/synchronizer (v√≠ d·ª•:
			0 = unlocked, 1 = locked
			ho·∫∑c gi√° tr·ªã ƒë·∫øm c√≤n l·∫°i c·ªßa CountDownLatch).

		ƒê∆∞·ª£c thao t√°c b·∫±ng c√°c ph∆∞∆°ng th·ª©c nguy√™n t·ª≠ compareAndSetState, getState, setState.


	## FIFO queue (CLH queue):
	
		C√°c thread kh√¥ng l·∫•y ƒë∆∞·ª£c lock s·∫Ω ƒë∆∞·ª£c x·∫øp v√†o m·ªôt danh s√°ch li√™n k·∫øt k√©p ki·ªÉu CLH (Craig, Landin, and Hagersten).
		
		M·ªói n√∫t (Node) ƒë·∫°i di·ªán cho m·ªôt thread, c√≥ tr·∫°ng th√°i SIGNAL, CANCELLED, CONDITION.	

		
# 3. Hai ch·∫ø ƒë·ªô: Exclusive vs Shared

	AQS h·ªó tr·ª£ 2 lo·∫°i ƒë·ªìng b·ªô:
	
	## 1. Exclusive (ƒë·ªôc quy·ªÅn): 

		M·ªôt thread gi·ªØ lock ‚Üí c√°c thread kh√°c ch·ªù.
		
		V√≠ d·ª•: ReentrantLock.
		
		Override tryAcquire(int) v√† tryRelease(int).
		

	## Shared (chia s·∫ª): 

		Nhi·ªÅu thread c√≥ th·ªÉ c√πng v√†o (t·ªõi m·ªôt gi·ªõi h·∫°n).
		
		V√≠ d·ª•: Semaphore, CountDownLatch.
		
		Override tryAcquireShared(int) v√† tryReleaseShared(int).


# 4. C√°c b∆∞·ªõc ho·∫°t ƒë·ªông c·ªßa AQS (flow c∆° b·∫£n)


	1. Thread g·ªçi acquire(). 
	
		N·∫øu tryAcquire() th√†nh c√¥ng ‚Üí l·∫•y lock ngay.
		N·∫øu th·∫•t b·∫°i ‚Üí Thread b·ªã x·∫øp v√†o queue (enq), block (park()).

	2. Khi lock ƒë∆∞·ª£c release(), AQS g·ªçi unparkSuccessor() ƒë·ªÉ ƒë√°nh th·ª©c thread k·∫ø ti·∫øp trong queue. 

	3. V·ªõi shared mode, c√≥ th·ªÉ ƒë√°nh th·ª©c nhi·ªÅu thread c√πng l√∫c.


# 5. C√°c template method quan tr·ªçng (senior c·∫ßn n·∫Øm)

	## Exclusive:

		tryAcquire(int arg)
		
		tryRelease(int arg)
		
	## Shared: 
		tryAcquireShared(int arg) (tr·∫£ v·ªÅ s·ªë d∆∞ ho·∫∑c √¢m n·∫øu th·∫•t b·∫°i)
		
		tryReleaseShared(int arg)


	## C√¥ng c·ª• queue: 

		acquire(), acquireInterruptibly(), tryAcquireNanos()
		
		release(), acquireShared(), releaseShared().

üëâ L·∫≠p tr√¨nh vi√™n ch·ªâ c·∫ßn override tryAcquire* / tryRelease*, c√≤n AQS lo h·∫øt ph·∫ßn queue, blocking, wakeup.



# 6. V√≠ d·ª•: X√¢y d·ª±ng Mutex b·∫±ng AQS

class SimpleMutex {
    private static class Sync extends AbstractQueuedSynchronizer {
        @Override
        protected boolean tryAcquire(int arg) {
            // ch·ªâ m·ªôt thread ƒë∆∞·ª£c gi·ªØ lock (state = 0 ‚Üí 1)
            return compareAndSetState(0, 1);
        }

        @Override
        protected boolean tryRelease(int arg) {
            setState(0);
            return true;
        }

        @Override
        protected boolean isHeldExclusively() {
            return getState() == 1;
        }
    }

    private final Sync sync = new Sync();

    public void lock() {
        sync.acquire(1);
    }

    public void unlock() {
        sync.release(1);
    }
}

üëâ ƒê√¢y l√† mutex ƒë∆°n gi·∫£n kh√¥ng reentrant, nh∆∞ng n√≥ cho th·∫•y AQS gi√∫p ta t·∫°o synchronizer d·ªÖ d√†ng.	


# 7. Performance v√† Best Practices

	## ∆Øu ƒëi·ªÉm:
		Code reusability: thay v√¨ vi·∫øt l·∫°i to√†n b·ªô h√†ng ƒë·ª£i, park/unpark, ta ch·ªâ c·∫ßn implement tryAcquire/tryRelease.
		
		Hi·ªáu nƒÉng: d·ª±a tr√™n park/unpark (LockSupport), kh√¥ng d√πng busy-wait.
		
		C√¥ng b·∫±ng: h·ªó tr·ª£ c·∫£ fair v√† non-fair.
	
	
	## Nh∆∞·ª£c ƒëi·ªÉm:
	
		Kh√≥ debug, code ph·ª©c t·∫°p.
		
		N·∫øu override sai (v√≠ d·ª• kh√¥ng release state ƒë√∫ng) ‚Üí thread deadlock.
		
		Kh√¥ng ph·∫£i c√¥ng c·ª• th√≠ch h·ª£p cho newbie, v√¨ n√≥ l√† low-level primitive.	
	
	
# 	8. Senior Insights
	
	Khi design synchronizer custom (v√≠ d·ª•: m·ªôt barrier ƒë·∫∑c bi·ªát, throttler, hay m·ªôt lock ∆∞u ti√™n theo rule ri√™ng), AQS l√† l·ª±a ch·ªçn duy nh·∫•t n·∫øu b·∫°n mu·ªën hi·ªáu nƒÉng v√† t√≠ch h·ª£p chu·∫©n v·ªõi Java.	
	
	Thread contention: AQS c√≥ spinning nh·ªè tr∆∞·ªõc khi park ƒë·ªÉ gi·∫£m chi ph√≠ context switch (gi√∫p throughput cao h∆°n khi lock contention th·∫•p).
	
	Fairness trade-off: AQS cho ph√©p fair mode (FIFO ch√≠nh x√°c), nh∆∞ng th·ª±c t·∫ø fair mode c√≥ th·ªÉ g√¢y throughput drop, n√™n h·∫ßu h·∫øt lib ch·ªçn non-fair (tr·ª´ khi business logic c·∫ßn fairness).
	
	
‚úÖ T√≥m l·∫°i: AbstractQueuedSynchronizer (AQS) l√† c·ªët l√µi c·ªßa to√†n b·ªô java.util.concurrent.locks. N·∫øu b·∫°n l√† senior, ph·∫£i hi·ªÉu state + queue + exclusive/shared acquisition. N·∫Øm ƒë∆∞·ª£c AQS, b·∫°n s·∫Ω hi·ªÉu to√†n b·ªô c√°c synchronizer kh√°c v√† th·∫≠m ch√≠ t·ª± vi·∫øt m·ªôt c√¥ng c·ª• ƒë·ªìng b·ªô theo y√™u c·∫ßu h·ªá th·ªëng c·ªßa m√¨nh.	
	
	

</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>