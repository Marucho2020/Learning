<html><head><title>Lesson 203 == Functional State & Event Sourcing ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 203 -- Functional State & Event Sourcing -//</h1><pre>
# üß† 1. T∆∞ duy Functional v·ªÅ State

	Trong l·∫≠p tr√¨nh h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng (OOP), state th∆∞·ªùng l√† thu·ªôc t√≠nh c·ªßa object, v√≠ d·ª•:

class Account {
    BigDecimal balance;

    void deposit(BigDecimal amount) {
        this.balance = this.balance.add(amount);
    }
}

	‚Üí ·ªû ƒë√¢y, state b·ªã thay ƒë·ªïi tr·ª±c ti·∫øp (mutable).
	ƒêi·ªÅu n√†y d·ªÖ hi·ªÉu, nh∆∞ng c≈©ng d·ªÖ g√¢y bug, race condition, rollback kh√≥, audit kh√≥.

	Functional approach kh√¥ng cho ph√©p mutate state, m√† t·∫°o state m·ªõi d·ª±a tr√™n event.

	V√≠ d·ª• functional:

		record Account(BigDecimal balance) {}
		
		record Deposit(BigDecimal amount) {}
		
		Function<Account, Function<Deposit, Account>> applyDeposit =
				acc -> dep -> new Account(acc.balance().add(dep.amount()));
		
		
		‚Üí M·ªói event (Deposit) t·∫°o ra m·ªôt b·∫£n state m·ªõi, kh√¥ng ƒë·ª•ng ƒë·∫øn state c≈©.



# ‚öôÔ∏è 2. Event Sourcing ‚Äî Functionalized State Management

	## 2.1 Nguy√™n t·∫Øc c·ªët l√µi:
		‚ÄúState hi·ªán t·∫°i ch·ªâ l√† k·∫øt qu·∫£ c·ªßa t·∫•t c·∫£ event ƒë√£ x·∫£y ra tr∆∞·ªõc ƒë√≥.‚Äù

	T·ª©c l√† thay v√¨ l∆∞u state cu·ªëi c√πng, ta l∆∞u danh s√°ch event b·∫•t bi·∫øn:
		AccountCreated(100)
		Deposit(50)
		Withdraw(20)

	T·ª´ ƒë√≥, ta c√≥ th·ªÉ t√°i t·∫°o state b·∫±ng pure function:

Account initial = new Account(BigDecimal.ZERO);
List<Event> events = List.of(new Deposit(100), new Withdraw(40));

Account finalState = events.stream()
    .reduce(initial, (state, event) -> applyEvent(state, event), (a, b) -> b);


	## M·ªói applyEvent l√† pure function:

Account applyEvent(Account state, Event event) {
    if (event instanceof Deposit d) return new Account(state.balance().add(d.amount()));
    if (event instanceof Withdraw w) return new Account(state.balance().subtract(w.amount()));
    return state;
}

	‚Üí K·∫øt qu·∫£ gi·ªëng h·ªát database snapshot, nh∆∞ng kh√¥ng c·∫ßn mutate b·∫•t c·ª© th·ª© g√¨.


# üè¢ 3. Enterprise Application ‚Äî CQRS & Ledger

	Trong enterprise, m√¥ h√¨nh n√†y l√† n·ªÅn t·∫£ng c·ªßa c√°c h·ªá th·ªëng t√†i ch√≠nh, audit, blockchain, v√† reactive domain.


	## üîπ CQRS (Command Query Responsibility Segregation)
		‚ÄúCommand‚Äù (ghi) x·ª≠ l√Ω event v√† l∆∞u v√†o event store (append-only).
		
		‚ÄúQuery‚Äù (ƒë·ªçc) t·∫°o view model (snapshot) t·ª´ event history.

	## Functional style r·∫•t h·ª£p v·ªõi CQRS v√¨:
		
			M·ªói command ‚Üí m·ªôt pure function state + command ‚Üí event.
			M·ªói event ‚Üí m·ªôt pure function state + event ‚Üí newState.


	## V√≠ d·ª• domain banking:

Event handleCommand(AccountState state, Command cmd) {
    if (cmd instanceof DepositCommand dc)
        return new DepositedEvent(dc.amount());
    if (cmd instanceof WithdrawCommand wc && state.balance().compareTo(wc.amount()) >= 0)
        return new WithdrawnEvent(wc.amount());
    throw new IllegalStateException("Insufficient funds");
}


	‚Üí Pure, deterministic, d·ªÖ test v√† d·ªÖ song song h√≥a.



# üß© 4. ∆Øu ƒëi·ªÉm c·ªßa Functional State


| V·∫•n ƒë·ªÅ                | OOP Layered Approach   | Functional Event Sourcing      |
| --------------------- | ---------------------- | ------------------------------ |
| **Concurrency**       | Kh√≥, v√¨ mutate state   | D·ªÖ, v√¨ append-only             |
| **Auditability**      | C·∫ßn log th·ªß c√¥ng       | Log c√≥ s·∫µn qua events          |
| **Rollback / Replay** | Ph·ª©c t·∫°p               | Ch·ªâ c·∫ßn b·ªè event ho·∫∑c replay   |
| **Testing**           | Mock DB, kh√≥ unit test | Pure function ‚Üí d·ªÖ test        |
| **Performance**       | Ph·ª• thu·ªôc DB state     | C√≥ th·ªÉ stream events song song |




# üß† 5. ·ª®ng d·ª•ng trong c√°c ng√¥n ng·ªØ kh√°c

| Ng√¥n ng·ªØ          | C√°ch tri·ªÉn khai Functional State                      |
| ----------------- | ----------------------------------------------------- |
| **Scala / Akka**  | `PersistentActor` + `EventSourcedBehavior`            |
| **Haskell**       | Monad State, Event sourcing b·∫±ng pure folds           |
| **Clojure**       | Atom + transaction log b·∫•t bi·∫øn                       |
| **Java (Spring)** | `EventStore` + `FunctionalReducer` (ho·∫∑c Vavr Either) |
| **Elixir**        | Process state ƒë∆∞·ª£c ph·ª•c h·ªìi t·ª´ event log              |



# üè¶ 6. Trong Java Security & Compliance
	Functional state l√† n·ªÅn t·∫£ng cho:
		Audit Trail (ghi l·∫°i m·ªçi h√†nh ƒë·ªông user ‚Üí pure event log)
		Access Log Immutability (d·ªÖ x√°c minh kh√¥ng b·ªã ch·ªânh s·ª≠a)
		Data Provenance (ngu·ªìn g·ªëc d·ªØ li·ªáu minh b·∫°ch)
		Reproducible Security Simulation (c√≥ th·ªÉ replay to√†n b·ªô event ƒë·ªÉ ki·ªÉm ch·ª©ng policy)


# ‚úÖ T√≥m t·∫Øt

| Concept                      | √ù nghƒ©a                                   |
| ---------------------------- | ----------------------------------------- |
| **State = Function(events)** | Kh√¥ng l∆∞u bi·∫øn, m√† t√≠nh to√°n t·ª´ event     |
| **Pure Transition Function** | `(state, event) ‚Üí newState`               |
| **Append-only Log**          | Kh√¥ng x√≥a, ch·ªâ th√™m ‚Üí reliability cao     |
| **Replayability**            | C√≥ th·ªÉ rebuild b·∫•t k·ª≥ state trong qu√° kh·ª© |
| **Functional**               | D·ªÖ test, d·ªÖ scale, d·ªÖ parallel            |








</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>