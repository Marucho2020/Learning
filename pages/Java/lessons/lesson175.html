<html><head><title>Lesson 175 == Phaser ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 175 -- Phaser -//</h1><pre>
# 1. KhÃ¡i niá»‡m

	Phaser = má»™t barrier Ä‘a pha (multi-phase barrier).
	
	KhÃ¡c vá»›i CyclicBarrier: sá»‘ thread (parties) cÃ³ thá»ƒ thay Ä‘á»•i Ä‘á»™ng (register/deregister).
	
	Há»— trá»£ nhiá»u phase liÃªn tiáº¿p, má»—i phase káº¿t thÃºc khi táº¥t cáº£ registered parties gá»i arrive().
	
	ğŸ‘‰ CÃ³ thá»ƒ tÆ°á»Ÿng tÆ°á»£ng Phaser = CyclicBarrier 2.0 + CountDownLatch 2.0.

Phaser phaser = new Phaser(int parties); // khá»Ÿi táº¡o vá»›i sá»‘ parties ban Ä‘áº§u

phaser.register();     // thÃªm má»™t party (dynamic)
phaser.bulkRegister(n); // thÃªm nhiá»u party
phaser.arrive();       // bÃ¡o Ä‘Ã£ xong phase, KHÃ”NG chá»
phaser.arriveAndAwaitAdvance(); // bÃ¡o xong phase + chá» cÃ¡c party khÃ¡c
phaser.arriveAndDeregister();   // bÃ¡o xong vÃ  rÃºt khá»i phaser
phaser.getPhase();     // phase hiá»‡n táº¡i




# 3. VÃ­ dá»¥ cÆ¡ báº£n

Phaser phaser = new Phaser(3); // 3 parties

for (int i = 0; i < 3; i++) {
    final int id = i;
    new Thread(() -> {
        for (int phase = 0; phase < 3; phase++) {
            System.out.println("Thread " + id + " working in phase " + phase);
            try { Thread.sleep((long)(Math.random() * 1000)); } catch (InterruptedException e) {}
            phaser.arriveAndAwaitAdvance(); // Ä‘á»“ng bá»™
        }
    }).start();
}


	Táº¥t cáº£ threads hoÃ n thÃ nh phase 0 â†’ advance phase 1.
	Táº¥t cáº£ hoÃ n thÃ nh phase 1 â†’ advance phase 2.
	Cá»© tháº¿, multi-phase synchronization.
	Táº¥t cáº£ threads hoÃ n thÃ nh phase 0 â†’ advance phase 1.
	Táº¥t cáº£ hoÃ n thÃ nh phase 1 â†’ advance phase 2.
	Cá»© tháº¿, multi-phase synchronization.


# 4. So vá»›i CountDownLatch / CyclicBarrier

| Feature         | CountDownLatch | CyclicBarrier       | Phaser                  |
| --------------- | -------------- | ------------------- | ----------------------- |
| Use once        | âœ”              | âŒ                   | âŒ                       |
| Reusable        | âŒ              | âœ”                   | âœ” (multi-phase)         |
| Parties fixed   | âœ”              | âœ”                   | âŒ (register/deregister) |
| Barrier action  | âŒ              | âœ”                   | âœ” (via `onAdvance()`)   |
| Multi-phase     | âŒ              | âœ” (reuse per cycle) | âœ” (phase counter)       |
| Dynamic parties | âŒ              | âŒ                   | âœ”                       |

	ğŸ‘‰ Náº¿u sá»‘ thread thay Ä‘á»•i, hoáº·c cÃ³ nhiá»u phase phá»©c táº¡p â†’ Phaser lÃ  lá»±a chá»n duy nháº¥t.


# 5. Hook nÃ¢ng cao â€“ onAdvance

	Báº¡n cÃ³ thá»ƒ override:	

Phaser phaser = new Phaser(3) {
    @Override
    protected boolean onAdvance(int phase, int registeredParties) {
        System.out.println("Phase " + phase + " completed, parties: " + registeredParties);
        return registeredParties == 0; // return true â†’ terminate
    }
};

	onAdvance Ä‘Æ°á»£c gá»i khi táº¥t cáº£ parties hoÃ n thÃ nh 1 phase.
	Náº¿u tráº£ vá» true â†’ Phaser terminate (khÃ´ng dÃ¹ng Ä‘Æ°á»£c ná»¯a).
	ÄÃ¢y lÃ  cÃ¡ch Ä‘á»‹nh nghÄ©a termination condition.


# 6. Use cases senior-level

	- Iterative algorithms vá»›i dynamic thread pool
		VÃ­ dá»¥: simulation mÃ  sá»‘ agent thay Ä‘á»•i (má»™t sá»‘ join/leave).

	- Staged pipelines 
		Data processing nhiá»u stage, má»—i stage = 1 phase.

	- Testing / benchmark 
		Start Ä‘á»“ng thá»i nhiá»u thread, rá»“i repeat nhiá»u vÃ²ng test.

	- Replace CyclicBarrier in real systems 
		Khi thread pool reuse thread, hoáº·c sá»‘ lÆ°á»£ng worker khÃ´ng cá»‘ Ä‘á»‹nh.



# 7. Pitfalls & Best practices

	- Thread bá»‹ treo vÃ¬ khÃ´ng deregister 
		Náº¿u thread káº¿t thÃºc mÃ  khÃ´ng gá»i arriveAndDeregister() â†’ Phaser váº«n chá» â†’ deadlock.

	- onAdvance blocking 
		CÅ©ng nhÆ° CyclicBarrier, khÃ´ng Ä‘Æ°á»£c block náº·ng trong onAdvance.

	- Phaser termination 
		Khi terminated â†’ táº¥t cáº£ await tráº£ vá» ngay, cáº§n kiá»ƒm tra isTerminated().

	- Memory visibility
		Giá»‘ng barrier khÃ¡c, khi phase advance â†’ Ä‘áº£m báº£o happens-before giá»¯a cÃ¡c phase.


# 8. Senior insight: hiá»‡u nÄƒng

	Phaser implement báº±ng CAS + spinning trÆ°á»›c khi park â†’ performance tá»‘t khi sá»‘ phase ngáº¯n.
	NhÆ°ng overhead lá»›n hÆ¡n CountDownLatch hoáº·c CyclicBarrier náº¿u chá»‰ cáº§n 1 láº§n sync.
	Rule of thumb:
		- One-shot event â†’ CountDownLatch.
		- Fixed parties, nhiá»u vÃ²ng â†’ CyclicBarrier.
		- Dynamic parties, nhiá»u vÃ²ng â†’ Phaser.


# 9. VÃ­ dá»¥ nÃ¢ng cao â€“ Worker pool


Phaser phaser = new Phaser(1); // register main

for (int i = 0; i < 5; i++) {
    phaser.register();
    new Thread(() -> {
        while (!phaser.isTerminated()) {
            try {
                // work...
                Thread.sleep(500);
            } catch (InterruptedException e) {}
            phaser.arriveAndAwaitAdvance();
        }
    }).start();
}

// main thread waits 3 phases
for (int i = 0; i < 3; i++) {
    phaser.arriveAndAwaitAdvance();
}
phaser.forceTermination();

Main + workers cháº¡y Ä‘á»“ng bá»™ 3 vÃ²ng, rá»“i main terminate phaser.


# 10. Mindset senior

	Phaser khÃ´ng chá»‰ lÃ  barrier, mÃ  lÃ  framework cho Ä‘á»“ng bá»™ nhiá»u vÃ²ng vá»›i dynamic membership.
	
	NÃ³ Ã­t Ä‘Æ°á»£c dÃ¹ng vÃ¬ khÃ³ hiá»ƒu, nhÆ°ng trong distributed simulation, game engine, hoáº·c workflow pipeline â†’ ráº¥t máº¡nh.
	
	Khi tháº¥y CountDownLatch + reset + dynamic thread hack code â†’ hÃ£y thay báº±ng Phaser.


	CountDownLatch = fire-once gate.
	CyclicBarrier = fixed-party rendezvous, multi-use.
	Phaser = multi-phase, dynamic-party rendezvous, máº¡nh nháº¥t nhÆ°ng cÅ©ng phá»©c táº¡p nháº¥t.
</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>