<html><head><title>Lesson 164 == volatile ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 164 -- volatile -//</h1><pre>
# 1. volatile lÃ  gÃ¬ vá» máº·t JMM

	## Theo Java Memory Model, má»—i thread cÃ³ thá»ƒ cache giÃ¡ trá»‹ biáº¿n trong CPU register hoáº·c thread-local cache, khÃ´ng pháº£i lÃºc nÃ o cÅ©ng Ä‘á»c/ghi tá»« main memory (RAM).

	## volatile Ä‘áº£m báº£o:
		- Visibility: Má»i thread luÃ´n tháº¥y giÃ¡ trá»‹ má»›i nháº¥t tá»« main memory.
		- Happens-before: Má»i ghi (write) vÃ o biáº¿n volatile sáº½ xáº£y ra trÆ°á»›c má»i Ä‘á»c (read) biáº¿n Ä‘Ã³ á»Ÿ thread khÃ¡c.

	## KhÃ´ng Ä‘áº£m báº£o atomicity cho phÃ©p toÃ¡n phá»©c táº¡p (trá»« Ä‘á»c/ghi Ä‘Æ¡n giáº£n). 

volatile boolean running = true;

public void stop() {
    running = false; // write: flush ngay vÃ o main memory
}

public void run() {
    while (running) { // read: luÃ´n Ä‘á»c tá»« main memory
        ...
    }
}


# 2. CÃ¡ch JVM triá»ƒn khai volatile
	Khi compile sang bytecode â†’ volatile sinh ra cÃ¡c memory barrier:

	## Store Barrier (trÆ°á»›c khi ghi):
		Äáº£m báº£o táº¥t cáº£ cÃ¡c write trÆ°á»›c Ä‘Ã³ Ä‘Æ°á»£c commit vÃ o main memory.

	## Load Barrier (sau khi Ä‘á»c): 
		Äáº£m báº£o khÃ´ng cache giÃ¡ trá»‹ cÅ©, luÃ´n Ä‘á»c má»›i tá»« main memory.
	
	## TrÃªn CPU: 
		- Vá»›i x86, thÆ°á»ng mapping sang LOCK prefix trong instruction hoáº·c mfence.
		- Vá»›i ARM, mapping sang dmb (Data Memory Barrier).	



# 3. JIT vÃ  tá»‘i Æ°u hÃ³a

	- JIT (HotSpot C2 compiler) bÃ¬nh thÆ°á»ng cÃ³ thá»ƒ reorder cÃ¡c lá»‡nh Ä‘á»c/ghi Ä‘á»ƒ tá»‘i Æ°u pipeline.
	- Khi dÃ¹ng volatile, JIT bá»‹ háº¡n cháº¿ reorder quanh vÃ¹ng cÃ³ volatile â†’ giáº£m má»™t sá»‘ tá»‘i Æ°u.
	- Lock Elision vÃ  hoisting (Ä‘Æ°a lá»‡nh ra ngoÃ i loop) bá»‹ vÃ´ hiá»‡u náº¿u biáº¿n volatile náº±m trong loop.

VÃ­ dá»¥ JIT optimization bá»‹ cháº·n:

while (!flag) {  // flag volatile â†’ khÃ´ng hoist ra ngoÃ i
    doSomething();
}



# 4. Khi nÃ o nÃªn dÃ¹ng

	DÃ¹ng Ä‘á»ƒ truyá»n tÃ­n hiá»‡u tráº¡ng thÃ¡i giá»¯a thread mÃ  khÃ´ng cáº§n lock:
		Flags: running, isReady, shutdownRequested.
		Double-checked locking (DCL) khi khá»Ÿi táº¡o singleton:
	
class Singleton {
    private static volatile Singleton instance;

    public static Singleton getInstance() {
        if (instance == null) {
            synchronized (Singleton.class) {
                if (instance == null) {
                    instance = new Singleton();
                }
            }
        }
        return instance;
    }
}

DÃ¹ng cho biáº¿n Ä‘Æ°á»£c nhiá»u thread Ä‘á»c nhÆ°ng hiáº¿m khi ghi (read-mostly).


# 5. Khi khÃ´ng nÃªn dÃ¹ng

	- Khi cáº§n atomicity (tÄƒng/giáº£m counter, update list, ...):
volatile int count = 0;
count++; // KHÃ”NG an toÃ n (read â†’ modify â†’ write khÃ´ng atomic)

	â†’ DÃ¹ng AtomicInteger hoáº·c synchronized / Lock.

	Khi biáº¿n thay Ä‘á»•i quÃ¡ thÆ°á»ng xuyÃªn:
		- volatile gÃ¢y cache miss liÃªn tá»¥c, cháº­m hÆ¡n so vá»›i giá»¯ local copy.
		- Cá»±c ká»³ tá»‡ náº¿u trong hot loop.


# 6. False Sharing â€“ káº» thÃ¹ tháº§m láº·ng
	
	- Xáº£y ra khi nhiá»u thread Ä‘á»c/ghi cÃ¡c biáº¿n khÃ¡c nhau nhÆ°ng náº±m chung 1 cache line (thÆ°á»ng 64 bytes).
	- Vá»›i volatile, CPU invalidates cache line â†’ áº£nh hÆ°á»Ÿng thread khÃ¡c dÃ¹ khÃ´ng Ä‘á»¥ng cÃ¹ng biáº¿n.
	
	## Giáº£i phÃ¡p:
		Padding:
@Contended // (Java 8+, cáº§n báº­t -XX:-RestrictContended)
volatile long counter;

	Hoáº·c nhÃ©t biáº¿n â€œÄ‘á»‡mâ€ giá»¯a cÃ¡c biáº¿n Ä‘Æ°á»£c thread khÃ¡c nhau ghi.



# 7. So sÃ¡nh vá»›i synchronized

| TiÃªu chÃ­           | volatile                        | synchronized                |
| ------------------ | ------------------------------- | --------------------------- |
| **Visibility**     | CÃ³                              | CÃ³                          |
| **Atomicity**      | KhÃ´ng (trá»« Ä‘á»c/ghi Ä‘Æ¡n giáº£n)    | CÃ³                          |
| **Blocking**       | KhÃ´ng                           | CÃ³ (mutual exclusion)       |
| **Overhead**       | Tháº¥p hÆ¡n náº¿u chá»‰ cáº§n visibility | Cao hÆ¡n                     |
| **Memory barrier** | Chá»‰ á»Ÿ read/write biáº¿n Ä‘Ã³        | á» entry/exit cá»§a toÃ n block |


# 8. TÃ³m táº¯t tÆ° duy senior

	## volatile khÃ´ng thay tháº¿ lock â†’ chá»‰ Ä‘áº£m báº£o visibility vÃ  happens-before.
	
	## DÃ¹ng khi:
	
		- Truyá»n tÃ­n hiá»‡u Ä‘Æ¡n giáº£n giá»¯a thread.
		- Double-checked locking.
		- Read-mostly shared config/state.

	## TrÃ¡nh khi:
	
		- Update phá»©c táº¡p hoáº·c cáº§n consistency nhiá»u biáº¿n.
		- Nhiá»u ghi liÃªn tá»¥c â†’ overhead + false sharing.	
	
	
	
</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>