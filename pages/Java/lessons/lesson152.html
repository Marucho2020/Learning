<html><head><title>Lesson 152 == Stream performance tuning ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 152 -- Stream performance tuning -//</h1><pre>
	Trong há»‡ thá»‘ng lá»›n, Stream API cá»§a Java lÃ  má»™t cÃ´ng cá»¥ ráº¥t máº¡nh Ä‘á»ƒ xá»­ lÃ½ dá»¯ liá»‡u, nhÆ°ng cÅ©ng cÃ³ thá»ƒ lÃ  nguyÃªn nhÃ¢n gÃ¢y ra bottleneck náº¿u khÃ´ng Ä‘Æ°á»£c tinh chá»‰nh Ä‘Ãºng cÃ¡ch. DÆ°á»›i Ä‘Ã¢y lÃ  phÃ¢n tÃ­ch chi tiáº¿t cáº¥p Ä‘á»™ senior vá» Stream performance tuning kÃ¨m theo cÃ¡c gÃ³c nhÃ¬n thá»±c chiáº¿n:


# âš™ï¸ 1. Hiá»ƒu rÃµ báº£n cháº¥t cá»§a Stream

	Stream khÃ´ng lÆ°u trá»¯ dá»¯ liá»‡u â†’ chá»‰ lÃ  má»™t pipeline cá»§a cÃ¡c phÃ©p biáº¿n Ä‘á»•i (map, filter, flatMap, v.v.)
	
	Stream lÃ  lazy â†’ cÃ¡c operations trung gian khÃ´ng thá»±c hiá»‡n cho Ä‘áº¿n khi cÃ³ terminal operation (collect, reduce, count, forEach,...).
	
	â†’ Äiá»u nÃ y ráº¥t quan trá»ng: náº¿u khÃ´ng cÃ³ terminal operation â†’ Stream khÃ´ng lÃ m gÃ¬ cáº£.


# ğŸš§ 2. TrÃ¡nh cÃ¡c lá»—i hiá»‡u nÄƒng phá»• biáº¿n 

	## âŒ Sá»­ dá»¥ng Stream sai ngá»¯ cáº£nh 
List<String> result = list.stream()
    .filter(s -> s.length() > 3)
    .map(String::toUpperCase)
    .collect(Collectors.toList());


		Náº¿u danh sÃ¡ch ráº¥t lá»›n â†’ memory pressure tÄƒng nhanh náº¿u khÃ´ng cÃ³ short-circuiting.
		Náº¿u list lÃ  má»™t LinkedList, viá»‡c stream hÃ³a sáº½ cháº­m hÆ¡n ArrayList do random access yáº¿u.
		

	## âœ… Khuyáº¿n nghá»‹:

		Chá»‰ dÃ¹ng Stream khi thá»±c sá»± cáº§n: dá»¯ liá»‡u lá»›n + cáº§n pipeline hÃ³a logic rÃµ rÃ ng.
		TrÃ¡nh dÃ¹ng Stream trong loop hoáº·c khi cáº§n logic phá»©c táº¡p lá»“ng nhau nhiá»u táº§ng.



# ğŸ§  3. Sá»­ dá»¥ng parallelStream má»™t cÃ¡ch thÃ´ng minh
	parallelStream() cÃ³ thá»ƒ tÄƒng hiá»‡u nÄƒngâ€¦ hoáº·c giáº¿t cháº¿t performance náº¿u dÃ¹ng sai.
	
	## Khi nÃªn dÃ¹ng parallelStream(): 
		- Dá»¯ liá»‡u lá»›n (>10,000 pháº§n tá»­).
		- Má»—i phÃ©p biáº¿n Ä‘á»•i Ä‘áº¯t Ä‘á» (CPU-intensive).
		- MÃ¡y cÃ³ nhiá»u core (Ä‘a luá»“ng hiá»‡u quáº£).


	## Khi khÃ´ng nÃªn dÃ¹ng:

		Dá»¯ liá»‡u nhá».
		CÃ³ thao tÃ¡c I/O blocking.
		Má»—i pháº§n tá»­ cáº§n truy cáº­p vÃ o shared state (sáº½ gÃ¢y contention).

		âš ï¸ "Parallel is not always faster." â€“ Benchmark ká»¹ tá»«ng tÃ¬nh huá»‘ng trÆ°á»›c khi tin tÆ°á»Ÿng nÃ³.


# ğŸ“š 4. DÃ¹ng Collector custom Ä‘á»ƒ giáº£m allocation
	Collector<T, ?, Map<K, List<T>>> customCollector = 
    Collectors.groupingBy(...);

	Nhá»¯ng Collector máº·c Ä‘á»‹nh nhÆ° groupingBy, partitioningBy cÃ³ thá»ƒ gÃ¢y ra allocation thá»«a hoáº·c boxing.

	## âœ… Táº¡o custom Collector náº¿u: 
		Cáº§n pooling / reuse container.
		Muá»‘n optimize memory footprint.



# ğŸ”„ 5. TrÃ¡nh cÃ¡c map() thá»«a hoáº·c .stream().stream() lá»“ng nhau

	VÃ­ dá»¥ tá»‡:

list.stream()
    .map(obj -> obj.getSubList().stream())
    .collect(Collectors.toList());

â†’ KhÃ´ng táº¡o Ä‘Æ°á»£c pipeline Ä‘Ãºng, hoáº·c gÃ¢y ra váº¥n Ä‘á» boxing/unboxing khi xá»­ lÃ½ primitive.

	âœ… DÃ¹ng flatMap náº¿u muá»‘n flatten:
	
list.stream()
    .flatMap(obj -> obj.getSubList().stream())
    .collect(Collectors.toList());


# ğŸ§© 6. Æ¯u tiÃªn primitive streams khi cÃ³ thá»ƒ

IntStream.range(0, 1000000).sum();

Stream<Integer>.range(...).reduce(...)

	â†’ TrÃ¡nh boxing/unboxing â†’ giáº£m GC pressure.



# ğŸ§µ 7. Cáº©n trá»ng vá»›i stateful lambda vÃ  side effect

List<String> logs = new ArrayList<>();
list.stream()
    .filter(x -> {
        logs.add(x.toString());  // side effect
        return true;
    })
    .collect(Collectors.toList());


	â†’ Vá»«a sai vá»›i functional style, vá»«a gÃ¢y race condition náº¿u dÃ¹ng parallel stream.



# âœ… Tá»•ng káº¿t: Nhá»¯ng nguyÃªn táº¯c Tuning cáº¥p Ä‘á»™ Senior 


| Ká»¹ thuáº­t                                         | Má»¥c tiÃªu                             | LÆ°u Ã½                                  |
| ------------------------------------------------ | ------------------------------------ | -------------------------------------- |
| DÃ¹ng Ä‘Ãºng loáº¡i `Stream` (sequential vs parallel) | Tá»‘i Æ°u performance theo workload     | Benchmark cáº©n tháº­n                     |
| TrÃ¡nh boxing                                     | Giáº£m GC & CPU overhead               | DÃ¹ng `IntStream`, `LongStream`...      |
| Æ¯u tiÃªn `flatMap` thay cho stream lá»“ng           | Giáº£m nesting, dá»… Ä‘á»c                 | TrÃ¡nh `stream().stream()`              |
| Custom Collector                                 | Giáº£m allocation, tÄƒng tÃ­nh linh hoáº¡t | YÃªu cáº§u hiá»ƒu sÃ¢u `Collector` interface |
| TrÃ¡nh `stateful lambda`                          | Äáº£m báº£o purity                       | Dá»… gÃ¢y race condition                  |
| KhÃ´ng láº¡m dá»¥ng stream                            | Khi logic Ä‘Æ¡n giáº£n                   | `for` loop váº«n ráº¥t hiá»‡u quáº£            |

</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>