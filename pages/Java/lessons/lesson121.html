<html><head><title>Lesson 121 == StampedLock ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 121 -- StampedLock -//</h1><pre>
# KhÃ¡i niá»‡m 
	StampedLock â€“ má»™t trong nhá»¯ng cÆ¡ cháº¿ Ä‘á»“ng bá»™ hiá»‡n Ä‘áº¡i nháº¥t trong Java ká»ƒ tá»« Java 8, Ä‘Æ°á»£c thiáº¿t káº¿ tá»‘i Æ°u cho há»‡ thá»‘ng Ä‘a luá»“ng tá»‘c Ä‘á»™ cao, vá»›i má»¥c tiÃªu thay tháº¿ ReentrantReadWriteLock.


# ğŸ”§ 1. Váº¥n Ä‘á» vá»›i ReentrantReadWriteLock 
	
	ReentrantReadWriteLock chia khÃ³a lÃ m hai loáº¡i:
		- Read lock (chia sáº»): nhiá»u thread cÃ¹ng Ä‘á»c
		- Write lock (Ä‘á»™c quyá»n): chá»‰ 1 thread ghi


	## NhÆ°á»£c Ä‘iá»ƒm: 
		- Chi phÃ­ lá»›n Ä‘á»ƒ láº¥y lock
		- Khi nhiá»u thread Ä‘á»c + 1 thread ghi, lock upgrade ráº¥t tá»‘n kÃ©m
		- KhÃ´ng há»— trá»£ lock-free optimistic read
		- KhÃ´ng há»— trá»£ downgrade thÃ´ng minh


# âœ… 2. StampedLock â€“ thiáº¿t káº¿ hiá»‡n Ä‘áº¡i, high-performance

	KhÃ´ng chá»‰ cÃ³ read/write lock, mÃ  cÃ²n cÃ³:
	
		âœ”ï¸ Optimistic read (khÃ´ng block, khÃ´ng lock)
		âœ”ï¸ Precise validation sau khi Ä‘á»c
		âœ”ï¸ Stamp (long token) Ä‘á»ƒ theo dÃµi tráº¡ng thÃ¡i
		âœ”ï¸ Support lock upgrade/downgrade thá»§ cÃ´ng



# ğŸ§± 3. Cáº¥u trÃºc vÃ  cÃ¡ch hoáº¡t Ä‘á»™ng 

StampedLock lock = new StampedLock();
long stamp = lock.tryOptimisticRead();

if (lock.validate(stamp)) {
    // dá»¯ liá»‡u khÃ´ng bá»‹ ghi trong lÃºc Ä‘á»c
} else {
    // fallback: lock.readLock()
}



	## CÃ¡c loáº¡i lock: 
| Lock                  | Blocking?      | Shared? | Khi dÃ¹ng                                         |
| --------------------- | -------------- | ------- | ------------------------------------------------ |
| `writeLock()`         | âœ… block        | âŒ       | Khi update dá»¯ liá»‡u                               |
| `readLock()`          | âœ… block        | âœ…       | Khi Ä‘á»c dá»¯ liá»‡u vÃ  cáº§n Ä‘áº£m báº£o khÃ´ng thay Ä‘á»•i    |
| `tryOptimisticRead()` | âŒ non-blocking | âœ…       | Äá»c nhanh vÃ  kiá»ƒm tra sau                        |
| `validate(stamp)`     | âŒ              | âŒ       | Kiá»ƒm tra xem dá»¯ liá»‡u cÃ³ bá»‹ ghi sau khi Ä‘á»c khÃ´ng |
	


# ğŸ¯ 4. VÃ­ dá»¥ dÃ¹ng StampedLock chuáº©n hÃ³a

class Point {
    private double x, y;
    private final StampedLock sl = new StampedLock();

    // Ghi
    void move(double deltaX, double deltaY) {
        long stamp = sl.writeLock();
        try {
            x += deltaX;
            y += deltaY;
        } finally {
            sl.unlockWrite(stamp);
        }
    }

    // Äá»c vá»›i optimistic lock
    double distanceFromOrigin() {
        long stamp = sl.tryOptimisticRead();
        double currentX = x, currentY = y;
        if (!sl.validate(stamp)) {
            stamp = sl.readLock();
            try {
                currentX = x;
                currentY = y;
            } finally {
                sl.unlockRead(stamp);
            }
        }
        return Math.sqrt(currentX * currentX + currentY * currentY);
    }
}

	â¡ Náº¿u khÃ´ng cÃ³ ghi xáº£y ra â†’ trÃ¡nh Ä‘Æ°á»£c chi phÃ­ lock
	â¡ Náº¿u ghi xáº£y ra â†’ fallback sang read lock


# ğŸ§  5. KhÃ¡c biá»‡t vá»›i ReentrantReadWriteLock

| TÃ­nh nÄƒng              | `StampedLock`                                | `ReentrantReadWriteLock`      |
| ---------------------- | -------------------------------------------- | ----------------------------- |
| Optimistic read        | âœ… CÃ³                                         | âŒ KhÃ´ng                       |
| Downgrade write â†’ read | âœ… CÃ³ (manual)                                | âœ…                             |
| Upgrade read â†’ write   | âš ï¸ KhÃ´ng trá»±c tiáº¿p (pháº£i release & lock láº¡i) | âœ… CÃ³                          |
| Lock reentrancy        | âŒ KhÃ´ng reentrant                            | âœ… CÃ³                          |
| Performance            | âœ… Cao hÆ¡n                                    | âŒ Cháº­m hÆ¡n khi contention lá»›n |
| API phá»©c táº¡p           | âš ï¸ Cao                                       | Trung bÃ¬nh                    |



# âš ï¸ 6. LÆ°u Ã½ quan trá»ng (cáº¡m báº«y senior)

	##âŒ KhÃ´ng reentrant:
	
long s1 = lock.writeLock();
long s2 = lock.writeLock(); // ğŸ’¥ Deadlock â€“ khÃ´ng tá»± Ä‘á»™ng reentrant nhÆ° `ReentrantLock`

	## âš ï¸ Pháº£i luÃ´n quáº£n lÃ½ stamp thá»§ cÃ´ng:

	Náº¿u báº¡n quÃªn unlockRead(stamp) hoáº·c dÃ¹ng sai stamp, háº­u quáº£ lÃ :

		- Deadlock
		- Lost lock
		- Race condition khÃ´ng rÃµ nguyÃªn nhÃ¢n

	âŒ KhÃ´ng dÃ¹ng StampedLock cho cÃ¡c use-case Ä‘Æ¡n giáº£n:
	â†’ NÃ³ phá»©c táº¡p, nÃªn chá»‰ phÃ¹ há»£p cho cÃ¡c há»‡ thá»‘ng yÃªu cáº§u cá»±c cao vá» hiá»‡u nÄƒng vÃ  concurrency



# ğŸ§ª 7. Khi nÃ o nÃªn dÃ¹ng StampedLock? 
| Use case                                      | CÃ³ dÃ¹ng `StampedLock`?                                       |
| --------------------------------------------- | ------------------------------------------------------------ |
| Cache nhiá»u thread Ä‘á»c, Ã­t thread ghi         | âœ… Ráº¥t phÃ¹ há»£p                                                |
| Äáº¿m, Ä‘o, log, mÃ  muá»‘n trÃ¡nh lock              | âœ… DÃ¹ng optimistic read                                       |
| BÃ i toÃ¡n cáº§n upgrade lock (Ä‘á»c â†’ ghi)         | âš ï¸ CÃ¢n nháº¯c â€“ khÃ´ng dá»… dÃ¹ng                                  |
| Logic phá»©c táº¡p, cáº§n nhiá»u thread nesting lock | âŒ KhÃ´ng â€“ dÃ¹ng `ReentrantReadWriteLock` hoáº·c `ReentrantLock` |
| DÃ¹ng trong cáº¥u trÃºc dá»¯ liá»‡u custom concurrent | âœ… (vÃ­ dá»¥ nhÆ° ConcurrentLinkedTree)                           |


# ğŸ”§ 8. Bonus: Máº«u nÃ¢ng cáº¥p lock Ä‘Ãºng cÃ¡ch

long stamp = lock.readLock();
try {
    if (needWrite()) {
        long ws = lock.tryConvertToWriteLock(stamp);
        if (ws != 0L) {
            stamp = ws;
            // now it's write lock
        } else {
            lock.unlockRead(stamp);
            stamp = lock.writeLock(); // slow path
        }
    }
    // do stuff
} finally {
    lock.unlock(stamp);
}



# âœ… Tá»•ng káº¿t

	- StampedLock = hiá»‡n Ä‘áº¡i, hiá»‡u nÄƒng cá»±c cao, tá»‘i Æ°u cho tÃ¬nh huá»‘ng read nhiá»u, write Ã­t
	- NÃ³ Ä‘Æ°a ra má»™t level Ä‘iá»u khiá»ƒn lock tháº¥p hÆ¡n, phÃ¹ há»£p cho há»‡ thá»‘ng real-time, low-latency
	- Pháº£i quáº£n lÃ½ logic vÃ  lifecycle thá»§ cÃ´ng
	- KhÃ´ng phÃ¹ há»£p vá»›i beginner hoáº·c code Ä‘Æ¡n giáº£n
	- Náº¿u dÃ¹ng Ä‘Ãºng cÃ¡ch â†’ outperform má»i lock trong Java


</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>