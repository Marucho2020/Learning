<html><head><title>Lesson 120 == Striped64 ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 120 -- Striped64 -//</h1><pre>
# KhÃ¡i niá»‡m 
	Striped64 lÃ  má»™t lá»›p abstract ná»™i bá»™ trong java.util.concurrent.atomic, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ cung cáº¥p:

		- Counter lock-free hiá»‡u nÄƒng cao
		- Scale tá»‘t trong mÃ´i trÆ°á»ng Ä‘a luá»“ng
		- LÃ  cÆ¡ sá»Ÿ cho LongAdder, DoubleAdder, LongAccumulator,...
		- Tá»« Java 8+, nÃ³ thay tháº¿ cho AtomicLong trong háº§u háº¿t trÆ°á»ng há»£p Ä‘o lÆ°á»ng/logging hiá»‡u nÄƒng.

# âœ… 2. Ã tÆ°á»Ÿng cá»‘t lÃµi: â€œstriped countersâ€ 
	TÄƒng hiá»‡u nÄƒng ghi dá»¯ liá»‡u báº±ng cÃ¡ch chia vÃ¹ng ghi (striping):


	## ğŸ” Váº¥n Ä‘á» cá»§a AtomicLong:
		AtomicLong counter = new AtomicLong(0);
		Khi 1000 thread cÃ¹ng gá»i counter.incrementAndGet() â†’ táº¥t cáº£ tranh nhau cÃ¹ng 1 giÃ¡ trá»‹ â†’ contention cá»±c lá»›n, dÃ¹ng CAS (compareAndSet) liÃªn tá»¥c, ráº¥t tá»‘n tÃ i nguyÃªn CPU.
		
	## 	âœ… Giáº£i phÃ¡p Striped64: chia nhá» counter thÃ nh nhiá»u cell
		Instead of:
    One counter â†’ All threads write to it

Now:
    Array[Cell0, Cell1, ..., CellN]
    Each thread hashes to one cell â†’ updates its own cell

		
	Khi láº¥y tá»•ng (sum()): cá»™ng táº¥t cáº£ giÃ¡ trá»‹ trong tá»«ng cell.
	â¡ Ã tÆ°á»Ÿng giá»‘ng concurrent hash map: chia nhá» Ä‘á»ƒ trÃ¡nh contention.
	
	
# âœ… 3. Cáº¥u trÃºc lá»›p Striped64 
	
abstract class Striped64 extends Number {
    transient volatile Cell[] cells;  // máº£ng cÃ¡c cell (náº¿u bá»‹ contention)
    transient volatile long base;     // giÃ¡ trá»‹ gá»‘c náº¿u chÆ°a táº¡o cells
    transient volatile int cellsBusy; // giá»‘ng 1 mutex bitlock (0/1) Ä‘á»ƒ trÃ¡nh race khi resize cells
}
	
	
		- base: dÃ¹ng khi chÆ°a cÃ³ contention, táº¥t cáº£ thread ghi chung
		- cells: náº¿u báº¯t Ä‘áº§u cÃ³ contention â†’ táº¡o cells[] Ä‘á»ƒ má»—i thread ghi riÃªng
		- cellsBusy: dÃ¹ng Ä‘á»ƒ Ä‘iá»u phá»‘i viá»‡c khá»Ÿi táº¡o hoáº·c resize cells[]
	
# 	âœ… 4. Class Cell: Ä‘Æ¡n vá»‹ dá»¯ liá»‡u nhá»
	
static final class Cell {
    volatile long value;

    Cell(long x) { value = x; }

    final boolean cas(long cmp, long val) {
        return UNSAFE.compareAndSwapLong(this, valueOffset, cmp, val);
    }
}
		
		Má»—i Cell lÃ  1 Ã´ chá»©a sá»‘ long â†’ dÃ¹ng CAS Ä‘á»ƒ update
		CÃ³ @Contended (náº¿u báº­t VM option -XX:-RestrictContended) Ä‘á»ƒ trÃ¡nh false sharing giá»¯a cache line	
		



# âœ… 5. CÃ¡ch hoáº¡t Ä‘á»™ng chi tiáº¿t khi add(x) hoáº·c accumulate(x)

1. Náº¿u chÆ°a cÃ³ cells[]:
    â†’ thá»­ cá»™ng vÃ o base (CAS)
    â†’ náº¿u CAS tháº¥t báº¡i â†’ báº¯t Ä‘áº§u contention â†’ khá»Ÿi táº¡o cells[]

2. Náº¿u cÃ³ cells[]:
    â†’ thread hash vÃ o cell nÃ o Ä‘Ã³
    â†’ CAS vÃ o cell.value

3. Náº¿u váº«n contention (CAS fail quÃ¡ nhiá»u):
    â†’ má»Ÿ rá»™ng cells[] (resize gáº¥p Ä‘Ã´i)


	Má»i thá»© Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ:
		- TrÃ¡nh synchronized
		- Scale tuyáº¿n tÃ­nh vá»›i sá»‘ core
		- Giáº£m tá»‘i Ä‘a false sharing/cache contention


# âœ… 6. Thuáº­t toÃ¡n má»Ÿ rá»™ng cells[]

	- Báº¯t Ä‘áº§u tá»« máº£ng kÃ­ch thÆ°á»›c nhá» (2)
	- Khi CAS vÃ o Cell[i] tháº¥t báº¡i quÃ¡ nhiá»u (nhiá»u thread cÃ¹ng Ä‘á»¥ng vÃ o 1 cell)
	- â†’ resize máº£ng lÃªn gáº¥p Ä‘Ã´i
	- Chá»‰ 1 thread Ä‘Æ°á»£c phÃ©p resize (controlled báº±ng cellsBusy giá»‘ng mutex áº£o)
	- â¡ Resize giá»‘ng nhÆ° rehash trong HashMap nhÆ°ng Ä‘Æ¡n giáº£n hÆ¡n.



# âœ… 7. Tá»‘i Æ°u performance theo kiáº¿n trÃºc CPU

	- @sun.misc.Contended / padding Ä‘á»ƒ trÃ¡nh false sharing
	- KhÃ´ng dÃ¹ng synchronized
	- Chá»‰ sá»­ dá»¥ng CAS, volatile, spin
	- Cáº¥u trÃºc theo Ä‘Ãºng cache line alignment
	- â¡ Má»i tá»‘i Æ°u Ä‘á»u nháº±m Ä‘áº¡t Ä‘Æ°á»£c performance tá»‘t hÆ¡n AtomicLong


#  âœ… 8. Æ¯u vÃ  nhÆ°á»£c 
	

	## âœ… Æ¯u Ä‘iá»ƒm: 
		
		- Lock-free, scalable, hiá»‡u nÄƒng cá»±c cao
		- Chá»‹u Ä‘Æ°á»£c lÆ°á»£ng thread tÄƒng máº¡nh
		- Cáº¥u trÃºc tinh gá»n nhÆ°ng máº¡nh máº½
		- Dá»… má»Ÿ rá»™ng (cÆ¡ sá»Ÿ cho LongAdder, LongAccumulator...)


	## âŒ NhÆ°á»£c Ä‘iá»ƒm:
	
		- get() hoáº·c sum() khÃ´ng pháº£i atomic snapshot: giÃ¡ trá»‹ cÃ³ thá»ƒ "bá»‹ xÃ© láº»"
		- KhÃ´ng phÃ¹ há»£p khi cáº§n chÃ­nh xÃ¡c tuyá»‡t Ä‘á»‘i táº¡i tá»«ng thá»i Ä‘iá»ƒm (nhÆ° sinh ID tÄƒng dáº§n)
		- Phá»©c táº¡p khi debug vÃ¬ quÃ¡ trá»«u tÆ°á»£ng
	
	
# âœ… 9. Cáº¥u trÃºc thá»«a káº¿ thá»±c táº¿

            Number
               â†‘
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚
   Striped64 (abstract) â”‚
         â†‘              â†‘
 LongAdder       LongAccumulator
 
	LongAdder â†’ chá»‰ dÃ¹ng phÃ©p cá»™ng
	LongAccumulator â†’ tÃ­ch lÅ©y tuá»³ chá»‰nh
	
	
# âœ… 10. So sÃ¡nh vá»›i AtomicLong	
	
| TÃ­nh nÄƒng           | `AtomicLong`  | `Striped64` (LongAdder, etc.) |
| ------------------- | ------------- | ----------------------------- |
| CAS                 | âœ…             | âœ…                             |
| Lock-free           | âœ…             | âœ…                             |
| Scale trÃªn 16+ core | âŒ yáº¿u         | âœ… ráº¥t tá»‘t                     |
| Tá»‘c Ä‘á»™ `increment`  | Trung bÃ¬nh    | Ráº¥t cao                       |
| Tá»‘c Ä‘á»™ `get()`      | Ráº¥t chÃ­nh xÃ¡c | KhÃ´ng guaranteed snapshot     |
| Gá»¡ lá»—i dá»…           | âœ…             | âŒ KhÃ³ Ä‘á»c                     |
| TÃ¹y chá»‰nh tÃ­ch lÅ©y  | âŒ             | âœ… (qua `LongAccumulator`)     |






















</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>