<html><head><title>Lesson 163 == synchronized vÃ  Intrinsic Locks ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 163 -- synchronized vÃ  Intrinsic Locks -//</h1><pre>
# 1. Intrinsic Lock / Object Monitor lÃ  gÃ¬?

	- Má»—i object trong Java (bao gá»“m cáº£ instance vÃ  Class object) cÃ³ 1 monitor áº©n bÃªn trong
	- Monitor nÃ y lÃ  cÆ¡ cháº¿ Ä‘á»“ng bá»™ hÃ³a á»Ÿ má»©c JVM (khÃ´ng pháº£i Java API) dÃ¹ng Ä‘á»ƒ:
		1.Quáº£n lÃ½ quyá»n truy cáº­p vÃ o cÃ¡c Ä‘oáº¡n code Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u synchronized.
		2.Há»— trá»£ reentrant locking (cÃ¹ng má»™t thread cÃ³ thá»ƒ lock nhiá»u láº§n mÃ  khÃ´ng bá»‹ block chÃ­nh nÃ³).

	- Khi má»™t thread gá»i code synchronized (method hoáº·c block), JVM sáº½ gáº¯n intrinsic lock cá»§a object Ä‘Ã³ vÃ o thread.

	ğŸ’¡ LÆ°u Ã½: â€œIntrinsic lockâ€ = â€œMonitor lockâ€ = â€œObject monitorâ€ trong tÃ i liá»‡u JVM.


# 2. CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng cá»§a synchronized

	## CÃ³ 2 cÃ¡ch sá»­ dá»¥ng: 
	
		1. Synchronized Method
			public synchronized void doTask() { ... }
			â†’ Lock gáº¯n vá»›i object instance (hoáº·c class náº¿u method lÃ  static).

		2. Synchronized Block
			synchronized (lockObj) { ... }
			
		â†’ Lock gáº¯n vá»›i lockObj cá»¥ thá»ƒ.


	## NguyÃªn táº¯c:
		- Khi má»™t thread chÆ°a giá»¯ lock â†’ nÃ³ pháº£i chá» (BLOCKED) Ä‘áº¿n khi lock Ä‘Æ°á»£c release.
		- Khi thread Ä‘Ã£ giá»¯ lock â†’ nÃ³ cÃ³ thá»ƒ vÃ o láº¡i cÃ¡c Ä‘oáº¡n code synchronized trÃªn cÃ¹ng object (reentrant).
		- Khi ra khá»i block/method â†’ JVM release lock tá»± Ä‘á»™ng (khÃ¡c vá»›i ReentrantLock cáº§n unlock() thá»§ cÃ´ng).	
	
	
# 3. Reentrancy	
		Reentrant lock nghÄ©a lÃ : náº¿u thread A Ä‘Ã£ giá»¯ lock cá»§a object X, nÃ³ cÃ³ thá»ƒ vÃ o láº¡i báº¥t ká»³ Ä‘oáº¡n code synchronized nÃ o trÃªn X mÃ  khÃ´ng bá»‹ block.
	
		JVM theo dÃµi Ä‘áº¿m sá»‘ láº§n lock (lock count).
	
public synchronized void a() { b(); }
public synchronized void b() { ... }

		Khi thread A gá»i a():
			a() gá»i b() â†’ cÃ¹ng object, lock count tÄƒng = 2
			Khi b() xong â†’ lock count giáº£m = 1, khi a() xong â†’ giáº£m = 0 â†’ release lock.

# 4. Race Condition & Deadlock

	## Race Condition

		Xáº£y ra khi nhiá»u thread truy cáº­p cÃ¹ng dá»¯ liá»‡u chia sáº» vÃ  Ã­t nháº¥t 1 thread ghi dá»¯ liá»‡u, mÃ  khÃ´ng cÃ³ Ä‘á»“ng bá»™.
		
		VÃ­ dá»¥: counter tÄƒng/giáº£m khÃ´ng Ä‘á»“ng bá»™ â†’ káº¿t quáº£ sai.
		

	## Deadlock
		Xáº£y ra khi 2+ thread giá»¯ cÃ¡c lock khÃ¡c nhau vÃ  chá» nhau release â†’ vÃ²ng chá» vÃ´ táº­n.

synchronized (lockA) {
    synchronized (lockB) { ... }
}

		Thread 1 lock A â†’ chá» B
		Thread 2 lock B â†’ chá» A
		â†’ Deadlock.
		

# 5. Hiá»‡u nÄƒng & JVM Optimization

	JVM tá»« Java 6+ tá»‘i Æ°u synchronized báº±ng:

	- Biased Locking: lock gáº¯n cá»‘ Ä‘á»‹nh cho thread náº¿u khÃ´ng cÃ³ tranh cháº¥p.
	- Lightweight Locking: dÃ¹ng CAS thay vÃ¬ OS-level mutex khi cÃ³ tranh cháº¥p nháº¹.
	- Lock Elision: bá» lock náº¿u chá»©ng minh Ä‘Æ°á»£c khÃ´ng cÃ³ tranh cháº¥p.
	- Lock Coarsening: má»Ÿ rá»™ng pháº¡m vi lock Ä‘á»ƒ giáº£m sá»‘ láº§n acquire/release.

# 6. Khi nÃ o dÃ¹ng synchronized, khi nÃ o dÃ¹ng ReentrantLock?

| TiÃªu chÃ­                  | `synchronized` | `ReentrantLock`                  |
| ------------------------- | -------------- | -------------------------------- |
| **CÃº phÃ¡p**               | Tá»« khÃ³a, gá»n   | API phá»©c táº¡p                     |
| **Reentrancy**            | CÃ³             | CÃ³                               |
| **Fairness**              | KhÃ´ng          | CÃ³ (tÃ¹y chá»n fair lock)          |
| **Try lock with timeout** | KhÃ´ng          | CÃ³                               |
| **Condition variables**   | KhÃ´ng          | CÃ³ (`Condition` interface)       |
| **Tá»± Ä‘á»™ng release**       | CÃ³             | KhÃ´ng (pháº£i `unlock()` thá»§ cÃ´ng) |



# 8. TÃ³m táº¯t

	- Intrinsic Lock = Lock gáº¯n vá»›i object, quáº£n lÃ½ bá»Ÿi JVM.
	- synchronized Ä‘áº£m báº£o mutual exclusion + visibility.
	- Há»— trá»£ reentrant â†’ trÃ¡nh self-deadlock.
	- Cáº§n cáº©n trá»ng trÃ¡nh deadlock báº±ng cÃ¡ch thá»‘ng nháº¥t thá»© tá»± lock.
	- JVM tá»‘i Æ°u máº¡nh tá»« Java 6+ â†’ Ä‘á»«ng sá»£ dÃ¹ng synchronized náº¿u code Ä‘Ãºng.



</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>