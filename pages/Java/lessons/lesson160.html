<html><head><title>Lesson 160 == Java Memory Model - JMM ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 160 -- Java Memory Model - JMM -//</h1><pre>
# I. â— Táº¡i sao pháº£i hiá»ƒu Java Memory Model?
	Khi code Ä‘a luá»“ng, logic Ä‘Ãºng chÆ°a Ä‘á»§. Náº¿u khÃ´ng hiá»ƒu cÃ¡ch JVM giao tiáº¿p vá»›i bá»™ nhá»› váº­t lÃ½ (RAM, cache), báº¡n sáº½ dÃ­nh lá»—i khÃ³ truy váº¿t nhÆ°:
		- Race condition dÃ¹ cÃ³ if kiá»ƒm tra logic.
		- Dá»¯ liá»‡u khÃ´ng Ä‘á»“ng nháº¥t dÃ¹ khÃ´ng cÃ³ lá»—i cÃº phÃ¡p.
		- Thread Ä‘á»c giÃ¡ trá»‹ cÅ© khÃ´ng rÃµ lÃ½ do.

	ğŸ’£ Nhá»¯ng lá»—i nÃ y sinh ra do compiler optimizations, CPU caching, vÃ  thiáº¿u Ä‘áº£m báº£o vá» thá»© tá»± thá»±c thi â€“ vÃ  JMM ra Ä‘á»i Ä‘á»ƒ xá»­ lÃ½ Ä‘iá»u Ä‘Ã³.


# II. ğŸ”¬ Java Memory Model (JMM) lÃ  gÃ¬?

	JMM Ä‘á»‹nh nghÄ©a hÃ nh vi Ä‘á»c/ghi cá»§a cÃ¡c biáº¿n shared giá»¯a cÃ¡c thread.
	NÃ³ giáº£i quyáº¿t: 
		- visibility: thread A cáº­p nháº­t biáº¿n, liá»‡u thread B cÃ³ tháº¥y khÃ´ng?
		- ordering: thá»© tá»± Ä‘á»c/ghi cÃ³ giá»¯ nguyÃªn nhÆ° code khÃ´ng?
		- atomicity: thao tÃ¡c cÃ³ chia nhá» khÃ´ng?
	

# III. ğŸ” Quy táº¯c happens-before 
	JMM khÃ´ng Ä‘áº£m báº£o thá»© tá»± thá»±c thi theo thá»© tá»± code â€“ chá»‰ Ä‘áº£m báº£o cÃ¡c hÃ nh vi tuÃ¢n theo quan há»‡ happens-before.

	Má»™t sá»‘ quy táº¯c happens-before quan trá»ng:

| HÃ nh vi                 | Ã nghÄ©a                                                       |
| ----------------------- | ------------------------------------------------------------- |
| `synchronized`          | VÃ o 1 monitor lock xáº£y ra sau khi thread khÃ¡c thoÃ¡t cÃ¹ng lock |
| `volatile` write â†’ read | Ghi biáº¿n volatile luÃ´n "xáº£y ra trÆ°á»›c" khi thread khÃ¡c Ä‘á»c     |
| `Thread.start()`        | Main thread xáº£y ra trÆ°á»›c logic trong thread má»›i               |
| `Thread.join()`         | Thread chÃ­nh tháº¥y má»i thay Ä‘á»•i cá»§a thread con sau khi join    |


# IV. ğŸ”¥ CPU Reordering & Compiler Optimization
	CPU vÃ  compiler khÃ´ng Ä‘áº£m báº£o thá»±c thi Ä‘Ãºng thá»© tá»± nhÆ° báº¡n viáº¿t.

boolean ready = false;
int data;

Thread A:             Thread B:
data = 42;            if (ready) System.out.println(data);
ready = true;

	Náº¿u khÃ´ng dÃ¹ng volatile hay synchronized, cÃ³ thá»ƒ ready = true bá»‹ thá»±c thi trÆ°á»›c data = 42 â†’ Thread B in ra 0.


# V. ğŸ§  Visibility â€“ Má»‘i hiá»ƒm há»a vÃ´ hÃ¬nh 

class Shared {
    boolean flag = false;

    void writer() {
        flag = true;
    }

    void reader() {
        while (!flag) {
            // loop mÃ£i mÃ£i?
        }
    }
}

	KhÃ´ng cÃ³ volatile, reader() cÃ³ thá»ƒ khÃ´ng bao giá» tháº¥y flag = true, vÃ¬ thread cÃ³ thá»ƒ dÃ¹ng giÃ¡ trá»‹ cached tá»« CPU register.
	
	
# 	VI. ğŸ”„ Thread Lifecycle (VÃ²ng Ä‘á»i thread)
	
| Tráº¡ng thÃ¡i     | Ã nghÄ©a                    |
| -------------- | -------------------------- |
| NEW            | Thread má»›i Ä‘Æ°á»£c táº¡o        |
| RUNNABLE       | ÄÆ°á»£c lÃªn lá»‹ch bá»Ÿi JVM      |
| BLOCKED        | Äang chá» lock (monitor)    |
| WAITING        | Chá» signal tá»« thread khÃ¡c  |
| TIMED\_WAITING | Chá» trong thá»i gian cá»¥ thá»ƒ |
| TERMINATED     | Káº¿t thÃºc                   |
	
	Báº¡n cáº§n biáº¿t tráº¡ng thÃ¡i Ä‘á»ƒ debug thread dump, tune performance, trÃ¡nh deadlock.

	
# VII. ğŸ“¦ CÃ¡c cÃ¡ch Ä‘áº£m báº£o memory visibility	
	
	
| CÃ¡ch           | Giáº£i thÃ­ch                                                     |
| -------------- | -------------------------------------------------------------- |
| `synchronized` | Lock Ä‘áº£m báº£o atomicity, visibility, ordering                   |
| `volatile`     | Chá»‰ visibility & ordering, khÃ´ng atomic                        |
| `Atomic*`      | CAS-based atomic operation                                     |
| `final`        | Immutable Ä‘áº£m báº£o thread-safe bá»Ÿi construction visibility rule |
	
#	VIII. âš ï¸ CÃ¡c lá»—i phá»• biáº¿n	
	
	- Race Condition: nhiá»u thread cÃ¹ng Ä‘á»c/ghi dá»¯ liá»‡u mÃ  khÃ´ng cÃ³ Ä‘á»“ng bá»™ â†’ káº¿t quáº£ khÃ´ng lÆ°á»ng trÆ°á»›c.
	- Stale Data: thread Ä‘á»c dá»¯ liá»‡u cÅ© vÃ¬ khÃ´ng cÃ³ Ä‘á»“ng bá»™.
	- Memory Visibility Bug: thread khÃ´ng tháº¥y thay Ä‘á»•i tá»« thread khÃ¡c.
	- Out-of-Order Execution: káº¿t quáº£ sai dÃ¹ code Ä‘Ãºng.	
	
	
# IX. âœï¸ Kinh nghiá»‡m thá»±c chiáº¿n

| Kinh nghiá»‡m                                 | Giáº£i thÃ­ch                                                   |
| ------------------------------------------- | ------------------------------------------------------------ |
| KhÃ´ng dÃ¹ng `volatile` cho logic phá»©c táº¡p    | `volatile` khÃ´ng Ä‘áº£m báº£o atomic hoáº·c Ä‘á»“ng bá»™ chuá»—i hÃ nh Ä‘á»™ng |
| Äá»c tá»« nhiá»u thread â†’ cáº§n Ä‘á»“ng bá»™           | DÃ¹ khÃ´ng ghi cÅ©ng cÃ³ thá»ƒ sai náº¿u cache khÃ´ng Ä‘á»“ng bá»™         |
| Immutable class lÃ  vÅ© khÃ­ máº¡nh              | `final`, `constructor init` an toÃ n vá»›i Ä‘a luá»“ng             |
| Äá»«ng tin thá»© tá»± code khi debug bug Ä‘a luá»“ng | Pháº£i nhÃ¬n báº±ng con máº¯t cá»§a CPU vÃ  JMM                        |



# volatile
	 lÃ  má»™t tá»« khÃ³a dÃ¹ng Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng má»i thread luÃ´n Ä‘á»c giÃ¡ trá»‹ má»›i nháº¥t cá»§a biáº¿n tá»« bá»™ nhá»› chÃ­nh (main memory), thay vÃ¬ tá»« cache riÃªng cá»§a thread.

	## ğŸš© Khi nÃ o cáº§n volatile? 
		Khi nhiá»u thread truy cáº­p má»™t biáº¿n dÃ¹ng Ä‘á»ƒ kiá»ƒm tra tráº¡ng thÃ¡i (flag, signal) mÃ :

		CÃ³ 1 thread ghi,
		CÃ³ n thread Ä‘á»c,
		VÃ  khÃ´ng cáº§n Ä‘á»“ng bá»™ nhiá»u thao tÃ¡c liÃªn tiáº¿p
		
	## ğŸ§  TÃ³m gá»n:
	
	
| Äiá»u kiá»‡n      | `volatile` Ä‘áº£m báº£o                               |
| -------------- | ------------------------------------------------ |
| **Visibility** | âœ… CÃ³: Má»i thread luÃ´n tháº¥y giÃ¡ trá»‹ má»›i nháº¥t      |
| **Atomicity**  | âŒ KhÃ´ng: KhÃ´ng Ä‘áº£m báº£o cáº­p nháº­t nguyÃªn khá»‘i      |
| **Ordering**   | âœ… CÃ³: NgÄƒn reorder lÃ m sai thá»© tá»± logic Ä‘Æ¡n giáº£n |
	
	
	## â— KhÃ´ng nÃªn dÃ¹ng volatile náº¿u:
	
		Báº¡n cáº§n cáº­p nháº­t nhiá»u biáº¿n cÃ¹ng lÃºc.
		Báº¡n cáº§n tÄƒng/giáº£m (++/--) â†’ khÃ´ng atomic.
		Báº¡n cáº§n logic kiá»ƒm tra rá»“i hÃ nh Ä‘á»™ng â†’ dÃ¹ng synchronized hoáº·c Atomic*.	
			
	
	
	
	## ğŸ’¡ Ghi nhá»›:
		DÃ¹ng volatile cho â€œbiáº¿n tráº¡ng thÃ¡i Ä‘Æ¡nâ€ khi cáº§n Ä‘áº£m báº£o má»i thread Ä‘á»u tháº¥y Ä‘Ãºng giÃ¡ trá»‹ hiá»‡n táº¡i. KhÃ´ng dÃ¹ng cho thao tÃ¡c phá»©c táº¡p.
	

</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>