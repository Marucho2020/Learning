<html><head><title>Lesson 216 == Policy DSL (Domain-Specific Language for Resilience) ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 216 -- Policy DSL (Domain-Specific Language for Resilience) -//</h1><pre>
X√¢y DSL thu·∫ßn h√†m ƒë·ªÉ m√¥ t·∫£ retry / timeout / circuit breaker / fallback‚Ä¶ m√† kh√¥ng d·ª±a v√†o framework.


# 1. V·∫§N ƒê·ªÄ


C√°c h·ªá th·ªëng enterprise hay d·ª±a v√†o:
	Resilience4j
	Spring Retry
	Hystrix (ƒë√£ ch·∫øt)
	Annotation magic @Retryable, @CircuitBreaker
	

Nh∆∞·ª£c ƒëi·ªÉm:

	·∫®n logic ‚Üí kh√≥ ki·ªÉm so√°t
	Kh√¥ng test ƒë∆°n v·ªã t·ª´ng policy
	Coupling framework
	Kh√¥ng minh b·∫°ch khi debugging
	Kh√¥ng c·∫•u h√¨nh ƒë∆∞·ª£c d·∫°ng code-as-policy
	
	Senior c·∫ßn t√°ch resilience th√†nh domain model + functional pipeline.





# 2. M·ª§C TI√äU (R·∫•t r√µ r√†ng)

	Ta mu·ªën:

Policy
   .retry(3)
   .timeout(Duration.ofSeconds(2))
   .circuitBreaker(5)
   .apply(apiCall);

T·∫•t c·∫£ ch·ªâ l√† pure value + pure function.
Kh√¥ng annotation, kh√¥ng AOP.



# 3. DOMAIN MODEL ‚Äî C·ªêT L√ïI DSL

	X√¢y c√°c policy th√†nh ‚ÄúOBJECT b·∫•t bi·∫øn‚Äù bi·ªÉu di·ªÖn c·∫•u h√¨nh, kh√¥ng th·ª±c thi ngay.

public sealed interface Policy {
    <T> Supplier<T> apply(Supplier<T> fn);

    static Retry retry(int times) { return new Retry(times); }
    static Timeout timeout(Duration d) { return new Timeout(d); }
    static CircuitBreaker circuitBreaker(int threshold) { return new CircuitBreaker(threshold); }
}


	## M·ªôt policy c·ª• th·ªÉ, v√≠ d·ª• Retry: 

public record Retry(int times) implements Policy {

    @Override
    public <T> Supplier<T> apply(Supplier<T> fn) {
        return () -> {
            int attempts = 0;
            while (true) {
                try {
                    return fn.get();
                } catch (Exception ex) {
                    attempts++;
                    if (attempts > times) throw ex;
                }
            }
        };
    }
}


apply tr·∫£ v·ªÅ m·ªôt Supplier m·ªõi, kh√¥ng th·ª±c thi ngay.
Pure function: input = function, output = function.



# 4. PIPELINE ‚Äî COMPOSE C√ÅC POLICY

	##C·∫ßn m·ªôt composite ƒë·ªÉ gh√©p nhi·ªÅu policy l·∫°i:


public record Composite(Policy p1, Policy p2) implements Policy {

    @Override
    public <T> Supplier<T> apply(Supplier<T> fn) {
        return p1.apply(p2.apply(fn));
    }
}


	##T·∫°o DSL chain:

public static Policy compose(Policy... ps) {
    return Arrays.stream(ps)
        .reduce((a, b) -> new Composite(a, b))
        .orElseThrow();
}




	## S·ª≠ d·ª•ng: 
	
	
	var policy = compose(
        Policy.retry(3),
        Policy.timeout(Duration.ofSeconds(2)),
        Policy.circuitBreaker(5)
);

var safeApi = policy.apply(apiCall);

var result = safeApi.get();

	
	‚û°Ô∏è ƒê√¢y ch√≠nh l√† pipeline functional ki·ªÉu middleware, th·ª© senior ph·∫£i n·∫Øm.
	
	
#5. TIMEOUT POLICY (thu·∫ßn h√†m nh∆∞ng c√≥ side-effect ƒë∆∞·ª£c c√¥ l·∫≠p)

public record Timeout(Duration duration) implements Policy {

    @Override
    public <T> Supplier<T> apply(Supplier<T> fn) {
        return () -> {
            ExecutorService es = Executors.newSingleThreadExecutor();
            Future<T> f = es.submit(fn::get);
            try {
                return f.get(duration.toMillis(), TimeUnit.MILLISECONDS);
            } finally {
                es.shutdown();
            }
        };
    }
}

	Ta c√°ch ly state/side-effect trong policy, kh√¥ng l√†m b·∫©n h√†m cu·ªôc g·ªçi g·ªëc.


# 6. CIRCUIT BREAKER POLICY (domain model chu·∫©n)

	Senior ph·∫£i hi·ªÉu: circuit breaker c√≥ 3 tr·∫°ng th√°i: Closed ‚Üí Open ‚Üí Half-Open.
	
	## Domain model:

public enum State { CLOSED, OPEN, HALF_OPEN }

public record CircuitBreaker(int threshold, AtomicInteger fails, AtomicReference<State> state)
        implements Policy {

    public CircuitBreaker(int threshold) {
        this(threshold, new AtomicInteger(0), new AtomicReference<>(State.CLOSED));
    }

    @Override
    public <T> Supplier<T> apply(Supplier<T> fn) {
        return () -> {
            if (state.get() == State.OPEN)
                throw new RuntimeException("Circuit OPEN");

            try {
                T res = fn.get();
                fails.set(0);
                return res;
            } catch (Exception ex) {
                if (fails.incrementAndGet() >= threshold)
                    state.set(State.OPEN);
                throw ex;
            }
        };
    }
}

D√π c√≥ tr·∫°ng th√°i, ta v·∫´n gi·ªØ purity c·ªßa pipeline:
Policy kh√¥ng ph√° logic nghi·ªáp v·ª•.






# 7. DSL TUY·ªÜT ƒê·∫∏P D√ÄNH CHO ENTERPRISE

	ƒêi·ªÅu khi·∫øn enterprise th√≠ch ki·ªÉu n√†y:
		Config file (GitOps):

policy:
  retry: 4
  timeout: 1500ms
  circuitBreaker:
    fails: 5

	Functional parser:

var policy = PolicyParser.fromConfig(configNode);



	## Parser ch·ªâ l√†: 

Policy composeFromYaml(Node n) {
    List<Policy> ps = new ArrayList<>();
    if (n.has("retry")) ps.add(Policy.retry(n.getInt("retry")));
    if (n.has("timeout")) ps.add(Policy.timeout(n.getDuration("timeout")));
    if (n.has("circuitBreaker"))
        ps.add(Policy.circuitBreaker(n.get("circuitBreaker.fails")));
    return compose(ps.toArray(Policy[]::new));
}

	‚û°Ô∏è GitOps + Functional DSL = pipeline resilience kh√¥ng d√≠nh framework, deploy ·ªü b·∫•t k·ª≥ runtime n√†o.


# 8. T·∫¶M NH√åN XA ‚Äî T·∫†I SAO C√ÅCH N√ÄY TH·∫ÆNG AOP/ANNOTATION?


AOP, annotations:

	·∫©n logic
	ch·ªìng l·ªõp callback
	kh√≥ test
	kh√≥ debug
	coupled v√†o Spring

DSL functional:

	pure, predictable
	minh b·∫°ch t·ª´ng policy
	ƒë·ªçc code l√† th·∫•y r√µ pipeline
	test t·ª´ng block ƒë∆°n gi·∫£n
	ch·∫°y ƒë∆∞·ª£c trong b·∫•t k·ª≥ environment (Lambda, Quarkus, Micronaut, CLI app‚Ä¶)
	
	b·∫≠t/t·∫Øt policy runtime d·ªÖ d√†ng

ƒê√¢y l√† c√°ch c√°c h·ªá th·ªëng hi·ªán ƒë·∫°i (Shopify, Twilio, Stripe) xoay sang:
Resilience = pipeline thu·∫ßn h√†m + DSL b·∫•t bi·∫øn.



# 9. T·ªîNG K·∫æT C·ªêT L√ïI

	B·∫°n ch·ªâ c·∫ßn nh·ªõ 3 √Ω:
		Policy l√† data model b·∫•t bi·∫øn m√¥ t·∫£ resilience.
		M·ªói policy nh·∫≠n fn ‚Üí tr·∫£ fn' (decorator thu·∫ßn h√†m).
		DSL ch√≠nh l√† k·∫øt h·ª£p policy th√†nh pipeline.
	C·∫•u tr√∫c n√†y n√¢ng c·∫•p h·ªá th·ªëng t·ª´ ‚Äúd·ªÖ v·ª°‚Äù l√™n ‚Äúƒë√°ng tin c·∫≠y c√≥ ki·ªÉm so√°t‚Äù.




















</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>