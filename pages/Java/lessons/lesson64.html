<html><head><title>Lesson 64 == SingleThreadModel Interface ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 64 -- SingleThreadModel Interface -//</h1><pre>	
# KhÃ¡i niá»‡m 
	SingleThreadModel lÃ  má»™t interface cÅ© trong Java Servlet API giÃºp Ä‘áº£m báº£o ráº±ng má»—i request Ä‘áº¿n má»™t servlet sáº½ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi má»™t intance riÃªng biá»‡t cá»§a servlet Ä‘Ã³. 
		
		ğŸ’¡ TÃ³m gá»n: 
			- DÃ¹ng trong servlet Ä‘á»ƒ trÃ¡nh váº¥n Ä‘á» Ä‘á»“ng bá»™ hÃ³a (thread safety)
			- Má»—i request Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi má»™t instance servlet riÃªng biá»‡t 
			- ÄÃ£ bá»‹ deprecated tá»« Servlet 2.4 vÃ  loáº¡i bá» tá»« Servlet 2.5 trá»Ÿ Ä‘i 
			
			
# CÃ¡ch hoáº¡t Ä‘á»™ng  
				
	Khi má»™t servlet implement SingleThreadModel, server cÃ³ hai cÃ¡ch xá»­ lÃ½ request:

	Táº¡o má»™t instance servlet má»›i cho má»—i request.
	DÃ¹ng má»™t pool servlet instance Ä‘á»ƒ xá»­ lÃ½ nhiá»u request song song.
	ğŸ’¡ LÃ½ do: Servlet báº£n cháº¥t lÃ  Ä‘a luá»“ng (multi-threaded), náº¿u nhiá»u request Ä‘áº¿n cÃ¹ng lÃºc, cÃ³ thá»ƒ gÃ¢y ra váº¥n Ä‘á» race condition náº¿u servlet cÃ³ biáº¿n instance chung


	## ğŸ“Œ VÃ­ dá»¥: Servlet khÃ´ng thread-safe 
		@WebServlet("/unsafe")
		public class UnsafeServlet extends HttpServlet {
			private int counter = 0;  // Biáº¿n instance dÃ¹ng chung
		
			protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
				counter++;  // CÃ³ thá»ƒ bá»‹ ghi Ä‘Ã¨ bá»Ÿi nhiá»u luá»“ng khÃ¡c nhau!
				resp.getWriter().println("Counter: " + counter);
			}
		}
		
			âš  Lá»—i cÃ³ thá»ƒ xáº£y ra: 
			Náº¿u 2 request cháº¡y song song, biáº¿n counter cÃ³ thá»ƒ bá»‹ ghi Ä‘Ã¨ khÃ´ng mong muá»‘n, dáº«n Ä‘áº¿n bug dá»¯ liá»‡u.
			
			
			
	## 		ğŸ“Œ DÃ¹ng SingleThreadModel Ä‘á»ƒ trÃ¡nh lá»—i trÃªn 
			@WebServlet("/safe")
			public class SafeServlet extends HttpServlet implements SingleThreadModel {
				private int counter = 0;  // Biáº¿n instance khÃ´ng bá»‹ truy cáº­p Ä‘á»“ng thá»i
			
				protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
					counter++;  
					resp.getWriter().println("Counter: " + counter);
				}
			}

			ğŸš€ LÃºc nÃ y, má»—i request cÃ³ má»™t instance servlet riÃªng, trÃ¡nh Ä‘Æ°á»£c lá»—i Ä‘á»“ng bá»™ hÃ³a.
			
			
# 		3. Táº¡i sao SingleThreadModel bá»‹ loáº¡i bá»?	

			ğŸš¨ Háº¡n cháº¿ lá»›n cá»§a SingleThreadModel:
			âŒ NhÆ°á»£c Ä‘iá»ƒm										âš¡ Giáº£i thÃ­ch
			Tá»‘n bá»™ nhá»›											VÃ¬ má»—i request cÃ³ má»™t servlet riÃªng, nÃªn server pháº£i quáº£n lÃ½ nhiá»u instance servlet.
			KhÃ´ng thá»±c sá»± an toÃ n								Náº¿u servlet cÃ³ biáº¿n static hoáº·c dÃ¹ng shared resource (file, DB), thÃ¬ váº«n bá»‹ váº¥n Ä‘á» Ä‘á»“ng bá»™ hÃ³a.
			KhÃ´ng phÃ¹ há»£p vá»›i há»‡ thá»‘ng lá»›n						Vá»›i há»‡ thá»‘ng nhiá»u request, viá»‡c táº¡o nhiá»u instance servlet sáº½ lÃ m giáº£m hiá»‡u suáº¥t.
			
			ğŸ’¡ Thay vÃ o Ä‘Ã³, nÃªn dÃ¹ng synchronized, ThreadLocal hoáº·c Stateless Servlet.
			
			
			
# 4. CÃ¡ch thay tháº¿ SingleThreadModel 
				
			
	## ğŸ”¹ CÃ¡ch 1: DÃ¹ng synchronized (KhÃ´ng khuyáº¿n khÃ­ch) 
		Äáº·t synchronized vÃ o doGet() hoáº·c doPost(), nhÆ°ng lÃ m giáº£m hiá»‡u suáº¥t.
				@WebServlet("/sync")
				public class SyncServlet extends HttpServlet {
					private int counter = 0;
				
					protected synchronized void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
						counter++;
						resp.getWriter().println("Counter: " + counter);
					}
				}

					âš  NhÆ°á»£c Ä‘iá»ƒm:
		
					Táº¥t cáº£ request pháº£i chá» nhau, giáº£m tá»‘c Ä‘á»™ xá»­ lÃ½.
			
			
			
			
	## 	ğŸ”¹ CÃ¡ch 2: DÃ¹ng ThreadLocal Ä‘á»ƒ táº¡o biáº¿n riÃªng cho tá»«ng request	
	
	
			@WebServlet("/threadlocal")
			public class ThreadLocalServlet extends HttpServlet {
				private ThreadLocal<Integer> counter = ThreadLocal.withInitial(() -> 0);
			
				protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
					counter.set(counter.get() + 1);
					resp.getWriter().println("Counter: " + counter.get());
				}
			}
	
			ğŸš€ Æ¯u Ä‘iá»ƒm:
			KhÃ´ng cáº§n Ä‘á»“ng bá»™ hÃ³a.
			Má»—i request cÃ³ má»™t biáº¿n riÃªng, trÃ¡nh lá»—i race condition.	ğŸš€ Æ¯u Ä‘iá»ƒm:
			
			KhÃ´ng cáº§n Ä‘á»“ng bá»™ hÃ³a.
			Má»—i request cÃ³ má»™t biáº¿n riÃªng, trÃ¡nh lá»—i race condition.
			
			
			
	## 	ğŸ”¹ CÃ¡ch 3: DÃ¹ng Stateless Servlet (CÃ¡ch tá»‘t nháº¥t)
			
			KhÃ´ng dÃ¹ng biáº¿n instance Ä‘á»ƒ trÃ¡nh váº¥n Ä‘á» Ä‘á»“ng bá»™ hÃ³a.
			ğŸ“Œ VÃ­ dá»¥: Servlet Stateless
			
			@WebServlet("/stateless")
			public class StatelessServlet extends HttpServlet {
				protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
					int counter = Integer.parseInt(req.getParameter("count")); // KhÃ´ng dÃ¹ng biáº¿n instance
					resp.getWriter().println("Counter: " + (counter + 1));
				}
			}

			âœ… Lá»£i Ã­ch:

Servlet khÃ´ng giá»¯ tráº¡ng thÃ¡i, má»i request Ä‘á»™c láº­p vá»›i nhau.
KhÃ´ng lo láº¯ng vá» Ä‘á»“ng bá»™ hÃ³a hay bá»™ nhá»›.
			


</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>