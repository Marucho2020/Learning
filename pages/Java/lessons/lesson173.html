<html><head><title>Lesson 173 == CountDownLatch ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 173 -- CountDownLatch -//</h1><pre>
# üîπ CountDownLatch ‚Äì ƒê·ªìng b·ªô 1 chi·ªÅu, ƒë·∫øm ng∆∞·ª£c ƒë·∫øn 0

	- CountDownLatch kh·ªüi t·∫°o v·ªõi m·ªôt s·ªë nguy√™n N.
	- Nhi·ªÅu thread c√≥ th·ªÉ g·ªçi await() ‚Üí t·∫•t c·∫£ b·ªã block cho ƒë·∫øn khi counter = 0.
	- C√°c thread kh√°c g·ªçi countDown() ‚Üí gi·∫£m counter.
	- Khi counter = 0 ‚Üí t·∫•t c·∫£ thread ƒëang ch·ªù ƒë∆∞·ª£c unpark.
	
	üëâ M·ªôt latch ch·ªâ d√πng ƒë∆∞·ª£c m·ªôt l·∫ßn ‚Üí kh√¥ng reset (kh√°c CyclicBarrier).


# 2. C∆° ch·∫ø ho·∫°t ƒë·ªông (under the hood)


	- Implement d·ª±a tr√™n AQS.
	- State = s·ªë ƒë·∫øm c√≤n l·∫°i (count).
	- await() ‚Üí CAS state, n·∫øu state > 0 th√¨ thread v√†o queue (park).
	- countDown() ‚Üí CAS decrement. Khi state == 0 ‚Üí release t·∫•t c·∫£ thread trong queue.
	- Kh√¥ng reentrant, kh√¥ng reset.



# 3. Use cases th·ª±c t·∫ø

	## 3.1. Ch·ªù nhi·ªÅu worker ho√†n t·∫•t 
		V√≠ d·ª•: Master thread submit 10 worker tasks, sau ƒë√≥ ch·ªù t·∫•t c·∫£ xong:	

CountDownLatch latch = new CountDownLatch(10);

for (int i = 0; i < 10; i++) {
    executor.submit(() -> {
        try {
            // do work
        } finally {
            latch.countDown(); // b√°o hi·ªáu ho√†n t·∫•t
        }
    });
}

latch.await(); // master ch·ªù



	## 3.2. One-time initialization gate

		B·∫°n c√≥ nhi·ªÅu thread worker, nh∆∞ng t·∫•t c·∫£ ph·∫£i ch·ªù m·ªôt service init xong.
		D√πng CountDownLatch(1) ‚Üí gi·ªëng nh∆∞ m·ªôt ‚Äúc·ª≠a ch·∫∑n 1 chi·ªÅu‚Äù:

CountDownLatch startGate = new CountDownLatch(1);

// workers
for (...) {
    executor.submit(() -> {
        startGate.await(); // ch·ªù signal
        // start work
    });
}

// khi ready
startGate.countDown(); // t·∫•t c·∫£ worker ƒë·ªìng lo·∫°t ch·∫°y



	##3.3. Benchmarking / performance test
	
		Ch·∫∑n t·∫•t c·∫£ threads t·∫°i await() r·ªìi m·ªü latch ‚Üí ƒëo hi·ªáu nƒÉng khi t·∫•t c·∫£ c√πng start.


# 4. ∆Øu ƒëi·ªÉm vs Nh∆∞·ª£c ƒëi·ªÉm

‚úÖ ∆Øu ƒëi·ªÉm
	C·ª±c k·ª≥ ƒë∆°n gi·∫£n, d·ªÖ hi·ªÉu, √≠t trap.
	Th∆∞·ªùng d√πng cho m·ªôt l·∫ßn ƒë·ªìng b·ªô (shutdown, init, test).

‚ö†Ô∏è Nh∆∞·ª£c ƒëi·ªÉm

	Kh√¥ng reset ƒë∆∞·ª£c ‚Üí n·∫øu mu·ªën d√πng nhi·ªÅu l·∫ßn ph·∫£i t·∫°o latch m·ªõi.
	Kh√¥ng linh ho·∫°t khi s·ªë l∆∞·ª£ng thread dynamic (d√πng Phaser t·ªët h∆°n).
	D·ªÖ b·ªã await treo m√£i n·∫øu c√≥ thread n√†o kh√¥ng countDown (bug logic).


# 5. So s√°nh v·ªõi c√°c c∆° ch·∫ø kh√°c

| C√¥ng c·ª•          | ƒê·∫∑c ƒëi·ªÉm                                | Khi n√†o d√πng                                                   |
| ---------------- | --------------------------------------- | -------------------------------------------------------------- |
| `CountDownLatch` | ƒê·∫øm ng∆∞·ª£c m·ªôt chi·ªÅu, kh√¥ng reset        | Khi c·∫ßn **ch·ªù m·ªôt nh√≥m job xong** ho·∫∑c **m·ªôt event duy nh·∫•t**  |
| `CyclicBarrier`  | Barrier 2 chi·ªÅu, reset ƒë∆∞·ª£c             | Khi nhi·ªÅu thread c·∫ßn **g·∫∑p nhau nhi·ªÅu l·∫ßn** (iteration phases) |
| `Phaser`         | Nhi·ªÅu phase, dynamic thread ƒëƒÉng k√Ω     | Khi s·ªë l∆∞·ª£ng thread **thay ƒë·ªïi**, c·∫ßn ƒë·ªìng b·ªô nhi·ªÅu v√≤ng       |
| `Semaphore`      | C·∫•p ph√°t permit, kh√¥ng reset count auto | Khi c·∫ßn **gi·ªõi h·∫°n concurrency** thay v√¨ ch·ªù nh√≥m              |



# 6. Senior-level pitfalls & best practices

	## Qu√™n g·ªçi countDown()
		
		R·∫•t hay g·∫∑p ‚Üí thread ch√≠nh treo m√£i ·ªü await().
		Gi·∫£i ph√°p: lu√¥n g·ªçi trong finally:

	## Sai m√¥ h√¨nh d√πng CountDownLatch(1) 
	
		L√∫c n√†y n√≥ ho·∫°t ƒë·ªông nh∆∞ m·ªôt binary latch.
		N·∫øu b·∫°n c·∫ßn th·ª© c√≥ th·ªÉ reset ‚Üí chuy·ªÉn sang CyclicBarrier ho·∫∑c Phaser.


	## Kh√¥ng d√πng cho thread pool long-lived 
		N·∫øu b·∫°n mu·ªën ƒë·ªìng b·ªô ƒë·ªãnh k·ª≥ (v√≠ d·ª• ch·ªù batch N task trong executor) ‚Üí latch kh√¥ng ƒë·ªß ‚Üí b·∫°n ph·∫£i t·∫°o latch m·ªõi m·ªói l·∫ßn.	


	## Timeout vs Deadlock detection 
		Lu√¥n n√™n d√πng await(timeout) thay v√¨ await() v√¥ h·∫°n, tr·ª´ khi 100% ch·∫Øc ch·∫Øn logic ƒë√∫ng.

if (!latch.await(10, TimeUnit.SECONDS)) {
    throw new TimeoutException("Workers too slow or deadlocked");
}



# 7. Mindset senior

	- CountDownLatch = latch 1 l·∫ßn (fire once).
	- N√≥ kh√¥ng ph·∫£i tool ƒë·ªÉ ƒë·ªìng b·ªô li√™n t·ª•c.
	- R·∫•t h·ªØu √≠ch trong testing, bootstrap, one-off synchronization.
	- Trong h·ªá th·ªëng l·ªõn, b·∫°n s·∫Ω th·∫•y latch ƒë∆∞·ª£c d√πng nh∆∞ sync primitive, sau ƒë√≥ b·ªçc trong abstraction cao h∆°n (v√≠ d·ª• JobCoordinator).

	CountDownLatch l√† s√∫ng b·∫Øn 1 l·∫ßn trong kho v≈© kh√≠ concurrency. N√≥ ƒë∆°n gi·∫£n, m·∫°nh khi d√πng ƒë√∫ng ch·ªó, nh∆∞ng n·∫øu b·∫°n c·ªë d√πng n√≥ nh∆∞ barrier ƒëa pha th√¨ s·∫Ω t·ª± b·∫Øn v√†o ch√¢n.


</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>