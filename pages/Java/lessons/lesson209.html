<html><head><title>Lesson 209 == Composable Resilience Layers ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 209 -- Composable Resilience Layers -//</h1><pre>

# üîç 1. V·∫•n ƒë·ªÅ c·∫ßn gi·∫£i quy·∫øt
	Trong th·ª±c t·∫ø, khi b·∫°n t√≠ch h·ª£p API (Payment, Email, Billing, 3rd party), b·∫°n s·∫Ω √°p d·ª•ng nhi·ªÅu c∆° ch·∫ø resilience ƒë·ªìng th·ªùi:

		Retry ƒë·ªÉ t·ª± th·ª≠ l·∫°i khi l·ªói t·∫°m th·ªùi.
		
		Timeout ƒë·ªÉ tr√°nh request treo v√¥ h·∫°n.
		
		Circuit Breaker ƒë·ªÉ ng·∫Øt s·ªõm khi downstream ‚Äúch·∫øt‚Äù.
		
		Fallback ƒë·ªÉ x·ª≠ l√Ω graceful degrade.
		
	Th√¥ng th∆∞·ªùng, v·ªõi Spring hay Resilience4j, ta c√≥ ki·ªÉu:

@Retryable
@CircuitBreaker
@TimeLimiter
public String callApi() { ... }

	Nh∆∞ng ƒëi·ªÅu n√†y r·∫•t kh√≥ ki·ªÉm so√°t, v√¨:

		Logic b·ªã r·∫£i ·ªü annotation v√† AOP proxy.
		
		Th·ª© t·ª± th·ª±c thi kh√¥ng r√µ.
		
		Kh√¥ng th·ªÉ test unit d·ªÖ d√†ng.
		
	Functional approach cho ph√©p ta compose r√µ r√†ng to√†n b·ªô resilience pipeline.		



# ‚öôÔ∏è 2. Functional Composition: C√°ch gh√©p c√°c Resilience Layer
	Gi·∫£ s·ª≠ ta ƒë√£ c√≥ ba HOF (higher-order function):

Function<Supplier<CompletableFuture<String>>, Supplier<CompletableFuture<String>>> withRetry(int n)
Function<Supplier<CompletableFuture<String>>, Supplier<CompletableFuture<String>>> withTimeout(Duration d)
Function<Supplier<CompletableFuture<String>>, Supplier<CompletableFuture<String>>> withCircuitBreaker(CircuitBreaker cb)

	‚Üí M·ªói c√°i nh·∫≠n v√†o m·ªôt function, v√† tr·∫£ ra m·ªôt function ƒë∆∞·ª£c b·ªçc th√™m logic resilience.


	B√¢y gi·ªù, ta compose ch√∫ng l·∫°i:

Supplier<CompletableFuture<String>> resilientCall =
    withRetry(3)
    .andThen(withTimeout(Duration.ofSeconds(2)))
    .andThen(withCircuitBreaker(cb))
    .apply(() -> callExternalApi());

	C√∫ ph√°p .andThen() ·ªü ƒë√¢y l√† function chaining thu·∫ßn Java ‚Äî m·ªói t·∫ßng decorator b·ªçc logic resilience quanh t·∫ßng b√™n trong.




# üß© 3. Pure Decorator Pattern

	Kh√¥ng c√≤n annotation hay magic ‚Äî ƒë√¢y l√† decorator pattern thu·∫ßn functional:

		- M·ªói ‚Äúwrapper‚Äù ch·ªâ nh·∫≠n v√† tr·∫£ function.
		- Kh√¥ng thay ƒë·ªïi function g·ªëc.
		- Kh√¥ng c·∫ßn bean, proxy, AOP.

	## V√≠ d·ª• minh h·ªça ƒë∆°n gi·∫£n: 

public static <T> Supplier<T> withRetry(Supplier<T> fn, int n) {
    return () -> {
        int attempts = 0;
        while (true) {
            try {
                return fn.get();
            } catch (Exception e) {
                if (++attempts >= n) throw e;
            }
        }
    };
}

public static <T> Supplier<T> withTimeout(Supplier<T> fn, Duration timeout) {
    return () -> CompletableFuture.supplyAsync(fn::get)
        .orTimeout(timeout.toMillis(), TimeUnit.MILLISECONDS)
        .join();
}


	V√† cu·ªëi c√πng:
Supplier<String> call = () -> externalService.call();
Supplier<String> resilient = withRetry(withTimeout(call, Duration.ofSeconds(2)), 3);
	T·∫•t c·∫£ c·∫•u tr√∫c v√† k·∫øt h·ª£p b·∫±ng function.



# üí° 4. ‚ÄúPolicy Pipeline‚Äù ‚Äî ƒê·ªãnh nghƒ©a b·∫±ng DSL Functional

	T∆∞ duy xa h∆°n ‚Äî ta c√≥ th·ªÉ t·∫°o DSL resilience policy ƒë·ªÉ ƒë·ªãnh nghƒ©a ch√≠nh s√°ch.

ResiliencePolicy policy = ResiliencePolicy.builder()
    .retry(3)
    .timeout(Duration.ofSeconds(2))
    .circuitBreaker(cb)
    .fallback(ex -> "fallback-response")
    .build();



Supplier<CompletableFuture<String>> safeCall = policy.apply(() -> callApi());


Khi ƒë√≥, ta ƒë√£ c√≥ th·ªÉ:
	Serialize policy sang JSON ho·∫∑c YAML ƒë·ªÉ qu·∫£n l√Ω GitOps.
	Inject v√†o service qua Spring Cloud Config.
	Thay ƒë·ªïi ch√≠nh s√°ch resilience m√† kh√¥ng c·∫ßn redeploy code.



# üè¢ 5. ·ª®ng d·ª•ng th·ª±c t·∫ø trong Microservice Gateway

Trong enterprise system (v√≠ d·ª• API Gateway ho·∫∑c Orchestrator):	

	- Ta c·∫ßn nhi·ªÅu layer resilience cho m·ªói endpoint.
	- V√≠ d·ª•: Payment API c√≥ retry 5 l·∫ßn, timeout 1s; Email API retry 2 l·∫ßn, timeout 5s, circuit breaker ri√™ng.

	√Åp d·ª•ng pattern n√†y:

var paymentPolicy = withRetry(5)
    .andThen(withTimeout(Duration.ofSeconds(1)))
    .andThen(withCircuitBreaker(paymentBreaker));

var emailPolicy = withRetry(2)
    .andThen(withTimeout(Duration.ofSeconds(5)))
    .andThen(withCircuitBreaker(emailBreaker));

paymentPolicy.apply(() -> paymentService.call());
emailPolicy.apply(() -> emailService.send());



Resilient pipeline t∆∞·ªùng minh.
Kh√¥ng ph·ª• thu·ªôc framework.
C√≥ th·ªÉ test, log, v√† m·ªü r·ªông d·ªÖ d√†ng.



# üß† T·ªïng k·∫øt tri·∫øt l√Ω b√†i n√†y

| Th√†nh ph·∫ßn      | T∆∞ duy imperative truy·ªÅn th·ªëng | T∆∞ duy functional resilience   |
| --------------- | ------------------------------ | ------------------------------ |
| Retry           | @Retryable                     | `withRetry(fn, n)`             |
| Timeout         | `Future.get(timeout)`          | `withTimeout(fn, d)`           |
| Circuit Breaker | `Resilience4j annotation`      | `withCircuitBreaker(fn)`       |
| Composition     | Annotation stacking            | Function chaining `.andThen()` |
| Config          | YAML c·ªë ƒë·ªãnh                   | DSL / policy functional        |





</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>