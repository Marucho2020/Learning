<html><head><title>Lesson 214 == Functional Circuit Breaker Cluster ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 214 -- Functional Circuit Breaker Cluster -//</h1><pre>
â€œDistributed State mÃ  khÃ´ng Ä‘Ã¡nh máº¥t Functional Purityâ€


# 1ï¸âƒ£ Váº¥n Ä‘á» thá»±c sá»± cáº§n giáº£i quyáº¿t

	Circuit Breaker local trong 1 JVM thÃ¬ Ä‘Æ¡n giáº£n:

		- lá»—i 5 láº§n â†’ â€œopenâ€
		- chá» 30s â†’ â€œhalf-openâ€
		- thá»­ láº¡i 1 req â†’ náº¿u OK â†’ â€œclosedâ€
		
	NhÆ°ng khi há»‡ thá»‘ng cÃ³ 10 instance cháº¡y song song, má»—i cÃ¡i cÃ³ breaker riÃªng â†’
	â†’ Káº¿t quáº£: 10 breaker cháº¡y 10 kiá»ƒu, khÃ´ng Ä‘á»“ng bá»™, spam lÃªn downstream, phÃ¡ luÃ´n resilience.

	Do Ä‘Ã³ cáº§n cÃ³ breaker state chung toÃ n cluster.	

	## NhÆ°ng ta khÃ´ng muá»‘n: 

		lock phÃ¢n tÃ¡n phá»©c táº¡p
		state mutable everywhere
		framework magic nhÆ° Resilience4j Cluster Mode (khÃ´ng Ä‘Æ¡n giáº£n)


	## Giáº£i phÃ¡p functional: 

		táº¥t cáº£ state Ä‘Æ°á»£c â€œtÃ­nh toÃ¡n thuáº§n hÃ mâ€ â†’ cáº­p nháº­t vÃ o kho chung (Redis hoáº·c in-memory distributed).
		
		read â†’ computeNextState(currentState, event) â†’ write.
		


# 2ï¸âƒ£ DÃ¹ng AtomicStampedReference Ä‘á»ƒ giá»¯ state + version

	Trong local JVM, ta khÃ´ng bao giá» lÆ°u state báº±ng biáº¿n thÆ°á»ng.
	Ta dÃ¹ng:
		AtomicStampedReference<CircuitState>

			AtomicReference khÃ´ng Ä‘á»§ Ä‘á»ƒ trÃ¡nh ABA problem.
			Stamped giÃºp track version â†’ khi update khÃ´ng nháº§m state cÅ©.
		ÄÃ¢y chÃ­nh lÃ  cÃ¡ch trÃ¡nh race-condition mÃ  khÃ´ng cáº§n lock.

	## VÃ­ dá»¥ local state: 
	
AtomicStampedReference<CircuitState> breaker =
    new AtomicStampedReference<>(CircuitState.closed(), 0);



# 3ï¸âƒ£ Má»Ÿ rá»™ng state ra Distributed Cache (Redis / Hazelcast)
	Functional á»Ÿ Ä‘Ã¢y nghÄ©a lÃ  má»i thá»© lÃ  pure function:

		newState = transition(oldState, event)

	Chá»‰ khÃ¡c lÃ :
		oldState = Ä‘á»c tá»« Redis
		newState = ghi vÃ o Redis


	KhÃ´ng concept â€œsá»­a stateâ€.
	Chá»‰ append event â†’ derive state.

	Pseudo:

		CircuitState applyEvent(Event evt) {
			CircuitState old = redis.get("breaker-state");
			CircuitState new = transition(old, evt);
			redis.cas("breaker-state", old, new); // compare-and-set
			return new;
		}

CAS (compare-and-set) chÃ­nh lÃ  functional update versioned
â†’ khÃ´ng lock
â†’ khÃ´ng race
â†’ khÃ´ng dirty write.



# 4ï¸âƒ£ Event-based reset logic (functional, khÃ´ng imperative timer)
	Breaker â€œtá»± resetâ€ dá»±a vÃ o event, khÃ´ng cháº¡y timer áº©n.

	Event cÃ³ thá»ƒ lÃ :

		SUCCESS
		
		FAILURE
		
		TIMEOUT
		
		RESET_TIMER elapsed
		
		ADMIN_OVERRIDE
		
		DOWNSTREAM_HEALTHCHECK_PASS

	Pure function:
(nextState, sideEffects) = transition(currentState, event)

	VÃ­ dá»¥ rule:
		if state=open AND event=RESET_TIMER_EXPIRED â†’ half-open


	Functional hÆ¡n ráº¥t nhiá»u so vá»›i code imperative kiá»ƒu:
		if (System.currentMillis() > openTimestamp + waitDuration) ...
		(Ä‘Ã¢y lÃ  thá»© lÃ m há»‡ thá»‘ng dá»… lá»—i race).
	
	
# 	5ï¸âƒ£ LÃ m sao emit event RESET_TIMER_EXPIRED?
	Thay vÃ¬ scheduled task (imperative), functional approach dÃ¹ng event pump:
	
		má»—i láº§n state chuyá»ƒn sang OPEN â†’ emit event â€œopen-with-expiration-timestampâ€
		má»™t process khÃ¡c (stateless) check nhá»¯ng event nÃ y â†’ emit RESET event.	
	
	Kiá»ƒu nhÆ° CQRS:
		State storage tÃ¡ch khá»i Event logic.	
	
	
# 	6ï¸âƒ£ Functional caching â€” khÃ´ng pháº£i cache value, mÃ  cache state logic
	
	Nhiá»u ngÆ°á»i hiá»ƒu sai:
		â€œbreaker shared state = Ä‘á»ƒ cache káº¿t quáº£â€.

	Sai.
		Shared state lÃ  cache cá»§a tráº¡ng thÃ¡i breaker, khÃ´ng liÃªn quan Ä‘áº¿n caching response.

	VÃ­ dá»¥ Redis key:

breaker:payment-api â†’ {
  state: "OPEN",
  failureCount: 8,
  lastFailureAt: 173.233ms,
  version: 195
}
	Functional cluster breaker chá»‰ cáº§n key Ä‘Ã³.




# 7ï¸âƒ£ Enterprise use-case: API Gateway multi-instance

	Giáº£ sá»­ API Gateway cÃ³ 20 instance:
	Táº¥t cáº£ gá»i Ä‘áº¿n Payment Service.

	## Náº¿u Payment Service cháº¿t:
		Instance A detect failure â†’ state OPEN
		Instance B, C, D,â€¦ Ä‘á»c Redis â†’ tháº¥y OPEN â†’ ngá»«ng gá»i ngay láº­p tá»©c

	## Äiá»u nÃ y táº¡o ra:
		shock absorption (giáº£m load)
		
		fast-fail toÃ n cluster
		
		throttle khÃ´ng cáº§n lock

	Tá»©c lÃ  báº¡n Ä‘Ã£ Ä‘áº¡t Ä‘Æ°á»£c true distributed resilience.



# ğŸ§  8ï¸âƒ£ Triáº¿t lÃ½ Functional Ä‘áº±ng sau Distributed Breaker

âœ” KhÃ´ng sá»­a state, chá»‰ build state má»›i tá»« oldState + event

â†’ má»i thá»© deterministic, audit-friendly.

âœ” Shared state khÃ´ng Ä‘á»“ng nghÄ©a shared mutation

â†’ vÃ¬ báº£n cháº¥t update lÃ  CAS versioned.

âœ” KhÃ´ng cáº§n annotation, khÃ´ng cáº§n â€œmagicâ€ framework

â†’ logic resilience cÃ³ thá»ƒ test Ä‘á»™c láº­p 100%.

âœ” Logic breaker trá»Ÿ thÃ nh â€œpure state machineâ€

â†’ dá»… mÃ´ phá»ng, dá»… kiá»ƒm chá»©ng, dá»… cháº¡y trÃªn nhiá»u node.
















</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>