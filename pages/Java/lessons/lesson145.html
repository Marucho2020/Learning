<html><head><title>Lesson 145 == HandlerInterceptor ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 145 -- HandlerInterceptor -//</h1><pre># üß† 1. HandlerInterceptor l√† g√¨?
	HandlerInterceptor l√† m·ªôt interface cho ph√©p b·∫°n ch·∫∑n request tr∆∞·ªõc khi v√†o controller, sau khi controller x·ª≠ l√Ω, v√† sau khi view ƒë∆∞·ª£c render.

	‚Üí N√≥ gi·ªëng nh∆∞ 1 ‚Äúv·ªá sƒ©‚Äù ƒë·ª©ng tr∆∞·ªõc/gi·ªØa/sau controller ƒë·ªÉ can thi·ªáp t√πy √Ω.

# üî© 2. Ph∆∞∆°ng th·ª©c c·ªßa HandlerInterceptor

public interface HandlerInterceptor {

    boolean preHandle(HttpServletRequest request,
                      HttpServletResponse response,
                      Object handler) throws Exception;

    void postHandle(HttpServletRequest request,
                    HttpServletResponse response,
                    Object handler,
                    ModelAndView modelAndView) throws Exception;

    void afterCompletion(HttpServletRequest request,
                         HttpServletResponse response,
                         Object handler,
                         Exception ex) throws Exception;
}


	## üî∏ preHandle() 
		
		G·ªçi tr∆∞·ªõc khi controller x·ª≠ l√Ω
		Tr·∫£ v·ªÅ true: ti·∫øp t·ª•c chu·ªói x·ª≠ l√Ω
		Tr·∫£ v·ªÅ false: ch·∫∑n ƒë·ª©ng lu√¥n (v√≠ d·ª•: ch·∫∑n kh√¥ng login)


			üëâ Th∆∞·ªùng d√πng ƒë·ªÉ: 
			Check quy·ªÅn truy c·∫≠p (RBAC, token, session...)
			Logging, rate-limit, audit...
			Inject th√¥ng tin v√†o request (tracing info, header, etc.)


	## üî∏ postHandle() 
		
		G·ªçi sau khi controller x·ª≠ l√Ω, nh∆∞ng tr∆∞·ªõc khi view ƒë∆∞·ª£c render
		C√≥ th·ªÉ s·ª≠a ƒë·ªïi ModelAndView tr∆∞·ªõc khi hi·ªÉn th·ªã

		üëâ Th∆∞·ªùng d√πng cho:
			Th√™m d·ªØ li·ªáu m·∫∑c ƒë·ªãnh v√†o model
			G·∫Øn th√™m layout th√¥ng tin
			Logging logic sau x·ª≠ l√Ω




	## üî∏ afterCompletion() 
		G·ªçi sau khi ho√†n t·∫•t to√†n b·ªô x·ª≠ l√Ω, bao g·ªìm view ƒë√£ render
		D√π c√≥ exception c≈©ng s·∫Ω ƒë∆∞·ª£c g·ªçi

		üëâ D√πng ƒë·ªÉ:
			D·ªçn t√†i nguy√™n (close stream, DB, connection)
			Logging sau c√πng
			Theo d√µi l·ªói v√† ph√¢n t√≠ch (error tracing)

# üß† 3. Ki·∫øn tr√∫c t·ªïng th·ªÉ (t·ª´ g√≥c nh√¨n DispatcherServlet)

Incoming Request
   ‚Üì
preHandle() ‚Üê----------------------- [Interceptor]
   ‚Üì
Controller logic
   ‚Üì
postHandle() ‚Üê--------------------- [Interceptor]
   ‚Üì
View render
   ‚Üì
afterCompletion() ‚Üê--------------- [Interceptor]
   ‚Üì
Client response


# ‚öîÔ∏è 4. So s√°nh Interceptor vs Filter vs AOP

| ƒê·∫∑c ƒëi·ªÉm         | Filter (`javax.servlet.Filter`) | Interceptor (`HandlerInterceptor`) | AOP (`@Aspect`)    |
| ---------------- | ------------------------------- | ---------------------------------- | ------------------ |
| M·ª©c √°p d·ª•ng      | Tr∆∞·ªõc DispatcherServlet         | Trong Spring MVC lifecycle         | M·ªçi l·ªõp/method     |
| Truy c·∫≠p request | C√≥                              | C√≥                                 | Kh√¥ng tr·ª±c ti·∫øp    |
| Ki·ªÉm so√°t logic  | C√≥ th·ªÉ ch·∫∑n, s·ª≠a header         | C√≥ th·ªÉ ch·∫∑n, s·ª≠a model/view        | R·∫•t linh ho·∫°t      |
| M·ª•c ti√™u         | Auth, CORS, header              | Auth, logging, audit, template     | Business logic     |
| ∆Øu ƒëi·ªÉm          | Nhanh, s√°t HTTP                 | Hi·ªÉu request MVC r√µ h∆°n            | T√°ch logic r√µ r√†ng |


‚Üí ·ªû level senior, b·∫°n ph·∫£i bi·∫øt l√∫c n√†o n√™n d√πng c√°i n√†o. N·∫øu logic c·∫ßn access controller ho·∫∑c ModelAndView ‚Üí Interceptor l√† ƒë√∫ng nh·∫•t.


# üß™ 5. V√≠ d·ª• th·ª±c t·∫ø

public class AuthInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler) throws Exception {
        String token = request.getHeader("Authorization");
        if (token == null || !isValid(token)) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            return false; // ch·∫∑n lu√¥n
        }
        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request,
                           HttpServletResponse response,
                           Object handler,
                           ModelAndView modelAndView) throws Exception {
        // Optional: g·∫Øn th√¥ng tin common v√†o view
    }

    @Override
    public void afterCompletion(HttpServletRequest request,
                                HttpServletResponse response,
                                Object handler,
                                Exception ex) throws Exception {
        // Logging to√†n b·ªô request
    }
}


‚Üí Sau ƒë√≥ ƒëƒÉng k√Ω interceptor n√†y v√†o WebMvcConfigurer:

@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new AuthInterceptor())
                .addPathPatterns("/api/**")
                .excludePathPatterns("/public/**");
    }
}



# üß† 6. Nh·ªØng k·ªπ thu·∫≠t senior n√™n bi·∫øt
	- Interceptor c√≥ th·ªÉ stack l·ªìng nhau (multiple interceptors)
	- C√≥ th·ªÉ ƒë√°nh s·ªë th·ª© t·ª± ∆∞u ti√™n n·∫øu c·∫ßn (b·∫±ng c√°ch implements Ordered)
	- C√≥ th·ªÉ truy·ªÅn th√¥ng tin gi·ªØa c√°c interceptor qua request.setAttribute(...)
	- C√≥ th·ªÉ b·∫Øt exception to√†n c·ª•c t·∫°i afterCompletion()
	- C√≥ th·ªÉ d√πng interceptor cho context ph√¢n t√°n (tracing: requestId, correlationId...)



# ‚úÖ T·ªïng k·∫øt 

| ƒêi·ªÉm then ch·ªët                                  | Gi·∫£i th√≠ch                                   |
| ----------------------------------------------- | -------------------------------------------- |
| HandlerInterceptor l√† middleware n√¢ng cao       | Ki·ªÉm so√°t request lifecycle trong Spring MVC |
| C√≥ th·ªÉ can thi·ªáp s√¢u v√†o v√≤ng ƒë·ªùi x·ª≠ l√Ω         | Tr∆∞·ªõc, trong, sau controller                 |
| D√πng t·ªët h∆°n Filter trong MVC context           | V√¨ b·∫°n access ƒë∆∞·ª£c handler v√† model/view     |
| L√† c√¥ng c·ª• ch·ªß l·ª±c ƒë·ªÉ build middleware h·ªá th·ªëng | Auth, log, audit, permission, locale...      |





</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>