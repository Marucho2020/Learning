<html><head><title>Lesson 133 == LongAccumulator ==============\ ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ðŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 133 -- LongAccumulator -----\ -//</h1><pre>
# âœ… 1. TÃ³m táº¯t nhanh
	LongAccumulator lÃ  phiÃªn báº£n tá»•ng quÃ¡t hÆ¡n cá»§a LongAdder. 
		LongAdder: chá»‰ há»— trá»£ phÃ©p cá»™ng (+)
		LongAccumulator: cho phÃ©p báº¡n Ä‘á»‹nh nghÄ©a cÃ¡ch tÃ­ch lÅ©y tuá»³ Ã½ â€“ max, min, product, bitwiseOr,...
		
		
	## CÃº phÃ¡p cÆ¡ báº£n: 
	
LongAccumulator acc = new LongAccumulator(Long::max, Long.MIN_VALUE);
acc.accumulate(10);
acc.accumulate(5);
System.out.println(acc.get()); // 10



# âœ… 2. CÆ¡ cháº¿ ná»™i táº¡i (ná»™i táº¡ng thá»±c sá»± bÃªn dÆ°á»›i)

	Giá»‘ng LongAdder, LongAccumulator káº¿ thá»«a tá»« lá»›p áº©n danh bÃªn dÆ°á»›i: Striped64.
	
base: long                // giÃ¡ trá»‹ gá»‘c náº¿u khÃ´ng contention
cells: Cell[]             // máº£ng cÃ¡c Cell náº¿u contention xáº£y ra
function: LongBinaryOperator  // hÃ m tÃ­ch lÅ©y
identity: long            // giÃ¡ trá»‹ khá»Ÿi Ä‘áº§u khi reset
	
	

	## Hoáº¡t Ä‘á»™ng nhÆ° sau: 
		Náº¿u Ã­t contention â†’ Ã¡p dá»¥ng function.applyAsLong(base, x)
		Náº¿u cÃ³ contention â†’ thread hash tá»›i 1 Cell â†’ Ã¡p dá»¥ng function trÃªn Cell Ä‘Ã³
		get() hoáº·c getThenReset() sáº½ cá»™ng dá»“n base + cells[] báº±ng cÃ¹ng function
		âž¡ KhÃ´ng cÃ³ Ä‘á»“ng bá»™ hÃ³a (synchronized), khÃ´ng cÃ³ lock â€“ hoÃ n toÃ n lock-free, CAS-based





# âœ… 3. Táº¡i sao cáº§n LongAccumulator? 
	VÃ¬ khÃ´ng pháº£i má»i phÃ©p toÃ¡n Ä‘á»u lÃ  cá»™ng (+).
	

Má»™t sá»‘ vÃ­ dá»¥: 
| Use case          | Operation                   | Function           |
| ----------------- | --------------------------- | ------------------ |
| TÃ¬m sá»‘ lá»›n nháº¥t   | max                         | `Long::max`        |
| TÃ¬m sá»‘ nhá» nháº¥t   | min                         | `Long::min`        |
| PhÃ©p nhÃ¢n         | product                     | `(a, b) -> a * b`  |
| Bitwise AND       | and                         | `(a, b) -> a & b`  |
| Bitwise OR        | or                          | `(a, b) -> a \| b` |
| Tá»•ng trá»ng sá»‘ log | `(a, b) -> log(a) + log(b)` | custom             |
âž¡ Trong cÃ¡c tÃ¬nh huá»‘ng cáº§n logic phá»©c táº¡p hÆ¡n cá»™ng Ä‘Æ¡n giáº£n, LongAdder khÃ´ng Ä‘á»§.


# âœ… 4. CÃ¡c phÆ°Æ¡ng thá»©c quan trá»ng 

| Method               | Ã nghÄ©a                                   |
| -------------------- | ----------------------------------------- |
| `accumulate(long x)` | Ãp dá»¥ng hÃ m tÃ­ch lÅ©y                      |
| `get()`              | Láº¥y tá»•ng (hoáº·c max/min tÃ¹y function)      |
| `getThenReset()`     | Láº¥y rá»“i reset                             |
| `reset()`            | Reset vá» identity                         |
| `longValue()`        | Alias cá»§a `get()` (do implement `Number`) |


# âœ… 5. Hiá»‡u nÄƒng thá»±c táº¿

| Threads | `LongAdder` (sum) | `LongAccumulator` (max) |
| ------- | ----------------- | ----------------------- |
| 1       | Ráº¥t nhanh (\~20M) | TÆ°Æ¡ng Ä‘Æ°Æ¡ng             |
| 4       | \~70M             | \~65M                   |
| 16      | \~160M            | \~150M                  |
| 64      | \~200M            | \~180M                  |

âž¡ KhÃ´ng thua kÃ©m LongAdder lÃ  bao, vÃ¬ cÃ¹ng chia sáº» cÆ¡ sá»Ÿ háº¡ táº§ng Striped64


# âœ… 6. Æ¯u Ä‘iá»ƒm vÃ  nhÆ°á»£c Ä‘iá»ƒm

	## âœ… Æ¯u Ä‘iá»ƒm 
	
		- TÃ¹y biáº¿n logic tÃ­ch lÅ©y â†’ báº¡n Ä‘á»‹nh nghÄ©a cÃ¡ch cá»™ng dá»“n
		- Ráº¥t tá»‘i Æ°u hÃ³a cho high-concurrency
		- Cáº¥u trÃºc lock-free, dÃ¹ng CAS
		- KhÃ´ng Ä‘á»“ng bá»™, khÃ´ng block

	## âŒ NhÆ°á»£c Ä‘iá»ƒm

		KhÃ´ng dÃ¹ng Ä‘Æ°á»£c trong cÃ¡c tÃ¬nh huá»‘ng cáº§n get/set chÃ­nh xÃ¡c táº¡i thá»i Ä‘iá»ƒm (giá»‘ng nhÆ° AtomicLong)
		KhÃ´ng thread-safe theo nghÄ©a strict cá»§a snapshot: get() khÃ´ng pháº£i lÃ  atomic snapshot


# âœ… 7. Khi nÃ o dÃ¹ng LongAccumulator?

| TÃ¬nh huá»‘ng                                    | DÃ¹ng `LongAccumulator`? |
| --------------------------------------------- | ----------------------- |
| TÃ¬m max/min liÃªn tá»¥c trong high concurrency   | âœ… Tuyá»‡t vá»i             |
| Äáº¿m sá»‘ lÆ°á»£ng log nhÆ°ng cáº§n phÃ©p cá»™ng Ä‘Æ¡n giáº£n | âŒ DÃ¹ng `LongAdder`      |
| Sinh ID tÄƒng dáº§n, cáº§n chÃ­nh xÃ¡c tuyá»‡t Ä‘á»‘i     | âŒ DÃ¹ng `AtomicLong`     |
| TÃ­nh tÃ­ch, tá»•ng Ä‘iá»ƒm cÃ³ trá»ng sá»‘, custom rule | âœ… DÃ¹ng tá»‘t              |
| Ghi Ä‘Ã¨ giÃ¡ trá»‹ hoáº·c rollback                  | âŒ KhÃ´ng phÃ¹ há»£p         |


# âœ… 8. Code vÃ­ dá»¥: thá»‘ng kÃª Ä‘iá»ƒm sá»‘ lá»›n nháº¥t tá»« nhiá»u thread
LongAccumulator maxScore = new LongAccumulator(Long::max, Long.MIN_VALUE);

// Má»—i thread náº¡p Ä‘iá»ƒm
Runnable task = () -> {
    long score = Math.round(Math.random() * 100);
    maxScore.accumulate(score);
};

ExecutorService pool = Executors.newFixedThreadPool(10);
for (int i = 0; i < 1000; i++) {
    pool.execute(task);
}

pool.shutdown();
pool.awaitTermination(1, TimeUnit.SECONDS);
System.out.println("Max score: " + maxScore.get());




# âœ… 9. Má»Ÿ rá»™ng: so sÃ¡nh 4 class phá»• biáº¿n 


| Class                            | DÃ¹ng khi                             | Ghi     | Äá»c        | Contention |
| -------------------------------- | ------------------------------------ | ------- | ---------- | ---------- |
| `AtomicLong`                     | Ghi Ã­t, Ä‘á»c nhiá»u, cáº§n chÃ­nh xÃ¡c     | âŒ cháº­m  | âœ… nhanh    | âŒ          |
| `LongAdder`                      | Cá»™ng dá»“n nhiá»u, Ä‘o lÆ°á»ng log         | âœ… nhanh | âš  hÆ¡i cháº­m | âœ…          |
| `LongAccumulator`                | PhÃ©p tÃ­ch lÅ©y Ä‘áº·c biá»‡t (max/min/etc) | âœ… nhanh | âš           | âœ…          |
| `LongAccumulator` (custom logic) | Phá»©c táº¡p cáº§n tÃ­ch lÅ©y logic riÃªng    | âœ…       | âš           | âœ…          |


# âœ… Tá»•ng káº¿t

| Äiá»ƒm                                         | GiÃ¡ trá»‹ |
| -------------------------------------------- | ------- |
| TÃ¹y biáº¿n cao                                 | âœ…       |
| Hiá»‡u nÄƒng tá»‘t                                | âœ…       |
| KhÃ´ng cáº§n synchronized                       | âœ…       |
| KhÃ´ng chÃ­nh xÃ¡c tá»©c thá»i                     | âš        |
| KhÃ´ng dÃ¹ng cho business logic yÃªu cáº§u atomic | âŒ       |




</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ðŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ðŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>