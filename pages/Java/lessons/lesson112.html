<html><head><title>Lesson 112 == Segment Tree Beats ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 112 -- Segment Tree Beats -//</h1><pre># KhÃ¡i niá»‡m 
	Segment Tree Beats lÃ  má»™t dáº¡ng cáº£i tiáº¿n cao cáº¥p cá»§a SegmentTree, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ xá»­ lÃ½ cÃ¡c truy váº¥n phá»©c táº¡p mÃ  cÃ¡c dáº¡ng Lazy Propagation truyá»n thá»‘ng khÃ´ng xá»­ lÃ½ Ä‘Æ°á»£c hiá»‡u quáº£
	
	
# ğŸ”¥ Khi nÃ o cáº§n Segment Tree Beats? 
Khi báº¡n cÃ³ nhá»¯ng truy váº¥n phá»©c táº¡p nhÆ° sau: 
| Truy váº¥n kiá»ƒu                                      | Lazy Segment Tree cÃ³ xá»­ lÃ½ tá»‘t khÃ´ng? | Segment Tree Beats thÃ¬ sao? |
| -------------------------------------------------- | ------------------------------------- | --------------------------- |
| Cáº­p nháº­t táº¥t cáº£ `A[i] := x` trong Ä‘oáº¡n \[L, R]     | âœ… CÃ³                                  | âœ… CÃ³                        |
| Cáº­p nháº­t `A[i] := min(A[i], x)` trong Ä‘oáº¡n \[L, R] | âŒ KhÃ´ng hiá»‡u quáº£                      | âœ… Ráº¥t hiá»‡u quáº£              |
| Truy váº¥n tá»•ng / min / max trong Ä‘oáº¡n \[L, R]       | âœ… CÃ³                                  | âœ… CÃ³                        |
| Truy váº¥n sá»‘ láº§n `A[i] == max` trong Ä‘oáº¡n \[L, R]   | âŒ KhÃ´ng lÃ m Ä‘Æ°á»£c                      | âœ… LÃ m Ä‘Æ°á»£c náº¿u Beats        |

	ğŸ“Œ VÃ­ dá»¥ thá»±c táº¿:
Báº¡n cÃ³ máº£ng Ä‘iá»ƒm sá»‘ ngÆ°á»i chÆ¡i, vÃ  muá»‘n giáº£m Ä‘iá»ƒm nhá»¯ng ngÆ°á»i cÃ³ Ä‘iá»ƒm quÃ¡ cao (vÃ­ dá»¥, táº¥t cáº£ A[i] > 90 thÃ¬ A[i] := min(A[i], 90)) â†’ ráº¥t giá»‘ng "Ä‘Ã¡nh báº§m" cÃ¢y, lÃ m yáº¿u dáº§n pháº§n tá»­ máº¡nh nháº¥t â†’ Segment Tree Beats.

# ğŸ§  Ã tÆ°á»Ÿng chÃ­nh â€“ â€œBeatingâ€ logic 
Má»—i node trong Segment Tree Beats lÆ°u:

- max1: pháº§n tá»­ lá»›n nháº¥t trong Ä‘oáº¡n
- max2: pháº§n tá»­ lá»›n thá»© 2 trong Ä‘oáº¡n
- cntMax: sá»‘ láº§n max1 xuáº¥t hiá»‡n
- sum: tá»•ng giÃ¡ trá»‹ Ä‘oáº¡n

	##ğŸ’¥ Khi ta cáº­p nháº­t min(A[i], x) trong Ä‘oáº¡n, náº¿u x â‰¥ max1:
		â†’ KhÃ´ng lÃ m gÃ¬ (vÃ¬ má»i pháº§n tá»­ Ä‘á»u â‰¤ x)
		NhÆ°ng náº¿u x < max1 vÃ  x â‰¥ max2:
		â†’ Chá»‰ cáº§n giáº£m max1 vá» x, update láº¡i sum, khÃ´ng Ä‘á»¥ng gÃ¬ khÃ¡c.
		Náº¿u x < max2 â†’ khÃ´ng thá»ƒ cáº­p nháº­t node hiá»‡n táº¡i, pháº£i Ä‘á»‡ quy xuá»‘ng 2 con.


# ğŸ› ï¸ VÃ­ dá»¥ code xá»­ lÃ½ min(A[i], x) (Beating step): 

void applyMin(int node, int l, int r, int x) {
    if (max1[node] <= x) return; // khÃ´ng cáº§n lÃ m gÃ¬
    if (max2[node] < x) {
        // cÃ³ thá»ƒ cáº­p nháº­t toÃ n bá»™ Ä‘oáº¡n
        long delta = (long)(x - max1[node]) * cntMax[node];
        sum[node] += delta;
        max1[node] = x;
        // khÃ´ng cáº§n update max2 náº¿u khÃ´ng cáº§n truy váº¥n khÃ¡c
        return;
    }
    // khÃ´ng thá»ƒ cáº­p nháº­t Ä‘oáº¡n, Ä‘á»‡ quy xuá»‘ng
    pushDown(node);
    applyMin(leftChild, l, mid, x);
    applyMin(rightChild, mid+1, r, x);
    pullUp(node);
}


# ğŸ” LÆ°u gÃ¬ trong má»—i node?

| TrÆ°á»ng dá»¯ liá»‡u                    | Ã nghÄ©a                     |
| --------------------------------- | --------------------------- |
| `max1`                            | Pháº§n tá»­ lá»›n nháº¥t trong Ä‘oáº¡n |
| `max2`                            | Pháº§n tá»­ lá»›n thá»© 2           |
| `cntMax`                          | Sá»‘ láº§n max1 xuáº¥t hiá»‡n       |
| `sum`                             | Tá»•ng giÃ¡ trá»‹ Ä‘oáº¡n           |
| (option) `min1`, `min2`, `cntMin` | Náº¿u cáº§n lÃ m `max(A[i], x)`  |


# ğŸ“ˆ Äá»™ phá»©c táº¡p:
	âœ… Má»—i láº§n update min(A[i], x) hoáº·c max(A[i], x) máº¥t: O(log n) trong trÆ°á»ng há»£p tá»‘t
	âŒ TrÆ°á»ng há»£p xáº¥u nháº¥t: pháº£i Ä‘á»‡ quy nhiá»u â†’ O(logÂ² n)
	NhÆ°ng váº«n tá»‘t hÆ¡n ráº¥t nhiá»u so vá»›i cÃ¡ch naive hoáº·c lazy propagation thÃ´ng thÆ°á»ng (vÃ¬ khÃ´ng pháº£i update tá»«ng pháº§n tá»­ trong Ä‘oáº¡n).


# ğŸ“Œ á»¨ng dá»¥ng thá»±c tiá»…n: 

| Váº¥n Ä‘á»                                       | CÃ³ thá»ƒ dÃ¹ng Segment Tree Beats khÃ´ng? |
| -------------------------------------------- | ------------------------------------- |
| Game server: giáº£m chá»‰ sá»‘ cÃ¡c user > 99 vá» 99 | âœ…                                     |
| Truy váº¥n sá»‘ ngÆ°á»i cÃ³ HP tá»‘i Ä‘a               | âœ…                                     |
| Truy váº¥n tá»•ng HP trong Ä‘oáº¡n                  | âœ…                                     |
| Truy váº¥n sá»‘ láº§n max HP xuáº¥t hiá»‡n trong Ä‘oáº¡n  | âœ…                                     |
| Update tÄƒng/giáº£m tá»«ng pháº§n tá»­                | âœ… káº¿t há»£p Lazy                        |

# ğŸ§  So sÃ¡nh vá»›i cÃ¡c cáº¥u trÃºc khÃ¡c:

| Cáº¥u trÃºc                | Máº¡nh á»Ÿ Ä‘Ã¢u                                    | Yáº¿u á»Ÿ Ä‘Ã¢u                                           |
| ----------------------- | --------------------------------------------- | --------------------------------------------------- |
| Segment Tree (classic)  | Tá»•ng, min/max, update 1 giÃ¡ trá»‹               | KhÃ´ng lÃ m tá»‘t cÃ¡c truy váº¥n dáº¡ng min/max Ä‘iá»u kiá»‡n   |
| Lazy Segment Tree       | Cáº­p nháº­t Ä‘oáº¡n, tá»•ng, cá»™ng/trá»«                 | KhÃ´ng handle Ä‘Æ°á»£c `min(A[i], x)` hay `max(A[i], x)` |
| Segment Tree Beats      | Truy váº¥n phá»©c táº¡p cÃ³ Ä‘iá»u kiá»‡n, min/max limit | Ráº¥t phá»©c táº¡p Ä‘á»ƒ implement, nhiá»u nhÃ¡nh edge         |
| Persistent Segment Tree | Quáº£n lÃ½ snapshot, undo/redo                   | KhÃ´ng há»— trá»£ truy váº¥n `min(A[i], x)` tá»‘t            |
| Merge Sort Tree         | Truy váº¥n rank / count / â‰¤ x                   | KhÃ´ng update Ä‘á»™ng tá»‘t                               |

# ğŸ”š Káº¿t luáº­n:
	Segment Tree Beats lÃ  ká»¹ thuáº­t chuyÃªn sÃ¢u dÃ¹ng cho:

		Truy váº¥n phá»©c táº¡p
		Cáº­p nháº­t cÃ³ Ä‘iá»u kiá»‡n
		Khi Lazy Segment Tree khÃ´ng Ä‘á»§
		NÃ³ cÃ³ Ä‘á»™ phá»©c táº¡p logic cao, nhÆ°ng khi triá»ƒn khai Ä‘Ãºng sáº½ cá»±c ká»³ hiá»‡u quáº£ cho nhá»¯ng bÃ i toÃ¡n kiá»ƒu reduce/max/min conditional update.













</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>