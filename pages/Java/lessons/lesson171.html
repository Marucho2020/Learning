<html><head><title>Lesson 171 == Exchanger ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 171 -- Exchanger -//</h1><pre>
# Kh√°i ni·ªám 
	üîπ Exchanger ‚Äì C∆° ch·∫ø trao ƒë·ªïi d·ªØ li·ªáu song ph∆∞∆°ng
	Exchanger<V> l√† m·ªôt synchronization point cho hai thread trao ƒë·ªïi d·ªØ li·ªáu tr·ª±c ti·∫øp:	
		Thread A g·ªçi exchange(valueA) ‚Üí block cho ƒë·∫øn khi Thread B g·ªçi exchange(valueB).
		Sau khi b·∫Øt tay, A nh·∫≠n valueB, B nh·∫≠n valueA.
	
	Kh√°c v·ªõi BlockingQueue (m·ªôt producer, nhi·ªÅu consumer, ho·∫∑c buffer nhi·ªÅu ph·∫ßn t·ª≠), Exchanger l√† rendezvous point 1‚Äì1, 2 chi·ªÅu.	
	
	
#	2. C∆° ch·∫ø ho·∫°t ƒë·ªông

	N·ªôi b·ªô: Exchanger d√πng m·ªôt arena (slot) ƒë·ªÉ gi·ªØ gi√° tr·ªã t·ª´ thread ƒë·∫ßu ti√™n.

	Khi thread th·ª© hai t·ªõi:
		- CAS gh√©p c·∫∑p hai gi√° tr·ªã.
		- C·∫£ hai thread ƒë∆∞·ª£c unpark v√† nh·∫≠n d·ªØ li·ªáu c·ªßa ƒë·ªëi ph∆∞∆°ng.

	C√≥ th·ªÉ k√®m timeout:
	
	V other = exchanger.exchange(myValue, 1, TimeUnit.SECONDS);
	N·∫øu h·∫øt timeout m√† ch∆∞a c√≥ thread n√†o gh√©p ‚Üí TimeoutException.


# 3. Use case th·ª±c t·∫ø
	
	## 	Pipeline gi·ªØa hai thread: 
		
		- V√≠ d·ª• 1 thread producer t·∫°o buffer d·ªØ li·ªáu, 1 thread consumer x·ª≠ l√Ω buffer.
		- D√πng Exchanger<Buffer> ƒë·ªÉ swap buffer ‚Üí kh√¥ng c·∫ßn copy.

	## Double buffering: 
		
		- Producer vi·∫øt v√†o buffer A, consumer ƒë·ªçc buffer B.
		- Khi c·∫£ hai xong, g·ªçi exchange() ‚Üí swap buffer.
		- K·ªπ thu·∫≠t n√†y r·∫•t t·ªëi ∆∞u khi x·ª≠ l√Ω batch (image processing, logging, batch I/O).

	## Genetic algorithms / simulations: 
		- Hai worker thread trao ƒë·ªïi "population state" ho·∫∑c intermediate result ƒë·ªãnh k·ª≥.
	

# 4. ∆Øu ƒëi·ªÉm vs Nh∆∞·ª£c ƒëi·ªÉm
	
	## ‚úÖ ∆Øu ƒëi·ªÉm: 
		
		- R·∫•t nh·∫π, tr·ª±c ti·∫øp, kh√¥ng c·∫ßn middle buffer.
		- G·ªçn cho b√†i to√°n 2-thread rendezvous.
		- H·∫°n ch·∫ø contention v√¨ ch·ªâ c·∫ßn 2 b√™n match.	
	
	
	## ‚ö†Ô∏è Nh∆∞·ª£c ƒëi·ªÉm / trap senior: 
		
		- Ch·ªâ d√†nh cho 2 thread ‚Äì kh√¥ng ph·∫£i replacement cho BlockingQueue.
		- N·∫øu m·∫•t c√¢n b·∫±ng load (1 thread nhanh, 1 thread ch·∫≠m) ‚Üí thread nhanh block m√£i.
		- N·∫øu l·∫°m d·ª•ng trong h·ªá th·ªëng nhi·ªÅu thread ‚Üí d·ªÖ g√¢y deadlock ho·∫∑c starvation.
		- Kh√¥ng c√≥ ‚Äúbuffering‚Äù ‚Üí d·ªØ li·ªáu ph·∫£i ƒë∆∞·ª£c trao ƒë·ªïi ngay.

	

# 5. V√≠ d·ª• senior-level: Double Buffer


class ExchangerDemo {
    static Exchanger<List<Integer>> exchanger = new Exchanger<>();

    public static void main(String[] args) {
        ExecutorService exec = Executors.newFixedThreadPool(2);

        exec.submit(() -> { // Producer
            List<Integer> buffer = new ArrayList<>();
            try {
                for (int i = 0; i < 5; i++) {
                    buffer.clear();
                    buffer.add(i);
                    System.out.println("Produced: " + buffer);
                    // swap buffer with consumer
                    buffer = exchanger.exchange(buffer);
                }
            } catch (InterruptedException e) {}
        });

        exec.submit(() -> { // Consumer
            List<Integer> buffer = new ArrayList<>();
            try {
                for (int i = 0; i < 5; i++) {
                    buffer = exchanger.exchange(buffer);
                    System.out.println("Consumed: " + buffer);
                }
            } catch (InterruptedException e) {}
        });

        exec.shutdown();
    }
}

	C·∫£ producer v√† consumer s·∫Ω li√™n t·ª•c ho√°n ƒë·ªïi buffer.
	Kh√¥ng c·∫ßn lock, kh√¥ng c·∫ßn copy d·ªØ li·ªáu.



# 6. So s√°nh v·ªõi c√°c pattern kh√°c


| C√¥ng c·ª•            | ƒê·∫∑c ƒëi·ªÉm          | Khi n√†o d√πng                                         |
| ------------------ | ----------------- | ---------------------------------------------------- |
| `BlockingQueue`    | 1-N, c√≥ buffer    | Khi nhi·ªÅu producer/consumer, decoupling t·ªëc ƒë·ªô       |
| `SynchronousQueue` | 1-1, kh√¥ng buffer | Producer/consumer b·∫Øt tay tr·ª±c ti·∫øp, kh√¥ng gi·ªØ state |
| `Exchanger`        | 1-1, **2 chi·ªÅu**  | Khi c·∫ßn **swap d·ªØ li·ªáu** gi·ªØa 2 threads              |



# 7. Best practices (senior mindset)

	## D√πng Exchanger khi: 
	
		B·∫°n bi·∫øt ch·∫Øc ch·ªâ c√≥ 2 threads l√†m vi·ªác c√πng nhau.
		B√†i to√°n c√≥ double-buffering / swapping d·ªØ li·ªáu.
		
	## Tr√°nh d√πng khi: 
		C√≥ nhi·ªÅu producer/consumer ‚Üí chuy·ªÉn sang BlockingQueue.
		Thread speed imbalance l·ªõn ‚Üí d·ªÖ block v√¥ th·ªùi h·∫°n.		


	Lu√¥n consider timeout ƒë·ªÉ tr√°nh deadlock ·∫©n.

Exchanger l√† point-to-point data swapper, c·ª±c k·ª≥ hi·ªáu qu·∫£ cho 2-thread pipelines (double buffering, batch handoff). Nh∆∞ng n√≥ kh√¥ng scale v√† r·∫•t d·ªÖ tr·ªü th√†nh bottleneck n·∫øu thi·∫øt k·∫ø sai. ƒê√¢y l√† tool d√†nh cho case ƒë·∫∑c th√π, kh√¥ng ph·∫£i v≈© kh√≠ chung nh∆∞ BlockingQueue hay ConcurrentHashMap.








</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>