<html><head><title>Lesson 212 == Functional Orchestration (Saga Pattern) ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../java-learning-list.html'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 212 -- Functional Orchestration (Saga Pattern) -//</h1><pre>
# ğŸ§  1. Váº¥n Ä‘á» gá»‘c cá»§a há»‡ thá»‘ng phÃ¢n tÃ¡n
	Trong há»‡ thá»‘ng microservices:
	
		Má»—i service (Order, Payment, Shipping, Notification) Ä‘á»u Ä‘á»™c láº­p â€” khÃ´ng cÃ³ â€œtransaction toÃ n cá»¥câ€.

	Náº¿u báº¡n gá»i tuáº§n tá»±:
createOrder();
chargePayment();
shipItem();
notifyCustomer();

	â†’ Náº¿u bÆ°á»›c 3 fail, báº¡n khÃ´ng thá»ƒ rollback 1 & 2 dá»… dÃ ng.

	## Giáº£i phÃ¡p OOP truyá»n thá»‘ng:
		DÃ¹ng transaction manager, saga orchestrator, hoáº·c choreography báº±ng message broker.
		
		NhÆ°ng: phá»©c táº¡p, nhiá»u framework, coupling cao.



	## Giáº£i phÃ¡p functional:

		Model má»i step nhÆ° pure function.
		Thay rollback = compensate, vÃ  compose chÃºng nhÆ° pipeline.
		

# âš™ï¸ 2. Functional Saga Core Concept

	## a. Function kiá»ƒu Saga Step
		Má»—i bÆ°á»›c lÃ  má»™t function:
		Function<Input, Either<Error, Output>>
	
	Náº¿u thÃ nh cÃ´ng â†’ tráº£ Right(Output)
	Náº¿u tháº¥t báº¡i â†’ tráº£ Left(Error)

	ÄÃ¢y chÃ­nh lÃ  kiá»ƒu dá»¯ liá»‡u â€œsá»‘ng cÃ²nâ€ cá»§a functional error handling.


# b. Higher-Order Function compensate(fn, rollbackFn)

	Ta gÃ³i má»—i bÆ°á»›c báº±ng má»™t compensation function (rollback function).
		
<T, R> SagaStep<T, R> compensate(
        Function<T, Either<Error, R>> action,
        Consumer<R> rollbackFn
) {
    return new SagaStep<>(action, rollbackFn);
}


# c. Compose pipeline Saga
	Giá» ta cÃ³ thá»ƒ compose cÃ¡c step:
	
	
SagaStep<OrderRequest, Order> createOrder = compensate(
    req -> Right(orderRepo.create(req)),
    order -> orderRepo.delete(order.getId())
);

SagaStep<Order, Payment> chargePayment = compensate(
    order -> paymentService.charge(order),
    payment -> paymentService.refund(payment)
);

SagaStep<Payment, Shipment> shipItem = compensate(
    payment -> shippingService.ship(payment),
    shipment -> shippingService.cancel(shipment)
);
	
	
	
	
# 	d. Orchestration Function
	
	Giá» ta viáº¿t orchestrator thuáº§n functional:	
	
<T> Either<Error, T> runSaga(List<SagaStep<?, ?>> steps) {
    List<Object> completed = new ArrayList<>();
    for (SagaStep step : steps) {
        var result = step.action.apply(completed.isEmpty() ? null : completed.getLast());
        if (result.isLeft()) {
            // rollback in reverse
            Collections.reverse(completed);
            completed.forEach(prev -> step.rollbackFn.accept(prev));
            return Left(result.getLeft());
        }
        completed.add(result.get());
    }
    return Right((T) completed.getLast());
}
	
	
	â†’ KhÃ´ng annotation, khÃ´ng AOP, thuáº§n hÃ m + thuáº§n logic.
	KhÃ´ng cÃ³ side effect ngoÃ i nhá»¯ng gÃ¬ ta kiá»ƒm soÃ¡t rÃµ rÃ ng.
	
	
# ğŸ§© 3. So sÃ¡nh vá»›i OOP Saga Framework

| KhÃ­a cáº¡nh    | OOP Saga (Spring State Machine, Camunda, Axon...) | Functional Saga                 |
| ------------ | ------------------------------------------------- | ------------------------------- |
| Orchestrator | Stateful class / XML config                       | Pure function                   |
| Compensation | Config file hoáº·c annotation                       | Inline function                 |
| Testing      | Mock service, test integration                    | Unit test tá»«ng function dá»… dÃ ng |
| Debug        | Workflow trace                                    | Stream log + function chain     |
| Dependency   | Framework heavy                                   | Zero dependency                 |


# ğŸš€ 4. VÃ­ dá»¥ thá»±c táº¿: Order â†’ Payment â†’ Shipping â†’ Notification


var saga = SagaBuilder.start(createOrder)
    .then(chargePayment)
    .then(shipItem)
    .then(notifyCustomer);

	var result = saga.run(orderRequest);


if (result.isLeft()) {
    log.error("Saga failed: " + result.getLeft());
}

	## Náº¿u báº¥t ká»³ bÆ°á»›c nÃ o fail:

		- Tá»± Ä‘á»™ng rollback theo chuá»—i Ä‘Ã£ khai bÃ¡o.
		- KhÃ´ng cáº§n try/catch hay transaction manager.
		- Má»i rollback Ä‘á»u lÃ  pure function, testable, composable.



# ğŸ§® 5. Functional Advantage

| Æ¯u Ä‘iá»ƒm           | Giáº£i thÃ­ch                                                                       |
| ----------------- | -------------------------------------------------------------------------------- |
| âœ… Declarative     | Ta â€œmÃ´ táº£â€ workflow, khÃ´ng â€œchá»‰ huyâ€ tá»«ng step                                   |
| âœ… Deterministic   | Dá»… test, dá»… mÃ´ phá»ng                                                             |
| âœ… Immutable State | Saga log cÃ³ thá»ƒ lÆ°u snapshot state â†’ replay Ä‘Æ°á»£c                                 |
| âœ… Resilient       | Dá»… káº¿t há»£p vá»›i retry, timeout, fallback (bÃ i trÆ°á»›c)                              |
| âœ… Parallelizable  | CÃ³ thá»ƒ cháº¡y saga branches song song (cháº³ng háº¡n `notifyManager` & `updateLedger`) |



# âš™ï¸ 6. Enterprise Use Case

	## ğŸ’³ Payment Pipeline
		Náº¿u thanh toÃ¡n fail â†’ rollback Ä‘Æ¡n hÃ ng, há»§y shipment.
		Náº¿u shipment fail â†’ refund payment.


	## ğŸ§¾ Ledger System
		Má»—i bÆ°á»›c cá»§a event ledger lÃ  append-only function, rollback chá»‰ thÃªm event â€œreversalâ€, khÃ´ng xÃ³a dá»¯ liá»‡u.
	
	## ğŸšš Supply Chain
		CÃ¡c service phÃ¢n tÃ¡n (Inventory, Shipping, Invoice) phá»‘i há»£p qua functional saga â†’ rollback logic náº±m á»Ÿ tá»«ng step.


# ğŸ§  7. Má»Ÿ rá»™ng nÃ¢ng cao


Khi Ä‘Ã£ hiá»ƒu pattern nÃ y, báº¡n cÃ³ thá»ƒ:

	DÃ¹ng Reactive Saga vá»›i Flux hoáº·c Flow.Publisher (non-blocking orchestration).
	DÃ¹ng Functional DSL Ä‘á»ƒ mÃ´ táº£ pipeline tá»« file YAML:


# ğŸ”® 8. Tá»•ng káº¿t triáº¿t lÃ½

Functional Saga khÃ´ng cá»‘ tÃ¡i táº¡o transaction toÃ n cá»¥c,
mÃ  biáº¿n chuá»—i hÃ nh Ä‘á»™ng báº¥t Ä‘á»“ng bá»™ thÃ nh má»™t pipeline cÃ³ thá»ƒ rollback tá»± nhiÃªn â€”
vá»«a pure functional, vá»«a resilient, vá»«a declarative
</pre><a id='backBottom' href='../java-learning-list.html' style='display:none;'>ğŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ğŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>