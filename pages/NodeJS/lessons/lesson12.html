<html><head><title>Lesson 12 == Error Handling ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../NodeJS-learning.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 12 -- Error Handling -//</h1><pre>
# T·∫°i sao c·∫ßn x·ª≠ l√Ω l·ªói?
	X·ª≠ l√Ω l·ªói (error handling) l√† y·∫øu t·ªë then ch·ªët ƒë·ªÉ ƒë·∫£m b·∫£o ·ª©ng d·ª•ng Node.js ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh v√† th√¢n thi·ªán v·ªõi ng∆∞·ªùi d√πng. Theo b√†i h·ªçc, l√Ω do ch√≠nh bao g·ªìm:

		- NgƒÉn ·ª©ng d·ª•ng crash b·∫•t ng·ªù: M·ªôt l·ªói kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω (unhandled error) c√≥ th·ªÉ l√†m ·ª©ng d·ª•ng d·ª´ng ƒë·ªôt ng·ªôt, g√¢y m·∫•t tr·∫£i nghi·ªám ng∆∞·ªùi d√πng.
		- Cung c·∫•p ph·∫£n h·ªìi √Ω nghƒ©a: Thay v√¨ l·ªói chung chung, b·∫°n c√≥ th·ªÉ tr·∫£ v·ªÅ th√¥ng b√°o c·ª• th·ªÉ (e.g., "File kh√¥ng t·ªìn t·∫°i").
		- D·ªÖ debug h∆°n: L·ªói ƒë∆∞·ª£c x·ª≠ l√Ω ƒë√∫ng c√°ch cung c·∫•p ng·ªØ c·∫£nh (context) r√µ r√†ng, gi√∫p t√¨m nguy√™n nh√¢n nhanh ch√≥ng.
		- Duy tr√¨ ·ªïn ƒë·ªãnh trong production: ·ª®ng d·ª•ng production c·∫ßn x·ª≠ l√Ω l·ªói ƒë·ªÉ tr√°nh downtime ho·∫∑c m·∫•t d·ªØ li·ªáu.
		- ƒê·∫£m b·∫£o cleanup t√†i nguy√™n: ƒê√≥ng k·∫øt n·ªëi database, socket, ho·∫∑c file khi l·ªói x·∫£y ra.	


	Insight chuy√™n s√¢u: Trong th·ª±c t·∫ø, m·ªôt h·ªá th·ªëng kh√¥ng x·ª≠ l√Ω l·ªói t·ªët c√≥ th·ªÉ d·∫´n ƒë·∫øn m·∫•t d·ªØ li·ªáu (data loss), r√≤ r·ªâ t√†i nguy√™n (resource leaks), ho·∫∑c l·ªô th√¥ng tin nh·∫°y c·∫£m (e.g., stack trace cho hacker). V√≠ d·ª•, n·∫øu b·∫°n kh√¥ng x·ª≠ l√Ω l·ªói khi ghi file, file c√≥ th·ªÉ b·ªã ghi n·ª≠a v·ªùi, d·∫´n ƒë·∫øn d·ªØ li·ªáu h·ªèng. Trong m√¥i tr∆∞·ªùng production, b·∫°n c·∫ßn th√™m logging (s·ª≠ d·ª•ng Winston ho·∫∑c Pino) v√† monitoring (nh∆∞ Prometheus) ƒë·ªÉ theo d√µi l·ªói.



#  1. L·ªói JavaScript chu·∫©n (Standard JavaScript Errors)

	ƒê√¢y l√† c√°c l·ªói ph√°t sinh t·ª´ code JavaScript, th∆∞·ªùng g·∫∑p trong m·ªçi m√¥i tr∆∞·ªùng JS, kh√¥ng ri√™ng Node.js:

	## SyntaxError: L·ªói c√∫ ph√°p, v√≠ d·ª• khi parse JSON kh√¥ng h·ª£p l·ªá:
		JSON.parse('{invalid json}'); // SyntaxError: Unexpected token i in JSON


	## TypeError: Truy c·∫≠p thu·ªôc t√≠nh/method tr√™n gi√° tr·ªã kh√¥ng h·ª£p l·ªá:

		null.someProperty; // TypeError: Cannot read property 'someProperty' of null

	## ReferenceError: S·ª≠ d·ª•ng bi·∫øn ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a
		console.log(unknownVariable); // ReferenceError: unknownVariable is not defined	
	
		Insight: Nh·ªØng l·ªói n√†y th∆∞·ªùng do sai s√≥t c·ªßa developer (nh∆∞ qu√™n ki·ªÉm tra null/undefined). Trong production, d√πng linter (ESLint) v√† TypeScript ƒë·ªÉ b·∫Øt l·ªói s·ªõm
	
	
#2. L·ªói h·ªá th·ªëng (System Errors) 	
	
	ƒê√¢y l√† l·ªói li√™n quan ƒë·∫øn h·ªá th·ªëng ho·∫∑c m√¥i tr∆∞·ªùng runtime, th∆∞·ªùng g·∫∑p trong Node.js khi t∆∞∆°ng t√°c v·ªõi file, network, ho·∫∑c h·ªá ƒëi·ªÅu h√†nh:
	
	
	## ENOENT: File ho·∫∑c th∆∞ m·ª•c kh√¥ng t·ªìn t·∫°i:
		
const fs = require('fs');
fs.readFile('nonexistent.txt', (err) => {
  console.error(err.code); // 'ENOENT'
});
	
	
	## 	ECONNREFUSED ho·∫∑c ENOTFOUND: K·∫øt n·ªëi m·∫°ng th·∫•t b·∫°i:
const http = require('http');
http.get('http://nonexistent-site.com', (res) => {}).on('error', (err) => {
  console.error(err.code); // 'ECONNREFUSED' ho·∫∑c 'ENOTFOUND'
});	
	
	Insight: L·ªói h·ªá th·ªëng th∆∞·ªùng c√≥ thu·ªôc t√≠nh code (e.g., 'ENOENT') gi√∫p b·∫°n x√°c ƒë·ªãnh nguy√™n nh√¢n c·ª• th·ªÉ. Trong th·ª±c t·∫ø, lu√¥n ki·ªÉm tra err.code ƒë·ªÉ x·ª≠ l√Ω l·ªói theo ng·ªØ c·∫£nh, v√≠ d·ª• tr·∫£ v·ªÅ th√¥ng b√°o th√¢n thi·ªán v·ªõi ng∆∞·ªùi d√πng thay v√¨ stack trace.	
	
	
	
# 	C√°c m·∫´u x·ª≠ l√Ω l·ªói c∆° b·∫£n
	Node.js h·ªó tr·ª£ nhi·ªÅu c√°ch x·ª≠ l√Ω l·ªói, t√πy thu·ªôc v√†o pattern b·∫•t ƒë·ªìng b·ªô b·∫°n s·ª≠ d·ª•ng. B√†i h·ªçc nh·∫•n m·∫°nh error-first callbacks l√† m·∫´u ph·ªï bi·∫øn trong core modules c·ªßa Node.js.

	## Error-First Callbacks
		Trong m·∫´u n√†y, tham s·ªë ƒë·∫ßu ti√™n c·ªßa callback lu√¥n l√† err (null n·∫øu kh√¥ng c√≥ l·ªói), theo sau l√† k·∫øt qu·∫£.

const fs = require('fs');

function readConfigFile(filename, callback) {
  fs.readFile(filename, 'utf8', (err, data) => {
    if (err) {
      if (err.code === 'ENOENT') {
        return callback(new Error(`Config file ${filename} not found`));
      } else if (err.code === 'EACCES') {
        return callback(new Error(`No permission to read ${filename}`));
      }
      return callback(err);
    }

    try {
      const config = JSON.parse(data);
      callback(null, config);
    } catch (parseError) {
      callback(new Error(`Invalid JSON in ${filename}`));
    }
  });
}

// S·ª≠ d·ª•ng
readConfigFile('config.json', (err, config) => {
  if (err) {
    console.error('Failed to read config:', err.message);
    return;
  }
  console.log('Config loaded successfully:', config);
});


		- fs.readFile: ƒê·ªçc file b·∫•t ƒë·ªìng b·ªô, callback nh·∫≠n err (n·∫øu c√≥) ho·∫∑c data.
		- Ki·ªÉm tra err.code ƒë·ªÉ x·ª≠ l√Ω l·ªói c·ª• th·ªÉ (ENOENT, EACCES).
		- try/catch trong callback ƒë·ªÉ b·∫Øt l·ªói khi parse JSON.
		- N·∫øu kh√¥ng c√≥ l·ªói, g·ªçi callback(null, config) theo convention (null = no error)

	Insight: Error-first callbacks l√† c√°ch c≈© nh∆∞ng v·∫´n ph·ªï bi·∫øn trong core modules (fs, http). Tuy nhi√™n, ch√∫ng d·ªÖ d·∫´n ƒë·∫øn "callback hell" khi c√≥ nhi·ªÅu thao t√°c l·ªìng nhau. Trong ·ª©ng d·ª•ng m·ªõi, n√™n chuy·ªÉn sang Promises ho·∫∑c async/await ƒë·ªÉ code s·∫°ch h∆°n.



# X·ª≠ l√Ω l·ªói hi·ªán ƒë·∫°i v·ªõi Async/Await
	V·ªõi async/await (ƒë√£ h·ªçc ·ªü b√†i tr∆∞·ªõc), b·∫°n c√≥ th·ªÉ d√πng try/catch ƒë·ªÉ x·ª≠ l√Ω l·ªói c·∫£ ƒë·ªìng b·ªô v√† b·∫•t ƒë·ªìng b·ªô, l√†m code d·ªÖ ƒë·ªçc h∆°n.

	## V√≠ d·ª•: Try/Catch v·ªõi Async/Await

const fs = require('fs').promises;

async function loadUserData(userId) {
  try {
    const data = await fs.readFile(`users/${userId}.json`, 'utf8');
    const user = JSON.parse(data);
    if (!user.email) {
      throw new Error('Invalid user data: missing email');
    }
    return user;
  } catch (error) {
    if (error.code === 'ENOENT') {
      throw new Error(`User ${userId} not found`);
    } else if (error instanceof SyntaxError) {
      throw new Error('Invalid user data format');
    }
    throw error; // Re-throw c√°c l·ªói kh√°c
  } finally {
    console.log(`Finished processing user ${userId}`);
  }
}

// S·ª≠ d·ª•ng
(async () => {
  try {
    const user = await loadUserData(123);
    console.log('User loaded:', user);
  } catch (error) {
    console.error('Failed to load user:', error.message);
  }
})();
	
	
		- fs.promises.readFile: Phi√™n b·∫£n Promise c·ªßa fs.readFile, ph√π h·ª£p v·ªõi async/await.
		- try: Ch·ª©a code c√≥ th·ªÉ throw l·ªói (ƒë·ªçc file, parse JSON, validate email).
		- catch: X·ª≠ l√Ω l·ªói c·ª• th·ªÉ d·ª±a tr√™n error.code ho·∫∑c instanceof.
		- finally: Ch·∫°y b·∫•t k·ªÉ th√†nh c√¥ng hay th·∫•t b·∫°i, h·ªØu √≠ch cho cleanup (ƒë√≥ng file, connection).	
	
		Output v√≠ d·ª• (n·∫øu file kh√¥ng t·ªìn t·∫°i):
	
Finished processing user 123
Failed to load user: User 123 not found

	Insight: Async/await v·ªõi try/catch l√† c√°ch hi·ªán ƒë·∫°i nh·∫•t, ƒë·∫∑c bi·ªát khi l√†m vi·ªác v·ªõi API ho·∫∑c database. Trong API REST, b·∫°n c√≥ th·ªÉ map l·ªói sang HTTP status code (e.g., 404 cho ENOENT). Lu√¥n d√πng finally cho cleanup ƒë·ªÉ tr√°nh resource leaks (nh∆∞ gi·ªØ k·∫øt n·ªëi database m·ªü).
	


# X·ª≠ l√Ω l·ªói to√†n c·ª•c (Global Error Handling)

	M·ªôt s·ªë l·ªói kh√¥ng ƒë∆∞·ª£c b·∫Øt b·ªüi try/catch ho·∫∑c callback, v√≠ d·ª• l·ªói ƒë·ªìng b·ªô trong code ho·∫∑c Promise rejection kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω. Node.js cung c·∫•p hai event ƒë·ªÉ x·ª≠ l√Ω:

		uncaughtException: B·∫Øt l·ªói ƒë·ªìng b·ªô kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω.
		unhandledRejection: B·∫Øt Promise rejection kh√¥ng ƒë∆∞·ª£c catch.


const http = require('http');
const server = http.createServer((req, res) => {});

// X·ª≠ l√Ω uncaughtException
process.on('uncaughtException', (error) => {
  console.error('UNCAUGHT EXCEPTION! Shutting down...');
  console.error(error.name, error.message);
  server.close(() => {
    console.log('Process terminated due to uncaught exception');
    process.exit(1);
  });
});

// X·ª≠ l√Ω unhandledRejection
process.on('unhandledRejection', (reason, promise) => {
  console.error('UNHANDLED REJECTION! Shutting down...');
  console.error('Unhandled Rejection at:', promise, 'Reason:', reason);
  server.close(() => {
    process.exit(1);
  });
});

// G√¢y l·ªói th·ª≠ nghi·ªám
Promise.reject(new Error('Something went wrong'));
setTimeout(() => {
  throw new Error('Uncaught exception after timeout');
}, 1000);


	unhandledRejection: B·∫Øt l·ªói t·ª´ Promise.reject kh√¥ng c√≥ .catch().
	uncaughtException: B·∫Øt l·ªói ƒë·ªìng b·ªô nh∆∞ throw new Error.
	server.close(): ƒê√≥ng server tr∆∞·ªõc khi exit ƒë·ªÉ cleanup.
	
UNHANDLED REJECTION! Shutting down...
Unhandled Rejection at: Promise { <rejected> Error: Something went wrong } Reason: Error: Something went wrong
Process terminated due to uncaught exception

	Insight: Trong production, kh√¥ng n√™n d·ª±a v√†o uncaughtException ƒë·ªÉ ti·∫øp t·ª•c ch·∫°y app, v√¨ tr·∫°ng th√°i app c√≥ th·ªÉ kh√¥ng ·ªïn ƒë·ªãnh sau l·ªói (e.g., memory leak). Thay v√†o ƒë√≥, d√πng process manager nh∆∞ PM2 ƒë·ªÉ t·ª± ƒë·ªông restart app sau crash. Lu√¥n log l·ªói (d√πng logger nh∆∞ Winston) v√† g·ª≠i alert (qua Slack, Sentry) ƒë·ªÉ ƒë·ªôi ng≈© x·ª≠ l√Ω nhanh.



# Best Practices (Th·ª±c h√†nh t·ªët nh·∫•t)

	## Dos
		1. X·ª≠ l√Ω l·ªói ·ªü level ph√π h·ª£p: X·ª≠ l√Ω l·ªói g·∫ßn n∆°i n√≥ x·∫£y ra (e.g., trong middleware Express cho API errors).

		2. Log l·ªói v·ªõi context ƒë·∫ßy ƒë·ªß: Bao g·ªìm stack trace, request info, user ID, v.v. V√≠ d·ª•:
		
		3. D√πng custom error types: T·∫°o class l·ªói ri√™ng ƒë·ªÉ d·ªÖ ph√¢n lo·∫°i v√† x·ª≠ l√Ω (xem ph·∫ßn d∆∞·ªõi).
		
		4.Cleanup trong finally: ƒê√≥ng file, connection, ho·∫∑c clear timeout.
		
		5. Validate input s·ªõm: Ki·ªÉm tra ƒë·∫ßu v√†o ƒë·ªÉ tr√°nh l·ªói (e.g., check userId tr∆∞·ªõc khi query DB).
		
		
		
		
	## 	Don'ts
		1. Kh√¥ng b·ªè qua l·ªói: Tr√°nh catch block r·ªóng (catch (err) {}), v√¨ m·∫•t th√¥ng tin debug.
		
		2. Kh√¥ng l·ªô chi ti·∫øt l·ªói nh·∫°y c·∫£m: Ch·ªâ tr·∫£ th√¥ng b√°o chung chung cho client (e.g., "Internal server error"), log chi ti·∫øt cho developer.
		
		3. Kh√¥ng d√πng try/catch ƒë·ªÉ ƒëi·ªÅu khi·ªÉn lu·ªìng: V√≠ d·ª•, kh√¥ng d√πng l·ªói ƒë·ªÉ check ƒëi·ªÅu ki·ªán logic.
		
		4. Kh√¥ng nu·ªët l·ªói m√† kh√¥ng log: Lu√¥n log tr∆∞·ªõc khi b·ªè qua l·ªói.
		
		5. Kh√¥ng ti·∫øp t·ª•c sau l·ªói nghi√™m tr·ªçng: N·∫øu database disconnect, kh√¥ng c·ªë query ti·∫øp
		
		
		
# Custom Error Types

	T·∫°o class l·ªói t√πy ch·ªânh ƒë·ªÉ ph√¢n lo·∫°i v√† x·ª≠ l√Ω l·ªói d·ªÖ d√†ng h∆°n:

class ValidationError extends Error {
  constructor(message, field) {
    super(message);
    this.name = 'ValidationError';
    this.field = field;
    this.statusCode = 400;
  }
}

class NotFoundError extends Error {
  constructor(resource) {
    super(`${resource} not found`);
    this.name = 'NotFoundError';
    this.statusCode = 404;
  }
}

function getUser(id) {
  if (!id) {
    throw new ValidationError('User ID is required', 'id');
  }
  throw new NotFoundError('User');
}

try {
  getUser(null);
} catch (error) {
  console.error(error.name, error.message, error.statusCode);
  // Output: ValidationError User ID is required 400
}


	Insight: Custom errors r·∫•t h·ªØu √≠ch trong API REST. B·∫°n c√≥ th·ªÉ map statusCode sang HTTP response (e.g., res.status(400).json({ error: err.message })). Trong microservices, d√πng custom errors ƒë·ªÉ ph√¢n bi·ªát gi·ªØa l·ªói nghi·ªáp v·ª• (business logic) v√† l·ªói h·ªá th·ªëng.
	


# T·ªïng k·∫øt v√† L·ªùi khuy√™n

	X·ª≠ l√Ω l·ªói hi·ªáu qu·∫£ l√† y·∫øu t·ªë then ch·ªët ƒë·ªÉ x√¢y d·ª±ng ·ª©ng d·ª•ng Node.js b·ªÅn v·ªØng. D∆∞·ªõi ƒë√¢y l√† t√≥m t·∫Øt v√† m·ªôt s·ªë l·ªùi khuy√™n th·ª±c t·∫ø:

		- Hi·ªÉu lo·∫°i l·ªói: Ph√¢n bi·ªát JavaScript errors (SyntaxError, TypeError) v√† system errors (ENOENT, ECONNREFUSED).
		- S·ª≠ d·ª•ng pattern ph√π h·ª£p: Error-first callbacks cho core modules, try/catch cho async/await.
		- Global handlers: D√πng uncaughtException v√† unhandledRejection ƒë·ªÉ cleanup tr∆∞·ªõc khi crash, nh∆∞ng kh√¥ng l·∫°m d·ª•ng.
		- Best practices: Log l·ªói chi ti·∫øt, d√πng custom errors, validate input, cleanup t√†i nguy√™n.
		- Production tips: D√πng logger (Winston, Pino), monitoring (Sentry, New Relic), v√† process manager (PM2).


	## V√≠ d·ª• th·ª±c t·∫ø trong Express: 


const express = require('express');
const app = express();

app.get('/user/:id', async (req, res, next) => {
  try {
    const id = req.params.id;
    if (!id) throw new ValidationError('User ID is required', 'id');
    const user = await loadUserData(id); // H√†m async ·ªü tr√™n
    res.json(user);
  } catch (error) {
    next(error); // Chuy·ªÉn l·ªói t·ªõi middleware
  }
});

// Error-handling middleware
app.use((error, req, res, next) => {
  console.error(error);
  const status = error.statusCode || 500;
  res.status(status).json({ error: error.message });
});

app.listen(3000);

		
		
</pre><a id='backBottom' href='../NodeJS-learning.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>