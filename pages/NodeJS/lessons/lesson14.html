<html><head><title>Lesson 14 == Module ESM ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../NodeJS-learning.html'>ðŸ”™ Quay láº¡i danh sÃ¡ch</a><br><h1>Lesson 14 -- Module ESM -//</h1><pre>

# Giá»›i thiá»‡u vá» ES Modules

	ES Modules lÃ  chuáº©n chÃ­nh thá»©c Ä‘á»ƒ Ä‘Ã³ng gÃ³i vÃ  tÃ¡i sá»­ dá»¥ng code JavaScript, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ thay tháº¿ CommonJS trong cÃ¡c á»©ng dá»¥ng hiá»‡n Ä‘áº¡i. ESM cÃ³ cÃ¡c lá»£i Ã­ch chÃ­nh:

		- CÃº phÃ¡p rÃµ rÃ ng: DÃ¹ng import/export thay vÃ¬ require/module.exports.
		- PhÃ¢n tÃ­ch tÄ©nh: Compiler cÃ³ thá»ƒ phÃ¢n tÃ­ch import/export trÆ°á»›c khi cháº¡y, há»— trá»£ tree-shaking (loáº¡i bá» code khÃ´ng dÃ¹ng, giáº£m kÃ­ch thÆ°á»›c bundle).
		- Top-level await: Cho phÃ©p dÃ¹ng await ngoÃ i hÃ m async, há»¯u Ã­ch cho viá»‡c khá»Ÿi táº¡o module.
		- Chuáº©n hÃ³a: ESM lÃ  chuáº©n chung cá»§a JavaScript, hoáº¡t Ä‘á»™ng cáº£ trong trÃ¬nh duyá»‡t vÃ  Node.js.

		Node.js trÆ°á»›c Ä‘Ã¢y chá»‰ há»— trá»£ CommonJS, nhÆ°ng tá»« phiÃªn báº£n 12, ESM Ä‘Æ°á»£c tÃ­ch há»£p, vÃ  tá»« phiÃªn báº£n 14, nÃ³ trá»Ÿ nÃªn á»•n Ä‘á»‹nh hÆ¡n. Báº¡n cÃ³ thá»ƒ chá»n giá»¯a CommonJS vÃ  ESM tÃ¹y thuá»™c vÃ o nhu cáº§u dá»± Ã¡n.

		Insight: ESM lÃ  lá»±a chá»n tá»‘t cho dá»± Ã¡n má»›i, Ä‘áº·c biá»‡t khi tÃ­ch há»£p vá»›i frontend (React, Vue) hoáº·c dÃ¹ng cÃ¡c cÃ´ng cá»¥ nhÆ° Vite/Webpack (há»— trá»£ tree-shaking). Tuy nhiÃªn, CommonJS váº«n phá»• biáº¿n trong cÃ¡c dá»± Ã¡n legacy hoáº·c khi lÃ m viá»‡c vá»›i thÆ° viá»‡n chÆ°a há»— trá»£ ESM tá»‘t.


# So sÃ¡nh CommonJS vÃ  ES Modules



Feature,CommonJS,ES Modules
File Extension,.js (máº·c Ä‘á»‹nh),.mjs hoáº·c .js (vá»›i config)
Import Syntax,require(),import
Export Syntax,module.exports / exports,export / export default
Import Timing,Dynamic (runtime),Static (parsed trÆ°á»›c khi cháº¡y)
Top-level Await,KhÃ´ng há»— trá»£,Há»— trá»£
File URL,KhÃ´ng cáº§n .js trong require,Cáº§n .mjs hoáº·c .js trong import


	## VÃ­ dá»¥: CommonJS

	math.js
function add(a, b) {
  return a + b;
}
function subtract(a, b) {
  return a - b;
}
module.exports = { add, subtract };


	app.js
const math = require('./math');
console.log(math.add(5, 3)); // 8




	## VÃ­ dá»¥: ES Modules
		math.mjs

export function add(a, b) {
  return a + b;
}
export function subtract(a, b) {
  return a - b;
}

		app.mjs
		
import { add, subtract } from './math.mjs';
console.log(add(5, 3)); // 8



	CommonJS dÃ¹ng require vÃ  module.exports, khÃ´ng cáº§n file extension (./math thay vÃ¬ ./math.js).
	ESM dÃ¹ng import/export, yÃªu cáº§u file extension (./math.mjs hoáº·c ./math.js náº¿u config Ä‘Ãºng).
	ESM phÃ¢n tÃ­ch import tÄ©nh, giÃºp cÃ´ng cá»¥ nhÆ° Webpack tá»‘i Æ°u hÃ³a bundle.

	Insight: ESM yÃªu cáº§u khai bÃ¡o import/export rÃµ rÃ ng, giÃºp code dá»… Ä‘oÃ¡n hÆ¡n. Tuy nhiÃªn, viá»‡c báº¯t buá»™c dÃ¹ng file extension cÃ³ thá»ƒ gÃ¢y phiá»n hÃ  trong dá»± Ã¡n lá»›n, trá»« khi báº¡n cáº¥u hÃ¬nh package.json Ä‘Ãºng cÃ¡ch.




# CÃ¡ch kÃ­ch hoáº¡t ES Modules trong Node.js

	Äá»ƒ sá»­ dá»¥ng ESM, báº¡n cáº§n cáº¥u hÃ¬nh Node.js Ä‘á»ƒ nháº­n diá»‡n file hoáº·c project nhÆ° ESM. BÃ i há»c liá»‡t kÃª ba cÃ¡ch:

	## 1. Sá»­ dá»¥ng Ä‘uÃ´i .mjs

File vá»›i Ä‘uÃ´i .mjs Ä‘Æ°á»£c Node.js tá»± Ä‘á»™ng coi lÃ  ESM. ÄÃ¢y lÃ  cÃ¡ch Ä‘Æ¡n giáº£n nháº¥t, khÃ´ng cáº§n cáº¥u hÃ¬nh thÃªm.

// math.mjs
export const add = (a, b) => a + b;

// app.mjs
import { add } from './math.mjs';
console.log(add(2, 3)); // 5



	## 2. Cáº¥u hÃ¬nh "type": "module" trong package.json
		ThÃªm dÃ²ng "type": "module" vÃ o package.json Ä‘á»ƒ táº¥t cáº£ file .js trong dá»± Ã¡n Ä‘Æ°á»£c coi lÃ  ESM.

{
  "name": "my-app",
  "version": "1.0.0",
  "type": "module"
}


// math.js
export const add = (a, b) => a + b;

// app.js
import { add } from './math.js';
console.log(add(2, 3)); // 5




	## 3. DÃ¹ng cá» --input-type=module
	Cháº¡y file vá»›i lá»‡nh:
		node --input-type=module script.js


Insight: CÃ¡ch .mjs phÃ¹ há»£p cho dá»± Ã¡n nhá» hoáº·c khi mix CommonJS vÃ  ESM. CÃ¡ch "type": "module" lÃ½ tÆ°á»Ÿng cho dá»± Ã¡n má»›i, nhÆ°ng cáº§n Ä‘áº£m báº£o táº¥t cáº£ file Ä‘á»u tuÃ¢n theo ESM (file .js khÃ´ng cÃ³ "type": "module" sáº½ lÃ  CommonJS). Náº¿u dá»± Ã¡n lá»›n, hÃ£y dÃ¹ng .mjs cho ESM vÃ  .cjs cho CommonJS Ä‘á»ƒ trÃ¡nh nháº§m láº«n.




# CÃº phÃ¡p Import vÃ  Export
	ESM cung cáº¥p cÃº phÃ¡p linh hoáº¡t hÆ¡n CommonJS. TÃ´i sáº½ giáº£i thÃ­ch cÃ¡c kiá»ƒu export/import vá»›i vÃ­ dá»¥.


	## Export Syntax

		### 1. Named Exports 
		
			Export tá»«ng hÃ m/biáº¿n riÃªng láº» hoáº·c danh sÃ¡ch cuá»‘i file.

// greetings.mjs
export function sayHello() {
  console.log('Hello');
}

export function sayGoodbye() {
  console.log('Goodbye');
}

// Hoáº·c export danh sÃ¡ch
function add(a, b) {
  return a + b;
}
function subtract(a, b) {
  return a - b;
}
export { add, subtract };





		### 2. Default Export
			Chá»‰ má»™t default export trÃªn má»—i module, thÆ°á»ng dÃ¹ng cho chá»©c nÄƒng chÃ­nh.

// main.mjs
export default function mainFunction() {
  console.log('I am the default export');
}




		### Mixed Exports
			Káº¿t há»£p default vÃ  named exports.

// main.mjs
export const VERSION = '1.0.0';
function main() {
  console.log('Main function');
}
export { main as default };






	## Import Syntax

		### Importing Named Exports 
		
// app.mjs
import { sayHello, sayGoodbye } from './greetings.mjs';
sayHello(); // Hello

// Äá»•i tÃªn Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t
import { add as sum, subtract as minus } from './math.mjs';
console.log(sum(5, 3)); // 8

// Import toÃ n bá»™ nhÆ° object
import * as math from './math.mjs';
console.log(math.add(7, 4)); // 11		






		### Importing Default Exports

// app.mjs
import mainFunction from './main.mjs';
mainFunction(); // I am the default export

// Default import cÃ³ thá»ƒ Ä‘áº·t tÃªn tÃ¹y Ã½
import anyName from './main.mjs';
anyName();





		### Importing Both 

import main, { VERSION } from './main.mjs';
console.log(VERSION); // 1.0.0
main(); // Main function

		Insight: Named exports tá»‘t cho utilities (nhiá»u hÃ m), default exports phÃ¹ há»£p cho class hoáº·c object chÃ­nh cá»§a module. TrÃ¡nh láº¡m dá»¥ng default exports trong thÆ° viá»‡n lá»›n Ä‘á»ƒ dá»… refactor.





# Dynamic Imports
	ESM há»— trá»£ dynamic imports, cho phÃ©p load module theo Ä‘iá»u kiá»‡n hoáº·c on-demand, tráº£ vá» Promise.



	## VÃ­ dá»¥: Dynamic Imports

// app.mjs
async function loadModule(moduleName) {
  try {
    const module = await import(`./${moduleName}.mjs`);
    return module;
  } catch (error) {
    console.error(`Failed to load ${moduleName}:`, error);
  }
}

const moduleName = process.env.NODE_ENV === 'production' ? 'prod' : 'dev';
loadModule(moduleName).then(module => {
  module.default();
});

(async () => {
  const mathModule = await import('./math.mjs');
  console.log(mathModule.add(10, 5)); // 15
})();


	import() tráº£ vá» Promise, cho phÃ©p load module báº¥t Ä‘á»“ng bá»™.
	Há»¯u Ã­ch cho code-splitting (táº£i code theo nhu cáº§u) hoáº·c load module theo Ä‘iá»u kiá»‡n (prod/dev).


	Insight: Dynamic imports ráº¥t máº¡nh trong á»©ng dá»¥ng lá»›n (nhÆ° SPA vá»›i React/Vue) Ä‘á»ƒ giáº£m thá»i gian táº£i ban Ä‘áº§u. Trong Node.js, nÃ³ há»¯u Ã­ch khi cáº§n load module dá»±a trÃªn config hoáº·c mÃ´i trÆ°á»ng.



# Top-level Await

	ESM cho phÃ©p dÃ¹ng await ngoÃ i hÃ m async, táº¡i cáº¥p module (top-level), Ä‘iá»u mÃ  CommonJS khÃ´ng há»— trá»£.

// data-loader.mjs
console.log('Loading data...');
const response = await fetch('https://jsonplaceholder.typicode.com/todos/1');
const data = await response.json();
console.log('Data loaded!');
export { data };


	await táº¡i top-level táº¡m dá»«ng thá»±c thi module cho Ä‘áº¿n khi Promise resolve.
	Há»¯u Ã­ch cho: load config, káº¿t ná»‘i database, hoáº·c khá»Ÿi táº¡o module.

	Insight: Top-level await lÃ½ tÆ°á»Ÿng cho viá»‡c khá»Ÿi táº¡o á»©ng dá»¥ng (e.g., káº¿t ná»‘i MongoDB trÆ°á»›c khi export service). Tuy nhiÃªn, dÃ¹ng cáº©n tháº­n vÃ¬ nÃ³ lÃ m module load cháº­m hÆ¡n, áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c module import nÃ³.





# Best Practices



	## 1. LuÃ´n dÃ¹ng file extension: 

import { add } from './utils.mjs'; // Tá»‘t
import { add } from './utils'; // Xáº¥u, cÃ³ thá»ƒ lá»—i

	LÃ½ do: ESM yÃªu cáº§u Ä‘Æ°á»ng dáº«n rÃµ rÃ ng Ä‘á»ƒ phÃ¢n tÃ­ch tÄ©nh.



	## 2.DÃ¹ng index.mjs cho thÆ° má»¥c:

// utils/index.mjs
export * from './string-utils.mjs';
export * from './number-utils.mjs';

// app.mjs
import { formatString, add } from './utils/index.mjs';

	GiÃºp tá»• chá»©c module gá»n gÃ ng.



	## 3. GiÃºp tá»• chá»©c module gá»n gÃ ng. 

		Named exports cho utilities.
		Default exports cho class hoáº·c chá»©c nÄƒng chÃ­nh.

// utilities.mjs
export function validate() { /* ... */ }
export function format() { /* ... */ }

// UserService.mjs
export default class UserService { /* ... */ }




	## 4. Xá»­ lÃ½ chuyá»ƒn Ä‘á»•i tá»« CommonJS: 
		ESM cÃ³ thá»ƒ import CommonJS:

import fs from 'fs'; // default import lÃ  module.exports


		CommonJS import ESM qua dynamic import
(async () => {
  const { default: module } = await import('./module.mjs');
})();





	## Dual Package Hazard:
Äá»ƒ há»— trá»£ cáº£ ESM vÃ  CommonJS, dÃ¹ng "exports" trong package.json:


{
  "exports": {
    ".": {
      "import": "./index.mjs",
      "require": "./index.cjs"
    }
  }
}

	Insight: Trong dá»± Ã¡n lá»›n, dÃ¹ng index.mjs Ä‘á»ƒ tá»• chá»©c module theo feature (e.g., users/index.mjs). Náº¿u mix ESM vÃ  CommonJS, hÃ£y test ká»¹ Ä‘á»ƒ trÃ¡nh lá»—i runtime (nhÆ° require ESM khÃ´ng Ä‘Ãºng cÃ¡ch). DÃ¹ng TypeScript vá»›i ESM Ä‘á»ƒ tÄƒng type safety.




# Tá»•ng káº¿t vÃ  Lá»i khuyÃªn

	ESM lÃ  bÆ°á»›c tiáº¿n lá»›n trong Node.js, mang láº¡i cÃº phÃ¡p hiá»‡n Ä‘áº¡i vÃ  tÃ­nh nÄƒng máº¡nh máº½. Key takeaways:

		- ESM vs CommonJS: ESM cÃ³ cÃº phÃ¡p chuáº©n, há»— trá»£ tree-shaking, top-level await.
		- KÃ­ch hoáº¡t ESM: DÃ¹ng .mjs, "type": "module", hoáº·c cá» --input-type=module.
		- Import/Export: Named exports cho utilities, default exports cho chá»©c nÄƒng chÃ­nh.
		- Dynamic Imports: Táº£i module theo nhu cáº§u, giáº£m thá»i gian load.
		- Top-level Await: Khá»Ÿi táº¡o module báº¥t Ä‘á»“ng bá»™, nhÆ°ng dÃ¹ng cáº©n tháº­n.


	## VÃ­ dá»¥ thá»±c táº¿ vá»›i Express:

// routes/users.mjs
import express from 'express';
const router = express.Router();

router.get('/:id', (req, res) => {
  res.json({ id: req.params.id });
});

export default router;

// app.mjs
import express from 'express';
import userRoutes from './routes/users.mjs';

const app = express();
app.use('/users', userRoutes);
app.listen(3000, () => console.log('Server running'));



</pre><a id='backBottom' href='../NodeJS-learning.html' style='display:none;'>ðŸ”™ Quay láº¡i danh sÃ¡ch</a><br><button onclick='toggleTheme()'>ðŸŒ™ Chuyá»ƒn giao diá»‡n</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>