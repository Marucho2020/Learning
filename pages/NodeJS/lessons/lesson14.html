<html><head><title>Lesson 14 == Module ESM ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../NodeJS-learning.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 14 -- Module ESM -//</h1><pre>

# Gi·ªõi thi·ªáu v·ªÅ ES Modules

	ES Modules l√† chu·∫©n ch√≠nh th·ª©c ƒë·ªÉ ƒë√≥ng g√≥i v√† t√°i s·ª≠ d·ª•ng code JavaScript, ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ thay th·∫ø CommonJS trong c√°c ·ª©ng d·ª•ng hi·ªán ƒë·∫°i. ESM c√≥ c√°c l·ª£i √≠ch ch√≠nh:

		- C√∫ ph√°p r√µ r√†ng: D√πng import/export thay v√¨ require/module.exports.
		- Ph√¢n t√≠ch tƒ©nh: Compiler c√≥ th·ªÉ ph√¢n t√≠ch import/export tr∆∞·ªõc khi ch·∫°y, h·ªó tr·ª£ tree-shaking (lo·∫°i b·ªè code kh√¥ng d√πng, gi·∫£m k√≠ch th∆∞·ªõc bundle).
		- Top-level await: Cho ph√©p d√πng await ngo√†i h√†m async, h·ªØu √≠ch cho vi·ªác kh·ªüi t·∫°o module.
		- Chu·∫©n h√≥a: ESM l√† chu·∫©n chung c·ªßa JavaScript, ho·∫°t ƒë·ªông c·∫£ trong tr√¨nh duy·ªát v√† Node.js.

		Node.js tr∆∞·ªõc ƒë√¢y ch·ªâ h·ªó tr·ª£ CommonJS, nh∆∞ng t·ª´ phi√™n b·∫£n 12, ESM ƒë∆∞·ª£c t√≠ch h·ª£p, v√† t·ª´ phi√™n b·∫£n 14, n√≥ tr·ªü n√™n ·ªïn ƒë·ªãnh h∆°n. B·∫°n c√≥ th·ªÉ ch·ªçn gi·ªØa CommonJS v√† ESM t√πy thu·ªôc v√†o nhu c·∫ßu d·ª± √°n.

		Insight: ESM l√† l·ª±a ch·ªçn t·ªët cho d·ª± √°n m·ªõi, ƒë·∫∑c bi·ªát khi t√≠ch h·ª£p v·ªõi frontend (React, Vue) ho·∫∑c d√πng c√°c c√¥ng c·ª• nh∆∞ Vite/Webpack (h·ªó tr·ª£ tree-shaking). Tuy nhi√™n, CommonJS v·∫´n ph·ªï bi·∫øn trong c√°c d·ª± √°n legacy ho·∫∑c khi l√†m vi·ªác v·ªõi th∆∞ vi·ªán ch∆∞a h·ªó tr·ª£ ESM t·ªët.


# So s√°nh CommonJS v√† ES Modules



Feature,CommonJS,ES Modules
File Extension,.js (m·∫∑c ƒë·ªãnh),.mjs ho·∫∑c .js (v·ªõi config)
Import Syntax,require(),import
Export Syntax,module.exports / exports,export / export default
Import Timing,Dynamic (runtime),Static (parsed tr∆∞·ªõc khi ch·∫°y)
Top-level Await,Kh√¥ng h·ªó tr·ª£,H·ªó tr·ª£
File URL,Kh√¥ng c·∫ßn .js trong require,C·∫ßn .mjs ho·∫∑c .js trong import


	## V√≠ d·ª•: CommonJS

	math.js
function add(a, b) {
  return a + b;
}
function subtract(a, b) {
  return a - b;
}
module.exports = { add, subtract };


	app.js
const math = require('./math');
console.log(math.add(5, 3)); // 8




	## V√≠ d·ª•: ES Modules
		math.mjs

export function add(a, b) {
  return a + b;
}
export function subtract(a, b) {
  return a - b;
}

		app.mjs
		
import { add, subtract } from './math.mjs';
console.log(add(5, 3)); // 8



	CommonJS d√πng require v√† module.exports, kh√¥ng c·∫ßn file extension (./math thay v√¨ ./math.js).
	ESM d√πng import/export, y√™u c·∫ßu file extension (./math.mjs ho·∫∑c ./math.js n·∫øu config ƒë√∫ng).
	ESM ph√¢n t√≠ch import tƒ©nh, gi√∫p c√¥ng c·ª• nh∆∞ Webpack t·ªëi ∆∞u h√≥a bundle.

	Insight: ESM y√™u c·∫ßu khai b√°o import/export r√µ r√†ng, gi√∫p code d·ªÖ ƒëo√°n h∆°n. Tuy nhi√™n, vi·ªác b·∫Øt bu·ªôc d√πng file extension c√≥ th·ªÉ g√¢y phi·ªÅn h√† trong d·ª± √°n l·ªõn, tr·ª´ khi b·∫°n c·∫•u h√¨nh package.json ƒë√∫ng c√°ch.




# C√°ch k√≠ch ho·∫°t ES Modules trong Node.js

	ƒê·ªÉ s·ª≠ d·ª•ng ESM, b·∫°n c·∫ßn c·∫•u h√¨nh Node.js ƒë·ªÉ nh·∫≠n di·ªán file ho·∫∑c project nh∆∞ ESM. B√†i h·ªçc li·ªát k√™ ba c√°ch:

	## 1. S·ª≠ d·ª•ng ƒëu√¥i .mjs

File v·ªõi ƒëu√¥i .mjs ƒë∆∞·ª£c Node.js t·ª± ƒë·ªông coi l√† ESM. ƒê√¢y l√† c√°ch ƒë∆°n gi·∫£n nh·∫•t, kh√¥ng c·∫ßn c·∫•u h√¨nh th√™m.

// math.mjs
export const add = (a, b) => a + b;

// app.mjs
import { add } from './math.mjs';
console.log(add(2, 3)); // 5



	## 2. C·∫•u h√¨nh "type": "module" trong package.json
		Th√™m d√≤ng "type": "module" v√†o package.json ƒë·ªÉ t·∫•t c·∫£ file .js trong d·ª± √°n ƒë∆∞·ª£c coi l√† ESM.

{
  "name": "my-app",
  "version": "1.0.0",
  "type": "module"
}


// math.js
export const add = (a, b) => a + b;

// app.js
import { add } from './math.js';
console.log(add(2, 3)); // 5




	## 3. D√πng c·ªù --input-type=module
	Ch·∫°y file v·ªõi l·ªánh:
		node --input-type=module script.js


Insight: C√°ch .mjs ph√π h·ª£p cho d·ª± √°n nh·ªè ho·∫∑c khi mix CommonJS v√† ESM. C√°ch "type": "module" l√Ω t∆∞·ªüng cho d·ª± √°n m·ªõi, nh∆∞ng c·∫ßn ƒë·∫£m b·∫£o t·∫•t c·∫£ file ƒë·ªÅu tu√¢n theo ESM (file .js kh√¥ng c√≥ "type": "module" s·∫Ω l√† CommonJS). N·∫øu d·ª± √°n l·ªõn, h√£y d√πng .mjs cho ESM v√† .cjs cho CommonJS ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n.




# C√∫ ph√°p Import v√† Export
	ESM cung c·∫•p c√∫ ph√°p linh ho·∫°t h∆°n CommonJS. T√¥i s·∫Ω gi·∫£i th√≠ch c√°c ki·ªÉu export/import v·ªõi v√≠ d·ª•.


	## Export Syntax

		### 1. Named Exports 
		
			Export t·ª´ng h√†m/bi·∫øn ri√™ng l·∫ª ho·∫∑c danh s√°ch cu·ªëi file.

// greetings.mjs
export function sayHello() {
  console.log('Hello');
}

export function sayGoodbye() {
  console.log('Goodbye');
}

// Ho·∫∑c export danh s√°ch
function add(a, b) {
  return a + b;
}
function subtract(a, b) {
  return a - b;
}
export { add, subtract };





		### 2. Default Export
			Ch·ªâ m·ªôt default export tr√™n m·ªói module, th∆∞·ªùng d√πng cho ch·ª©c nƒÉng ch√≠nh.

// main.mjs
export default function mainFunction() {
  console.log('I am the default export');
}




		### Mixed Exports
			K·∫øt h·ª£p default v√† named exports.

// main.mjs
export const VERSION = '1.0.0';
function main() {
  console.log('Main function');
}
export { main as default };






	## Import Syntax

		### Importing Named Exports 
		
// app.mjs
import { sayHello, sayGoodbye } from './greetings.mjs';
sayHello(); // Hello

// ƒê·ªïi t√™n ƒë·ªÉ tr√°nh xung ƒë·ªôt
import { add as sum, subtract as minus } from './math.mjs';
console.log(sum(5, 3)); // 8

// Import to√†n b·ªô nh∆∞ object
import * as math from './math.mjs';
console.log(math.add(7, 4)); // 11		






		### Importing Default Exports

// app.mjs
import mainFunction from './main.mjs';
mainFunction(); // I am the default export

// Default import c√≥ th·ªÉ ƒë·∫∑t t√™n t√πy √Ω
import anyName from './main.mjs';
anyName();





		### Importing Both 

import main, { VERSION } from './main.mjs';
console.log(VERSION); // 1.0.0
main(); // Main function

		Insight: Named exports t·ªët cho utilities (nhi·ªÅu h√†m), default exports ph√π h·ª£p cho class ho·∫∑c object ch√≠nh c·ªßa module. Tr√°nh l·∫°m d·ª•ng default exports trong th∆∞ vi·ªán l·ªõn ƒë·ªÉ d·ªÖ refactor.





# Dynamic Imports
	ESM h·ªó tr·ª£ dynamic imports, cho ph√©p load module theo ƒëi·ªÅu ki·ªán ho·∫∑c on-demand, tr·∫£ v·ªÅ Promise.



	## V√≠ d·ª•: Dynamic Imports

// app.mjs
async function loadModule(moduleName) {
  try {
    const module = await import(`./${moduleName}.mjs`);
    return module;
  } catch (error) {
    console.error(`Failed to load ${moduleName}:`, error);
  }
}

const moduleName = process.env.NODE_ENV === 'production' ? 'prod' : 'dev';
loadModule(moduleName).then(module => {
  module.default();
});

(async () => {
  const mathModule = await import('./math.mjs');
  console.log(mathModule.add(10, 5)); // 15
})();


	import() tr·∫£ v·ªÅ Promise, cho ph√©p load module b·∫•t ƒë·ªìng b·ªô.
	H·ªØu √≠ch cho code-splitting (t·∫£i code theo nhu c·∫ßu) ho·∫∑c load module theo ƒëi·ªÅu ki·ªán (prod/dev).


	Insight: Dynamic imports r·∫•t m·∫°nh trong ·ª©ng d·ª•ng l·ªõn (nh∆∞ SPA v·ªõi React/Vue) ƒë·ªÉ gi·∫£m th·ªùi gian t·∫£i ban ƒë·∫ßu. Trong Node.js, n√≥ h·ªØu √≠ch khi c·∫ßn load module d·ª±a tr√™n config ho·∫∑c m√¥i tr∆∞·ªùng.



# Top-level Await

	ESM cho ph√©p d√πng await ngo√†i h√†m async, t·∫°i c·∫•p module (top-level), ƒëi·ªÅu m√† CommonJS kh√¥ng h·ªó tr·ª£.

// data-loader.mjs
console.log('Loading data...');
const response = await fetch('https://jsonplaceholder.typicode.com/todos/1');
const data = await response.json();
console.log('Data loaded!');
export { data };


	await t·∫°i top-level t·∫°m d·ª´ng th·ª±c thi module cho ƒë·∫øn khi Promise resolve.
	H·ªØu √≠ch cho: load config, k·∫øt n·ªëi database, ho·∫∑c kh·ªüi t·∫°o module.

	Insight: Top-level await l√Ω t∆∞·ªüng cho vi·ªác kh·ªüi t·∫°o ·ª©ng d·ª•ng (e.g., k·∫øt n·ªëi MongoDB tr∆∞·ªõc khi export service). Tuy nhi√™n, d√πng c·∫©n th·∫≠n v√¨ n√≥ l√†m module load ch·∫≠m h∆°n, ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c module import n√≥.





# Best Practices



	## 1. Lu√¥n d√πng file extension: 

import { add } from './utils.mjs'; // T·ªët
import { add } from './utils'; // X·∫•u, c√≥ th·ªÉ l·ªói

	L√Ω do: ESM y√™u c·∫ßu ƒë∆∞·ªùng d·∫´n r√µ r√†ng ƒë·ªÉ ph√¢n t√≠ch tƒ©nh.



	## 2.D√πng index.mjs cho th∆∞ m·ª•c:

// utils/index.mjs
export * from './string-utils.mjs';
export * from './number-utils.mjs';

// app.mjs
import { formatString, add } from './utils/index.mjs';

	Gi√∫p t·ªï ch·ª©c module g·ªçn g√†ng.



	## 3. Gi√∫p t·ªï ch·ª©c module g·ªçn g√†ng. 

		Named exports cho utilities.
		Default exports cho class ho·∫∑c ch·ª©c nƒÉng ch√≠nh.

// utilities.mjs
export function validate() { /* ... */ }
export function format() { /* ... */ }

// UserService.mjs
export default class UserService { /* ... */ }




	## 4. X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi t·ª´ CommonJS: 
		ESM c√≥ th·ªÉ import CommonJS:

import fs from 'fs'; // default import l√† module.exports


		CommonJS import ESM qua dynamic import
(async () => {
  const { default: module } = await import('./module.mjs');
})();





	## Dual Package Hazard:
ƒê·ªÉ h·ªó tr·ª£ c·∫£ ESM v√† CommonJS, d√πng "exports" trong package.json:


{
  "exports": {
    ".": {
      "import": "./index.mjs",
      "require": "./index.cjs"
    }
  }
}

	Insight: Trong d·ª± √°n l·ªõn, d√πng index.mjs ƒë·ªÉ t·ªï ch·ª©c module theo feature (e.g., users/index.mjs). N·∫øu mix ESM v√† CommonJS, h√£y test k·ªπ ƒë·ªÉ tr√°nh l·ªói runtime (nh∆∞ require ESM kh√¥ng ƒë√∫ng c√°ch). D√πng TypeScript v·ªõi ESM ƒë·ªÉ tƒÉng type safety.




# T·ªïng k·∫øt v√† L·ªùi khuy√™n

	ESM l√† b∆∞·ªõc ti·∫øn l·ªõn trong Node.js, mang l·∫°i c√∫ ph√°p hi·ªán ƒë·∫°i v√† t√≠nh nƒÉng m·∫°nh m·∫Ω. Key takeaways:

		- ESM vs CommonJS: ESM c√≥ c√∫ ph√°p chu·∫©n, h·ªó tr·ª£ tree-shaking, top-level await.
		- K√≠ch ho·∫°t ESM: D√πng .mjs, "type": "module", ho·∫∑c c·ªù --input-type=module.
		- Import/Export: Named exports cho utilities, default exports cho ch·ª©c nƒÉng ch√≠nh.
		- Dynamic Imports: T·∫£i module theo nhu c·∫ßu, gi·∫£m th·ªùi gian load.
		- Top-level Await: Kh·ªüi t·∫°o module b·∫•t ƒë·ªìng b·ªô, nh∆∞ng d√πng c·∫©n th·∫≠n.


	## V√≠ d·ª• th·ª±c t·∫ø v·ªõi Express:

// routes/users.mjs
import express from 'express';
const router = express.Router();

router.get('/:id', (req, res) => {
  res.json({ id: req.params.id });
});

export default router;

// app.mjs
import express from 'express';
import userRoutes from './routes/users.mjs';

const app = express();
app.use('/users', userRoutes);
app.listen(3000, () => console.log('Server running'));



</pre><a id='backBottom' href='../NodeJS-learning.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>