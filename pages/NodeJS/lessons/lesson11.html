<html><head><title>Lesson 11 == Async/Await ==========//</title><style>body { font-family: Arial, sans-serif; transition: background 0.3s, color 0.3s; }.dark-mode { background-color: #121212; color: #e0e0e0; }.light-mode { background-color: #ffffff; color: #333333; }h1 { text-align: center; color: #73d9f5; }pre { padding: 15px; border-radius: 5px;       white-space: pre-wrap; word-wrap: break-word;       overflow-x: auto; max-width: 100%;       transition: background 0.3s, color 0.3s; }.dark-mode pre { background: #1e1e1e; color: #e0e0e0; }.light-mode pre { background: #f5f5f5; color: #333333; }#backTop, #backBottom {    font-size: 2em; padding: 20px 40px;    background: #bb86fc; color: white; text-decoration: none;    border-radius: 10px; display: inline-block; text-align: center; }#backTop:hover, #backBottom:hover { background: #9b67e2; }button { font-size: 1.5em; padding: 15px 30px;    background: #03dac6; color: #121212; border: none;    cursor: pointer; border-radius: 5px; display: block; margin: 10px auto; }button:hover { background: #02b8a3; }.dark-mode a { color: #03dac6; } .light-mode a { color: #007bff; }</style></head><body onload='applyTheme(); checkPageHeight()'><div class='container'><a id='backTop' href='../NodeJS-learning.html'>üîô Quay l·∫°i danh s√°ch</a><br><h1>Lesson 11 -- Async/Await -//</h1><pre>
# Kh√°i ni·ªám  
	
	Async/await kh√¥ng l√†m thay ƒë·ªïi c√°ch Node.js ho·∫°t ƒë·ªông (v·∫´n b·∫•t ƒë·ªìng b·ªô, kh√¥ng block main thread), m√† ch·ªâ l√†m code tr√¥ng gi·ªëng code ƒë·ªìng b·ªô h∆°n, gi√∫p tr√°nh "callback hell" v√† l√†m code d·ªÖ debug. H√£y t∆∞·ªüng t∆∞·ª£ng b·∫°n vi·∫øt code nh∆∞ ƒëang ƒë·ªçc m·ªôt c√¢u chuy·ªán tuy·∫øn t√≠nh, thay v√¨ l·ªìng gh√©p nhi·ªÅu l·ªõp callback ho·∫∑c then().


# C√∫ ph√°p v√† S·ª≠ d·ª•ng C∆° b·∫£n

	Async/await bao g·ªìm hai t·ª´ kh√≥a ch√≠nh:

		async: ƒê·∫∑t tr∆∞·ªõc m·ªôt h√†m ƒë·ªÉ bi·∫øn n√≥ th√†nh h√†m b·∫•t ƒë·ªìng b·ªô. H√†m async lu√¥n tr·∫£ v·ªÅ m·ªôt Promise (d√π b·∫°n c√≥ return gi√° tr·ªã g√¨ ƒëi n·ªØa).
		
		await: Ch·ªâ d√πng b√™n trong h√†m async, n√≥ "d·ª´ng" th·ª±c thi h√†m cho ƒë·∫øn khi Promise resolve (ho√†n th√†nh), r·ªìi l·∫•y gi√° tr·ªã resolve ƒë√≥. Await kh√¥ng block to√†n b·ªô ch∆∞∆°ng tr√¨nh ‚Äì Node.js v·∫´n x·ª≠ l√Ω c√°c task kh√°c trong l√∫c ch·ªù.



	## V√≠ d·ª• C∆° b·∫£n: Async/Await ƒë∆°n gi·∫£n

async function getData() {
  console.log('Starting...');
  const result = await someAsyncOperation();
  console.log(`Result: ${result}`);
  return result;
}

function someAsyncOperation() {
  return new Promise(resolve => {
    setTimeout(() => resolve('Operation completed'), 1000);
  });
}

// G·ªçi h√†m async
getData().then(data => console.log('Final data:', data));



	Starting...
Result: Operation completed
Final data: Operation completed


	getData().then(): V√¨ getData tr·∫£ v·ªÅ Promise, b·∫°n c√≥ th·ªÉ chain .then() ƒë·ªÉ x·ª≠ l√Ω k·∫øt qu·∫£ cu·ªëi c√πng.


	Insight chuy√™n s√¢u: Trong th·ª±c t·∫ø, async/await r·∫•t h·ªØu √≠ch cho c√°c API call ho·∫∑c ƒë·ªçc file. V√≠ d·ª•, n·∫øu kh√¥ng d√πng await, b·∫°n ph·∫£i d√πng .then() l·ªìng nhau, l√†m code d√†i d√≤ng. Async/await gi√∫p code "ph·∫≥ng" h∆°n, d·ªÖ ƒë·ªçc cho team l·ªõn.




	## V√≠ d·ª• Th·ª±c t·∫ø: ƒê·ªçc File v·ªõi Async/Await

		fs.promises: ƒê√¢y l√† phi√™n b·∫£n Promise c·ªßa module fs (File System). N·∫øu d√πng fs th√¥ng th∆∞·ªùng (callback-based), b·∫°n ph·∫£i convert sang Promise b·∫±ng util.promisify.
		await fs.readFile(): Ch·ªù ƒë·ªçc file ho√†n t·∫•t, l·∫•y n·ªôi dung d∆∞·ªõi d·∫°ng string UTF-8.
		L·ª£i √≠ch: Code tr√¥ng nh∆∞ ƒë·ªçc file ƒë·ªìng b·ªô, nh∆∞ng th·ª±c t·∫ø b·∫•t ƒë·ªìng b·ªô.




# X·ª≠ L√Ω L·ªói v·ªõi Try/Catch

	Async/await cho ph√©p d√πng try/catch nh∆∞ code ƒë·ªìng b·ªô, thay v√¨ .catch() l·ªìng gh√©p. ƒê√¢y l√† ƒëi·ªÉm m·∫°nh so v·ªõi Promises thu·∫ßn.

	## V√≠ d·ª•: Fetch Data v·ªõi Error Handling


async function fetchUserData() {
  try {
    const response = await fetch('https://api.example.com/users/1');
    if (!response.ok) {
      throw new Error(`HTTP error: ${response.status}`);
    }
    const user = await response.json();
    console.log('User data:', user);
    return user;
  } catch (error) {
    console.error('Error fetching user data:', error);
    throw error; // Re-throw n·∫øu c·∫ßn propagate l·ªói l√™n tr√™n
  }
}

// G·ªçi v√† catch ngo√†i
fetchUserData().catch(error => {
  console.log('Caught outside:', error.message);
});



	- try { ... }: Ch·ª©a code c√≥ th·ªÉ throw l·ªói (nh∆∞ fetch fail ho·∫∑c JSON parse error).
	- throw new Error(): T·∫°o l·ªói t√πy ch·ªânh n·∫øu response kh√¥ng OK (v√≠ d·ª•: 404).
	- catch (error) { ... }: B·∫Øt m·ªçi l·ªói t·ª´ await (Promise reject).
	- K·∫øt h·ª£p v·ªõi .catch(): B·∫°n c√≥ th·ªÉ catch ngo√†i h√†m async n·∫øu c·∫ßn x·ª≠ l√Ω l·ªói ·ªü level cao h∆°n.

	Insight: Trong production, lu√¥n log l·ªói chi ti·∫øt (s·ª≠ d·ª•ng Winston ho·∫∑c Pino logger) v√† tr√°nh l·ªô th√¥ng tin nh·∫°y c·∫£m cho client. Async/await l√†m error handling d·ªÖ h∆°n, nh∆∞ng nh·ªõ r·∫±ng n·∫øu kh√¥ng catch, l·ªói s·∫Ω propagate l√™n event loop v√† crash app n·∫øu kh√¥ng handle uncaughtException.




# Ch·∫°y Promises Song Song (Parallel)

	Async/await m·∫∑c ƒë·ªãnh ch·∫°y sequential (tu·∫ßn t·ª±), nh∆∞ng b·∫°n c√≥ th·ªÉ d√πng Promise.all() ƒë·ªÉ parallelize, c·∫£i thi·ªán performance.

	## V√≠ d·ª•: Sequential vs Parallel

function fetchData(id) {
  return new Promise(resolve => {
    setTimeout(() => resolve(`Data for ID ${id}`), 1000);
  });
}

// Sequential: ~3 gi√¢y
async function fetchSequential() {
  console.time('sequential');
  const data1 = await fetchData(1);
  const data2 = await fetchData(2);
  const data3 = await fetchData(3);
  console.timeEnd('sequential');
  return [data1, data2, data3];
}

// Parallel: ~1 gi√¢y
async function fetchParallel() {
  console.time('parallel');
  const results = await Promise.all([
    fetchData(1),
    fetchData(2),
    fetchData(3)
  ]);
  console.timeEnd('parallel');
  return results;
}

async function runDemo() {
  console.log('Sequential:');
  await fetchSequential();
  console.log('Parallel:');
  await fetchParallel();
}

runDemo();



	- Sequential: Await t·ª´ng c√°i m·ªôt, t·ªïng th·ªùi gian l√† t·ªïng c√°c delay (3s).
	
	- Parallel: Promise.all() ch·∫°y t·∫•t c·∫£ c√πng l√∫c, await k·∫øt qu·∫£ khi t·∫•t c·∫£ ho√†n t·∫•t. N·∫øu m·ªôt Promise reject, to√†n b·ªô all() reject.
	
	- Insight: Trong API real-world, d√πng parallel cho c√°c fetch ƒë·ªôc l·∫≠p (nh∆∞ load user + posts + comments). Nh∆∞ng n·∫øu c√≥ ph·ª• thu·ªôc (dependency), ph·∫£i sequential. ƒê·ªÉ handle l·ªói partial, d√πng Promise.allSettled() (t·ª´ ES2020).




# So S√°nh Async/Await vs Promises vs Callbacks

Pattern,Pros,Cons
Callbacks,"- ƒê∆°n gi·∫£n, h·ªó tr·ª£ r·ªông r√£i
- Kh√¥ng c·∫ßn hi·ªÉu Promise","- Callback hell (l·ªìng gh√©p s√¢u)
- X·ª≠ l√Ω l·ªói ph·ª©c t·∫°p (check error param)
- Kh√≥ debug"
Promises,"- Chain .then() d·ªÖ d√†ng
- X·ª≠ l√Ω l·ªói t·ªët h∆°n (.catch())
- Composable (k·∫øt h·ª£p nhi·ªÅu Promise)","- V·∫´n c·∫ßn nesting cho flow ph·ª©c t·∫°p
- √çt readable h∆°n async/await"
Async/Await,"- Code s·∫°ch, gi·ªëng synchronous
- Try/catch d·ªÖ d√πng
- Debug d·ªÖ (stack trace r√µ r√†ng)","- Ph·∫£i hi·ªÉu Promise tr∆∞·ªõc
- D·ªÖ nh·∫ßm l·∫´n block execution (th·ª±c t·∫ø kh√¥ng)"


	Callbacks: L·ªìng gh√©p, d·ªÖ "pyramid of doom".
	Promises: Chain .then(), nh∆∞ng v·∫´n h∆°i verbose.
	Async/Await: S·∫°ch s·∫Ω nh·∫•t, l√Ω t∆∞·ªüng cho code ph·ª©c t·∫°p.
	
	
	Insight: Trong d·ª± √°n l·ªõn, async/await l√† standard. N·∫øu d√πng callback legacy (nh∆∞ c≈© fs.readFile), convert sang Promise b·∫±ng util.promisify. Tr√°nh mix styles trong c√πng module ƒë·ªÉ code consistent.	
	
# 	Best Practices (Th·ª±c H√†nh T·ªët Nh·∫•t)
	
	D·ª±a tr√™n b√†i h·ªçc v√† kinh nghi·ªám:
	
		1. Async lu√¥n tr·∫£ Promise: Nh·ªõ await ho·∫∑c .then() khi g·ªçi. V√≠ d·ª•: async function() { return 'Hi'; } tr·∫£ Promise<'Hi'>, kh√¥ng ph·∫£i string. 
		
		2. S·ª≠ d·ª•ng Promise.all cho parallel: Tr√°nh sequential kh√¥ng c·∫ßn thi·∫øt ƒë·ªÉ optimize speed.
	
		3. Lu√¥n handle l·ªói: Try/catch ho·∫∑c .catch(). Unhandled rejection c√≥ th·ªÉ crash app (Node.js warn t·ª´ v15).
	
		4. Tr√°nh mix callback v·ªõi async: Convert callback functions sang Promise. V√≠ d·ª• v·ªõi fs:
		
			const util = require('util');
			const fs = require('fs');
			const readFile = util.promisify(fs.readFile);
			async function read() {
			const data = await readFile('file.txt', 'utf8');
			}	
			
		5. Gi·ªØ h√†m async focused: M·ªói h√†m async l√†m m·ªôt vi·ªác (Single Responsibility Principle).
		
		6.Top-level await (Node.js >=14.8): Trong ESM (.mjs), b·∫°n c√≥ th·ªÉ await ngo√†i h√†m async, v√≠ d·ª• import dynamic.

		Insight th√™m: Trong performance-critical app, theo d√µi async context v·ªõi Async Hooks (perf_hooks). Tr√°nh await trong loop l·ªõn (d√πng Promise.all v·ªõi map). Test async code v·ªõi Jest/Mocha, d√πng await trong test cases.



</pre><a id='backBottom' href='../NodeJS-learning.html' style='display:none;'>üîô Quay l·∫°i danh s√°ch</a><br><button onclick='toggleTheme()'>üåô Chuy·ªÉn giao di·ªán</button></div><script>function toggleTheme() {   let mode = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';   document.body.className = mode; localStorage.setItem('theme', mode);   syncTheme();}function applyTheme() {   let savedTheme = localStorage.getItem('theme') || 'dark-mode';   document.body.className = savedTheme;   syncTheme();}function syncTheme() {   let preElement = document.querySelector('pre');   if (document.body.classList.contains('dark-mode')) { preElement.style.background = '#1e1e1e'; preElement.style.color = '#e0e0e0'; }   else { preElement.style.background = '#f5f5f5'; preElement.style.color = '#333333'; }}function checkPageHeight() {   let contentHeight = document.body.scrollHeight;   let windowHeight = window.innerHeight;   if (contentHeight > windowHeight * 1.2) {       document.getElementById('backBottom').style.display = 'block';   } else {       document.getElementById('backBottom').style.display = 'none';   }}</script></body></html>